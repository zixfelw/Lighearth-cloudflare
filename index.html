<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"
        id="viewport-meta">
    <title>LumenTree Dashboard</title>

    <!-- Auto zoom out to 80% on mobile devices -->
    <script>
        (function () {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                || window.innerWidth <= 768;
            if (isMobile) {
                const viewport = document.getElementById('viewport-meta');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=0.8, maximum-scale=5.0, user-scalable=yes');
                }
            }
        })();
    </script>

    <!-- Sync dark mode class with system preference -->
    <script>
        (function () {
            // Check system dark mode preference and add/remove .dark class
            function syncDarkMode() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
            // Initial sync
            syncDarkMode();
            // Listen for changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', syncDarkMode);
        })();
    </script>

    <!-- Preload critical resources -->
    <link rel="preload" href="css/index.css" as="style" crossorigin>
    <link rel="preload" href="logo.png" as="image">

    <!-- Tailwind CSS with custom config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Favicons - Served from Cloudflare Pages to reduce Railway egress -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <!-- PWA manifest disabled - use "Add to Home Screen" shortcut instead -->
    <!-- <link rel="manifest" href="/manifest.json"> -->

    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        .gradient-brand {
            background: linear-gradient(135deg, #06b6d4 0%, #8b5cf6 50%, #ec4899 100%);
        }

        .gradient-dark {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
        }

        /* Background Gradient Blobs - Dark Mode Only */
        .bg-blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0;
            pointer-events: none;
            z-index: 0;
            will-change: transform, opacity;
            transform: translateZ(0);
            /* Force GPU layer */
            backface-visibility: hidden;
            /* Optimize compositing */
            -webkit-backface-visibility: hidden;
        }

        .dark .bg-blob {
            opacity: 0.8;
        }

        /* Organic floating animations - each blob moves differently */
        @keyframes blob-drift-1 {
            0% {
                transform: translate(0, 0) scale(1);
            }

            15% {
                transform: translate(80px, -50px) scale(1.05);
            }

            30% {
                transform: translate(150px, 30px) scale(0.95);
            }

            45% {
                transform: translate(100px, 100px) scale(1.02);
            }

            60% {
                transform: translate(-50px, 80px) scale(0.98);
            }

            75% {
                transform: translate(-100px, -30px) scale(1.03);
            }

            90% {
                transform: translate(-60px, -80px) scale(0.97);
            }

            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        @keyframes blob-drift-2 {
            0% {
                transform: translate(0, 0) scale(1);
            }

            20% {
                transform: translate(-100px, 60px) scale(0.95);
            }

            40% {
                transform: translate(-150px, -40px) scale(1.05);
            }

            60% {
                transform: translate(-30px, -120px) scale(0.98);
            }

            80% {
                transform: translate(80px, -60px) scale(1.02);
            }

            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        @keyframes blob-drift-3 {
            0% {
                transform: translate(0, 0) scale(1);
            }

            25% {
                transform: translate(60px, 80px) scale(1.03);
            }

            50% {
                transform: translate(-80px, 100px) scale(0.97);
            }

            75% {
                transform: translate(-120px, -50px) scale(1.02);
            }

            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        .bg-blob-purple {
            background: radial-gradient(circle, rgba(139, 92, 246, 0.5) 0%, rgba(139, 92, 246, 0) 70%);
            width: 600px;
            height: 600px;
            top: -200px;
            left: -200px;
            animation: blob-drift-1 30s ease-in-out infinite;
        }

        .bg-blob-teal {
            background: radial-gradient(circle, rgba(20, 184, 166, 0.45) 0%, rgba(20, 184, 166, 0) 70%);
            width: 550px;
            height: 550px;
            bottom: -150px;
            right: -150px;
            animation: blob-drift-2 35s ease-in-out infinite;
        }

        .bg-blob-indigo {
            background: radial-gradient(circle, rgba(99, 102, 241, 0.35) 0%, rgba(99, 102, 241, 0) 70%);
            width: 500px;
            height: 500px;
            top: 30%;
            right: -80px;
            animation: blob-drift-3 28s ease-in-out infinite;
        }

        /* Additional 3 blobs */
        @keyframes blob-drift-4 {
            0% {
                transform: translate(0, 0) scale(1);
            }

            20% {
                transform: translate(-80px, -100px) scale(1.04);
            }

            40% {
                transform: translate(50px, -60px) scale(0.96);
            }

            60% {
                transform: translate(100px, 50px) scale(1.02);
            }

            80% {
                transform: translate(-40px, 80px) scale(0.98);
            }

            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        @keyframes blob-drift-5 {
            0% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(120px, -80px) scale(0.97);
            }

            66% {
                transform: translate(-60px, 100px) scale(1.03);
            }

            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        @keyframes blob-drift-6 {
            0% {
                transform: translate(0, 0) scale(1);
            }

            25% {
                transform: translate(-100px, 60px) scale(1.05);
            }

            50% {
                transform: translate(80px, 120px) scale(0.95);
            }

            75% {
                transform: translate(60px, -80px) scale(1.02);
            }

            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        .bg-blob-pink {
            background: radial-gradient(circle, rgba(236, 72, 153, 0.4) 0%, rgba(236, 72, 153, 0) 70%);
            width: 450px;
            height: 450px;
            top: 60%;
            left: -100px;
            animation: blob-drift-4 32s ease-in-out infinite;
        }

        .bg-blob-cyan {
            background: radial-gradient(circle, rgba(6, 182, 212, 0.35) 0%, rgba(6, 182, 212, 0) 70%);
            width: 400px;
            height: 400px;
            top: 10%;
            right: 20%;
            animation: blob-drift-5 26s ease-in-out infinite;
        }

        .bg-blob-amber {
            background: radial-gradient(circle, rgba(245, 158, 11, 0.3) 0%, rgba(245, 158, 11, 0) 70%);
            width: 380px;
            height: 380px;
            bottom: 20%;
            left: 30%;
            animation: blob-drift-6 33s ease-in-out infinite;
        }

        /* Mobile: Optimize performance - only 3 blobs, smaller, less blur */
        @media (max-width: 768px) {
            .bg-blob {
                filter: blur(40px);
                /* Reduced blur for better performance */
                animation-duration: 40s !important;
                /* Slower = less CPU */
            }

            /* Keep only 3 blobs on mobile for performance */
            .bg-blob-pink,
            .bg-blob-cyan,
            .bg-blob-amber {
                display: none !important;
            }

            .bg-blob-purple {
                width: 250px;
                height: 250px;
                top: -60px;
                left: -60px;
            }

            .bg-blob-teal {
                width: 230px;
                height: 230px;
                bottom: -50px;
                right: -50px;
            }

            .bg-blob-indigo {
                width: 200px;
                height: 200px;
                top: 50%;
                right: -40px;
            }
        }

        /* Respect reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            .bg-blob {
                animation: none !important;
            }
        }

        .shadow-brand {
            box-shadow: 0 4px 14px 0 rgba(139, 92, 246, 0.4);
        }

        /* Glow animation for values */
        @keyframes glow {

            0%,
            100% {
                text-shadow: 0 0 5px rgba(16, 185, 129, 0.5), 0 0 10px rgba(16, 185, 129, 0.3);
            }

            50% {
                text-shadow: 0 0 15px rgba(16, 185, 129, 0.8), 0 0 25px rgba(16, 185, 129, 0.5), 0 0 35px rgba(16, 185, 129, 0.3);
            }
        }

        .animate-glow {
            animation: glow 4s ease-in-out infinite;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }

        ::-webkit-scrollbar-thumb {
            background: #8b5cf6;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #7c3aed;
        }

        /* Connection status indicator */
        .status-connected {
            background-color: #10b981;
            animation: pulse-green 2s infinite;
        }

        .status-disconnected {
            background-color: #ef4444;
        }

        .status-connecting {
            background-color: #8b5cf6;
            animation: pulse-yellow 1s infinite;
        }

        @keyframes pulse-green {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes pulse-yellow {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        /* Sun Animation Styles */
        .sun-animated {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            animation: sun-pulse 3s ease-in-out infinite, sun-rotate 20s linear infinite;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .sun-icon {
            width: 28px;
            height: 28px;
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.8));
        }

        @media (min-width: 640px) {
            .sun-icon {
                width: 36px;
                height: 36px;
            }

            .sun-animated {
                top: -12px;
            }
        }

        @keyframes sun-pulse {

            0%,
            100% {
                filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.8));
                transform: translateX(-50%) scale(1);
            }

            50% {
                filter: drop-shadow(0 0 16px rgba(251, 191, 36, 1));
                transform: translateX(-50%) scale(1.1);
            }
        }

        @keyframes sun-rotate {
            0% {
                transform: translateX(-50%) rotate(0deg);
            }

            100% {
                transform: translateX(-50%) rotate(360deg);
            }
        }

        .solar-panel-img img {
            position: relative;
            z-index: 5;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Modal styles removed - calculator now uses direct navigation */

        /* Telegram Checkbox Styles - Enhanced for Dark Mode */
        .tg-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 22px !important;
            height: 22px !important;
            min-width: 22px;
            border: 2px solid #9ca3af;
            border-radius: 6px;
            background-color: #ffffff;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .dark .tg-checkbox {
            background-color: #374151;
            border-color: #6b7280;
        }

        .tg-checkbox:checked {
            background-color: #10b981;
            border-color: #10b981;
        }

        .dark .tg-checkbox:checked {
            background-color: #10b981;
            border-color: #10b981;
        }

        .tg-checkbox:checked::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 7px;
            width: 6px;
            height: 11px;
            border: solid white;
            border-width: 0 2.5px 2.5px 0;
            transform: rotate(45deg);
        }

        .tg-checkbox:not(:checked) {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }

        .dark .tg-checkbox:not(:checked) {
            background-color: #1f2937;
            border-color: #4b5563;
        }

        .tg-checkbox:hover {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .tg-checkbox-label:has(.tg-checkbox:checked) {
            background-color: rgba(16, 185, 129, 0.1);
        }

        .dark .tg-checkbox-label:has(.tg-checkbox:checked) {
            background-color: rgba(16, 185, 129, 0.15);
        }

        /* Telegram Success Modal */
        .tg-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .tg-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .tg-modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 20px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .tg-modal-overlay.active .tg-modal-content {
            transform: scale(1);
        }

        /* Header scroll hide/show */
        #mainHeader.header-hidden {
            transform: translateY(-100%);
        }

        /* Zoom handled via viewport meta tag for mobile (initial-scale=0.8) */
        /* PC stays at 100% for proper chart mouse coordinates */

        /* ========================================
           3D Home View - Sun/Moon Animations
           ======================================== */

        /* Sun Container - New Realistic Style v·ªõi Corona */
        .sun-3d-container {
            position: relative;
            width: 80px;
            height: 80px;
            transition: all 0.5s ease;
        }

        /* Core - L√µi m·∫∑t tr·ªùi v·ªõi texture */
        .sun-3d-core {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 36px;
            height: 36px;
            background:
                radial-gradient(circle at 30% 30%, #fff5e6 0%, transparent 25%),
                radial-gradient(circle at 70% 60%, #ffe4b3 0%, transparent 20%),
                linear-gradient(135deg, #fbbf24 0%, #f59e0b 40%, #ea580c 80%, #dc2626 100%);
            border-radius: 50%;
            box-shadow:
                inset 0 0 15px rgba(255, 255, 255, 0.3),
                0 0 20px rgba(251, 191, 36, 0.8),
                0 0 40px rgba(245, 158, 11, 0.5);
            animation: sun-3d-pulse 2s ease-in-out infinite;
            transition: all 0.5s ease;
        }

        /* Parent container overflow visible */
        #sun-3d {
            overflow: visible !important;
        }

        /* Rays - 8 tia s√°ng th·∫≥ng */
        .sun-3d-rays {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            background:
                conic-gradient(from 0deg,
                    transparent 0deg, rgba(251, 191, 36, 0.6) 3deg, transparent 6deg,
                    transparent 45deg, rgba(251, 191, 36, 0.6) 48deg, transparent 51deg,
                    transparent 90deg, rgba(251, 191, 36, 0.6) 93deg, transparent 96deg,
                    transparent 135deg, rgba(251, 191, 36, 0.6) 138deg, transparent 141deg,
                    transparent 180deg, rgba(251, 191, 36, 0.6) 183deg, transparent 186deg,
                    transparent 225deg, rgba(251, 191, 36, 0.6) 228deg, transparent 231deg,
                    transparent 270deg, rgba(251, 191, 36, 0.6) 273deg, transparent 276deg,
                    transparent 315deg, rgba(251, 191, 36, 0.6) 318deg, transparent 321deg);
            border-radius: 50%;
            animation: sun-3d-rotate 30s linear infinite;
            transition: all 0.5s ease;
        }

        /* Corona - V·∫ßng h√†o quang b√™n ngo√†i */
        .sun-3d-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 65px;
            height: 65px;
            background: radial-gradient(circle,
                    rgba(251, 191, 36, 0.3) 0%,
                    rgba(245, 158, 11, 0.2) 40%,
                    transparent 70%);
            border-radius: 50%;
            animation: sun-3d-glow 3s ease-in-out infinite;
            transition: all 0.5s ease;
        }

        /* Level 1: 0-1000W - M·∫∑t tr·ªùi m·ªù, bu·ªïi s√°ng s·ªõm */
        .sun-3d-container.sun-level-1 .sun-3d-core {
            width: 28px !important;
            height: 28px !important;
            animation: sun-3d-pulse-slow 4s ease-in-out infinite !important;
            background:
                radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.2) 0%, transparent 30%),
                linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%) !important;
            box-shadow:
                inset 0 0 8px rgba(255, 255, 255, 0.2),
                0 0 12px rgba(251, 191, 36, 0.4),
                0 0 25px rgba(245, 158, 11, 0.2) !important;
        }

        .sun-3d-container.sun-level-1 .sun-3d-rays {
            animation: sun-3d-rotate 45s linear infinite !important;
            opacity: 0.25 !important;
            width: 50px !important;
            height: 50px !important;
        }

        .sun-3d-container.sun-level-1 .sun-3d-glow {
            animation: sun-3d-glow-slow 5s ease-in-out infinite !important;
            width: 45px !important;
            height: 45px !important;
            opacity: 0.35 !important;
        }

        /* Level 2: 1000-2000W - M·∫∑t tr·ªùi b√¨nh th∆∞·ªùng */
        .sun-3d-container.sun-level-2 .sun-3d-core {
            width: 34px !important;
            height: 34px !important;
            animation: sun-3d-pulse 3s ease-in-out infinite !important;
            background:
                radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.25) 0%, transparent 25%),
                linear-gradient(135deg, #fbbf24 0%, #f59e0b 60%, #ea580c 100%) !important;
            box-shadow:
                inset 0 0 10px rgba(255, 255, 255, 0.25),
                0 0 18px rgba(251, 191, 36, 0.6),
                0 0 35px rgba(245, 158, 11, 0.35) !important;
        }

        .sun-3d-container.sun-level-2 .sun-3d-rays {
            animation: sun-3d-rotate 25s linear infinite !important;
            opacity: 0.4 !important;
            width: 65px !important;
            height: 65px !important;
        }

        .sun-3d-container.sun-level-2 .sun-3d-glow {
            animation: sun-3d-glow 3.5s ease-in-out infinite !important;
            width: 60px !important;
            height: 60px !important;
        }

        /* Level 3: 2000-4000W - M·∫∑t tr·ªùi r·ª±c r·ª° v·ªõi corona (chuy·ªÉn t·ª´ Level 4 c≈©) */
        .sun-3d-container.sun-level-3 .sun-3d-core {
            width: 46px !important;
            height: 46px !important;
            animation: sun-3d-pulse-fast 1.2s ease-in-out infinite !important;
            background:
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.6) 0%, transparent 25%),
                radial-gradient(circle at 75% 55%, rgba(255, 240, 220, 0.5) 0%, transparent 20%),
                radial-gradient(circle at 50% 80%, rgba(255, 200, 150, 0.3) 0%, transparent 25%),
                linear-gradient(135deg, #fef08a 0%, #fcd34d 25%, #fbbf24 50%, #f59e0b 75%, #ea580c 100%) !important;
            box-shadow:
                inset 0 0 15px rgba(255, 255, 255, 0.5),
                0 0 30px rgba(254, 240, 138, 0.9),
                0 0 60px rgba(251, 191, 36, 0.7),
                0 0 90px rgba(245, 158, 11, 0.5),
                0 0 120px rgba(234, 88, 12, 0.3) !important;
        }

        .sun-3d-container.sun-level-3 .sun-3d-rays {
            animation: sun-3d-rotate-fast 8s linear infinite !important;
            opacity: 0.85 !important;
            width: 100px !important;
            height: 100px !important;
            background:
                conic-gradient(from 0deg,
                    transparent 0deg, rgba(254, 240, 138, 0.7) 4deg, transparent 8deg,
                    transparent 45deg, rgba(251, 191, 36, 0.7) 49deg, transparent 53deg,
                    transparent 90deg, rgba(254, 240, 138, 0.7) 94deg, transparent 98deg,
                    transparent 135deg, rgba(251, 191, 36, 0.7) 139deg, transparent 143deg,
                    transparent 180deg, rgba(254, 240, 138, 0.7) 184deg, transparent 188deg,
                    transparent 225deg, rgba(251, 191, 36, 0.7) 229deg, transparent 233deg,
                    transparent 270deg, rgba(254, 240, 138, 0.7) 274deg, transparent 278deg,
                    transparent 315deg, rgba(251, 191, 36, 0.7) 319deg, transparent 323deg) !important;
        }

        .sun-3d-container.sun-level-3 .sun-3d-glow {
            animation: sun-3d-glow-ultra 1.5s ease-in-out infinite !important;
            width: 95px !important;
            height: 95px !important;
            background: radial-gradient(circle,
                    rgba(254, 240, 138, 0.5) 0%,
                    rgba(251, 191, 36, 0.35) 30%,
                    rgba(245, 158, 11, 0.2) 50%,
                    transparent 70%) !important;
        }

        /* Corona cho level 3 */
        .sun-3d-container.sun-level-3::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            background: radial-gradient(circle,
                    transparent 30%,
                    rgba(254, 240, 138, 0.2) 35%,
                    rgba(251, 191, 36, 0.15) 45%,
                    transparent 55%);
            border-radius: 50%;
            animation: sun-3d-corona 2s ease-in-out infinite;
        }

        /* Level 4: 4000W+ - üî• ULTRA VIP PRO - M·∫∑t tr·ªùi SI√äU M·∫†NH v·ªõi tia s√°ng b√™n trong */
        .sun-3d-container.sun-level-4 .sun-3d-core {
            width: 52px !important;
            height: 52px !important;
            animation: sun-3d-pulse-ultra 0.8s ease-in-out infinite !important;
            background:
                /* Tia s√°ng xoay b√™n trong core */
                conic-gradient(from 0deg at 50% 50%,
                    rgba(255, 255, 255, 0.9) 0deg, transparent 15deg,
                    rgba(255, 255, 255, 0.7) 45deg, transparent 60deg,
                    rgba(255, 255, 255, 0.9) 90deg, transparent 105deg,
                    rgba(255, 255, 255, 0.7) 135deg, transparent 150deg,
                    rgba(255, 255, 255, 0.9) 180deg, transparent 195deg,
                    rgba(255, 255, 255, 0.7) 225deg, transparent 240deg,
                    rgba(255, 255, 255, 0.9) 270deg, transparent 285deg,
                    rgba(255, 255, 255, 0.7) 315deg, transparent 330deg),
                /* ƒêi·ªÉm s√°ng highlight */
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.8) 0%, transparent 20%),
                radial-gradient(circle at 70% 35%, rgba(255, 255, 255, 0.6) 0%, transparent 15%),
                radial-gradient(circle at 35% 70%, rgba(255, 255, 255, 0.5) 0%, transparent 18%),
                /* Gradient ch√≠nh */
                radial-gradient(circle, #fff7ed 0%, #fef08a 20%, #fcd34d 40%, #fbbf24 60%, #f59e0b 80%, #ea580c 100%) !important;
            box-shadow:
                inset 0 0 20px rgba(255, 255, 255, 0.7),
                0 0 35px rgba(255, 255, 255, 0.8),
                0 0 50px rgba(254, 240, 138, 1),
                0 0 80px rgba(251, 191, 36, 0.8),
                0 0 110px rgba(245, 158, 11, 0.6),
                0 0 140px rgba(234, 88, 12, 0.4) !important;
        }

        .sun-3d-container.sun-level-4 .sun-3d-rays {
            animation: sun-3d-rotate-ultra 5s linear infinite !important;
            opacity: 1 !important;
            width: 120px !important;
            height: 120px !important;
            background:
                /* 16 tia s√°ng m·∫°nh */
                conic-gradient(from 0deg,
                    transparent 0deg, rgba(255, 255, 255, 0.9) 2deg, rgba(254, 240, 138, 0.8) 5deg, transparent 8deg,
                    transparent 22.5deg, rgba(251, 191, 36, 0.7) 24.5deg, transparent 27deg,
                    transparent 45deg, rgba(255, 255, 255, 0.9) 47deg, rgba(254, 240, 138, 0.8) 50deg, transparent 53deg,
                    transparent 67.5deg, rgba(251, 191, 36, 0.7) 69.5deg, transparent 72deg,
                    transparent 90deg, rgba(255, 255, 255, 0.9) 92deg, rgba(254, 240, 138, 0.8) 95deg, transparent 98deg,
                    transparent 112.5deg, rgba(251, 191, 36, 0.7) 114.5deg, transparent 117deg,
                    transparent 135deg, rgba(255, 255, 255, 0.9) 137deg, rgba(254, 240, 138, 0.8) 140deg, transparent 143deg,
                    transparent 157.5deg, rgba(251, 191, 36, 0.7) 159.5deg, transparent 162deg,
                    transparent 180deg, rgba(255, 255, 255, 0.9) 182deg, rgba(254, 240, 138, 0.8) 185deg, transparent 188deg,
                    transparent 202.5deg, rgba(251, 191, 36, 0.7) 204.5deg, transparent 207deg,
                    transparent 225deg, rgba(255, 255, 255, 0.9) 227deg, rgba(254, 240, 138, 0.8) 230deg, transparent 233deg,
                    transparent 247.5deg, rgba(251, 191, 36, 0.7) 249.5deg, transparent 252deg,
                    transparent 270deg, rgba(255, 255, 255, 0.9) 272deg, rgba(254, 240, 138, 0.8) 275deg, transparent 278deg,
                    transparent 292.5deg, rgba(251, 191, 36, 0.7) 294.5deg, transparent 297deg,
                    transparent 315deg, rgba(255, 255, 255, 0.9) 317deg, rgba(254, 240, 138, 0.8) 320deg, transparent 323deg,
                    transparent 337.5deg, rgba(251, 191, 36, 0.7) 339.5deg, transparent 342deg) !important;
        }

        .sun-3d-container.sun-level-4 .sun-3d-glow {
            animation: sun-3d-glow-ultra 1s ease-in-out infinite !important;
            width: 110px !important;
            height: 110px !important;
            background: radial-gradient(circle,
                    rgba(255, 255, 255, 0.6) 0%,
                    rgba(254, 240, 138, 0.5) 20%,
                    rgba(251, 191, 36, 0.4) 40%,
                    rgba(245, 158, 11, 0.25) 60%,
                    transparent 75%) !important;
        }

        /* V√≤ng corona trong - pulse m·∫°nh */
        .sun-3d-container.sun-level-4::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            background: radial-gradient(circle,
                    transparent 25%,
                    rgba(255, 255, 255, 0.25) 30%,
                    rgba(254, 240, 138, 0.2) 40%,
                    rgba(251, 191, 36, 0.15) 50%,
                    transparent 60%);
            border-radius: 50%;
            animation: sun-3d-corona-ultra 1.5s ease-in-out infinite;
        }

        /* V√≤ng corona ngo√†i - 16 tia xoay ng∆∞·ª£c */
        .sun-3d-container.sun-level-4::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 160px;
            background:
                conic-gradient(from 11.25deg,
                    transparent 0deg, rgba(255, 255, 255, 0.3) 3deg, rgba(251, 191, 36, 0.2) 6deg, transparent 9deg,
                    transparent 22.5deg, rgba(254, 240, 138, 0.25) 25.5deg, transparent 28.5deg,
                    transparent 45deg, rgba(255, 255, 255, 0.3) 48deg, rgba(251, 191, 36, 0.2) 51deg, transparent 54deg,
                    transparent 67.5deg, rgba(254, 240, 138, 0.25) 70.5deg, transparent 73.5deg,
                    transparent 90deg, rgba(255, 255, 255, 0.3) 93deg, rgba(251, 191, 36, 0.2) 96deg, transparent 99deg,
                    transparent 112.5deg, rgba(254, 240, 138, 0.25) 115.5deg, transparent 118.5deg,
                    transparent 135deg, rgba(255, 255, 255, 0.3) 138deg, rgba(251, 191, 36, 0.2) 141deg, transparent 144deg,
                    transparent 157.5deg, rgba(254, 240, 138, 0.25) 160.5deg, transparent 163.5deg,
                    transparent 180deg, rgba(255, 255, 255, 0.3) 183deg, rgba(251, 191, 36, 0.2) 186deg, transparent 189deg,
                    transparent 202.5deg, rgba(254, 240, 138, 0.25) 205.5deg, transparent 208.5deg,
                    transparent 225deg, rgba(255, 255, 255, 0.3) 228deg, rgba(251, 191, 36, 0.2) 231deg, transparent 234deg,
                    transparent 247.5deg, rgba(254, 240, 138, 0.25) 250.5deg, transparent 253.5deg,
                    transparent 270deg, rgba(255, 255, 255, 0.3) 273deg, rgba(251, 191, 36, 0.2) 276deg, transparent 279deg,
                    transparent 292.5deg, rgba(254, 240, 138, 0.25) 295.5deg, transparent 298.5deg,
                    transparent 315deg, rgba(255, 255, 255, 0.3) 318deg, rgba(251, 191, 36, 0.2) 321deg, transparent 324deg,
                    transparent 337.5deg, rgba(254, 240, 138, 0.25) 340.5deg, transparent 343.5deg);
            border-radius: 50%;
            animation: sun-3d-rotate-reverse 10s linear infinite;
        }

        @keyframes sun-3d-pulse {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        @keyframes sun-3d-pulse-slow {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.05);
            }
        }

        @keyframes sun-3d-pulse-fast {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.15);
            }
        }

        @keyframes sun-3d-rotate {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        @keyframes sun-3d-rotate-fast {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        @keyframes sun-3d-rotate-reverse {
            from {
                transform: translate(-50%, -50%) rotate(360deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(0deg);
            }
        }

        @keyframes sun-3d-glow {

            0%,
            100% {
                opacity: 0.5;
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        @keyframes sun-3d-glow-slow {

            0%,
            100% {
                opacity: 0.4;
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                opacity: 0.7;
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        @keyframes sun-3d-glow-intense {

            0%,
            100% {
                opacity: 0.7;
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.15);
            }
        }

        @keyframes sun-3d-pulse-ultra {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
            }

            25% {
                transform: translate(-50%, -50%) scale(1.08) rotate(5deg);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.15) rotate(0deg);
            }

            75% {
                transform: translate(-50%, -50%) scale(1.08) rotate(-5deg);
            }
        }

        @keyframes sun-3d-rotate-ultra {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        @keyframes sun-3d-corona-ultra {

            0%,
            100% {
                opacity: 0.6;
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        @keyframes sun-3d-glow-ultra {

            0%,
            100% {
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        @keyframes sun-3d-corona {

            0%,
            100% {
                opacity: 0.5;
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                opacity: 0.9;
                transform: translate(-50%, -50%) scale(1.15);
            }
        }

        /* Moon Container */
        .moon-3d-container {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .moon-3d-core {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 50%, #94a3b8 100%);
            border-radius: 50%;
            box-shadow:
                0 0 15px rgba(226, 232, 240, 0.6),
                0 0 30px rgba(226, 232, 240, 0.3),
                inset -8px -5px 15px rgba(100, 116, 139, 0.4);
            animation: moon-3d-float 4s ease-in-out infinite;
        }

        .moon-3d-crater {
            position: absolute;
            background: rgba(100, 116, 139, 0.3);
            border-radius: 50%;
        }

        .moon-3d-crater-1 {
            width: 10px;
            height: 10px;
            top: 35%;
            left: 30%;
        }

        .moon-3d-crater-2 {
            width: 7px;
            height: 7px;
            top: 55%;
            left: 55%;
        }

        .moon-3d-crater-3 {
            width: 5px;
            height: 5px;
            top: 25%;
            left: 60%;
        }

        .moon-3d-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            background: radial-gradient(circle, rgba(226, 232, 240, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            animation: moon-3d-glow 4s ease-in-out infinite;
        }

        @keyframes moon-3d-float {

            0%,
            100% {
                transform: translate(-50%, -50%) translateY(0);
            }

            50% {
                transform: translate(-50%, -50%) translateY(-5px);
            }
        }

        @keyframes moon-3d-glow {

            0%,
            100% {
                opacity: 0.3;
            }

            50% {
                opacity: 0.6;
            }
        }

        /* Stars around moon */
        .stars-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: star-twinkle 2s ease-in-out infinite;
        }

        .star-1 {
            width: 3px;
            height: 3px;
            top: 5%;
            left: 10%;
            animation-delay: 0s;
        }

        .star-2 {
            width: 2px;
            height: 2px;
            top: 15%;
            left: 85%;
            animation-delay: 0.5s;
        }

        .star-3 {
            width: 3px;
            height: 3px;
            top: 80%;
            left: 20%;
            animation-delay: 1s;
        }

        .star-4 {
            width: 2px;
            height: 2px;
            top: 70%;
            left: 90%;
            animation-delay: 1.5s;
        }

        .star-5 {
            width: 2px;
            height: 2px;
            top: 90%;
            left: 60%;
            animation-delay: 0.3s;
        }

        @keyframes star-twinkle {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.5);
            }
        }

        /* ========================================
           PV Energy Flow Line - Ngu·ªìn PV ‚Üí Solar Panel
           Soft, gentle animation
           ======================================== */

        /* Container for the energy flow line */
        .pv-energy-line {
            position: absolute;
            width: 2px;
            background: linear-gradient(to bottom,
                    rgba(251, 191, 36, 0.8) 0%,
                    rgba(245, 158, 11, 0.6) 50%,
                    rgba(217, 119, 6, 0.4) 100%);
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.5),
                0 0 16px rgba(251, 191, 36, 0.3);
        }

        /* Energy flow particles - gentle animation */
        .energy-particle {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, #fef3c7 0%, #fbbf24 50%, #f59e0b 100%);
            border-radius: 50%;
            box-shadow: 0 0 6px #fbbf24, 0 0 12px rgba(251, 191, 36, 0.6);
            animation: energyFlowDown 2.5s ease-in-out infinite;
            opacity: 0;
        }

        .energy-particle:nth-child(2) {
            animation-delay: 0.8s;
            width: 5px;
            height: 5px;
        }

        .energy-particle:nth-child(3) {
            animation-delay: 1.6s;
            width: 4px;
            height: 4px;
        }

        @keyframes energyFlowDown {
            0% {
                top: 0%;
                opacity: 0;
                transform: translateX(-50%) scale(0.8);
            }

            10% {
                opacity: 0.9;
                transform: translateX(-50%) scale(1);
            }

            80% {
                opacity: 0.9;
                transform: translateX(-50%) scale(1);
            }

            100% {
                top: 100%;
                opacity: 0;
                transform: translateX(-50%) scale(0.8);
            }
        }

        /* Glow pulse effect on the line */
        .pv-energy-line::before {
            content: '';
            position: absolute;
            inset: 0;
            background: inherit;
            border-radius: inherit;
            animation: linePulse 3s ease-in-out infinite;
        }

        @keyframes linePulse {

            0%,
            100% {
                opacity: 0.6;
                box-shadow: 0 0 4px rgba(251, 191, 36, 0.4);
            }

            50% {
                opacity: 1;
                box-shadow: 0 0 12px rgba(251, 191, 36, 0.7);
            }
        }

        /* Hide flow when PV = 0 */
        .pv-energy-line.hidden-flow {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        /* Ti·∫øp ƒëi·ªÉm tr√≤n ·ªü cu·ªëi ƒë∆∞·ªùng line */
        .energy-endpoint,
        .evn-endpoint {
            animation: endpointPulse 2s ease-in-out infinite;
        }

        @keyframes endpointPulse {

            0%,
            100% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 10px #fbbf24, 0 0 20px rgba(251, 191, 36, 0.5);
            }

            50% {
                transform: translateX(-50%) scale(1.2);
                box-shadow: 0 0 15px #fbbf24, 0 0 30px rgba(251, 191, 36, 0.7);
            }
        }

        /* ========================================
           EVN Grid Energy Flow Line
           ======================================== */

        .evn-energy-line {
            position: absolute;
            width: 2px;
            background: linear-gradient(to bottom,
                    rgba(251, 191, 36, 0.8) 0%,
                    rgba(245, 158, 11, 0.6) 50%,
                    rgba(217, 119, 6, 0.4) 100%);
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.5),
                0 0 16px rgba(251, 191, 36, 0.3);
            transition: opacity 0.5s ease;
        }

        /* EVN particles - gi·ªëng PV nh∆∞ng c√≥ class ri√™ng ƒë·ªÉ control */
        .evn-energy-particle {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, #fef3c7 0%, #fbbf24 50%, #f59e0b 100%);
            border-radius: 50%;
            box-shadow: 0 0 6px #fbbf24, 0 0 12px rgba(251, 191, 36, 0.6);
            opacity: 0;
            /* Animation m·∫∑c ƒë·ªãnh t·∫Øt */
        }

        /* Level 1: 0 < EVN <= 20W - 1 h·∫°t */
        .evn-energy-line.flow-level-1 .evn-energy-particle[data-particle="1"] {
            animation: energyFlowDown 2.5s ease-in-out infinite;
        }

        /* Level 2: 20W < EVN <= 1000W - 2 h·∫°t */
        .evn-energy-line.flow-level-2 .evn-energy-particle[data-particle="1"] {
            animation: energyFlowDown 2.5s ease-in-out infinite;
        }

        .evn-energy-line.flow-level-2 .evn-energy-particle[data-particle="2"] {
            animation: energyFlowDown 2.5s ease-in-out infinite 0.8s;
            width: 5px;
            height: 5px;
        }

        /* Level 3: EVN > 1000W - 3 h·∫°t */
        .evn-energy-line.flow-level-3 .evn-energy-particle[data-particle="1"] {
            animation: energyFlowDown 2.5s ease-in-out infinite;
        }

        .evn-energy-line.flow-level-3 .evn-energy-particle[data-particle="2"] {
            animation: energyFlowDown 2.5s ease-in-out infinite 0.8s;
            width: 5px;
            height: 5px;
        }

        .evn-energy-line.flow-level-3 .evn-energy-particle[data-particle="3"] {
            animation: energyFlowDown 2.5s ease-in-out infinite 1.6s;
            width: 4px;
            height: 4px;
        }

        /* Hide EVN flow when grid = 0 */
        .evn-energy-line.hidden-flow {
            opacity: 0;
        }

        /* =====================================================
           UNIFIED LAYOUT - Dark Mode = Light Mode (NO OVERRIDE)
           C·∫£ 2 mode d√πng chung HTML classes, kh√¥ng c√≥ CSS ri√™ng
           ===================================================== */

        /* Dark mode: Battery SOC % x√≠ch l√™n cao h∆°n */
        .dark #energyFlow3DHome .absolute.left-\[8\%\].top-\[52\%\] {
            top: 46% !important;
        }

        /* Battery SOC and % animations - enabled for both modes */

        /* Khi kh√¥ng c√≥ flow level - endpoint kh√¥ng pulse m·∫°nh */
        .evn-energy-line:not(.flow-level-1):not(.flow-level-2):not(.flow-level-3) .evn-endpoint {
            animation: none;
            transform: translateX(-50%) scale(0.9);
            opacity: 0.7;
        }

        /* Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {

            .energy-particle,
            .evn-energy-particle {
                animation: none;
                opacity: 0.7;
                top: 50%;
            }

            .pv-energy-line::before {
                animation: none;
            }

            .energy-endpoint,
            .evn-endpoint {
                animation: none;
            }
        }

        /* ========================================
           3D HOME HEAT EFFECT - DARK MODE
           T·∫£i ti√™u th·ª• & T·∫£i c·ªïng load: ƒê·ªè d·∫ßn theo m·ª©c
           Pin s·∫°c: Xanh ƒë·∫≠m d·∫ßn | Pin x·∫£: ƒê·ªè d·∫ßn
           ======================================== */

        /* LOAD CARD - Dark Mode Heat Effect (Red gradient) */
        .dark .load-heat-card.heat-level-1 {
            border-color: rgba(251, 146, 60, 0.5) !important;
            box-shadow: 0 0 15px rgba(251, 146, 60, 0.3);
        }

        .dark .load-heat-card.heat-level-1 #load-power-3d,
        .dark .load-heat-card.heat-level-1 #load-label-3d {
            color: rgb(251, 146, 60) !important;
        }

        .dark .load-heat-card.heat-level-2 {
            border-color: rgba(249, 115, 22, 0.6) !important;
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.4);
        }

        .dark .load-heat-card.heat-level-2 #load-power-3d,
        .dark .load-heat-card.heat-level-2 #load-label-3d {
            color: rgb(249, 115, 22) !important;
        }

        .dark .load-heat-card.heat-level-3 {
            border-color: rgba(239, 68, 68, 0.7) !important;
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.5);
        }

        .dark .load-heat-card.heat-level-3 #load-power-3d,
        .dark .load-heat-card.heat-level-3 #load-label-3d {
            color: rgb(239, 68, 68) !important;
        }

        .dark .load-heat-card.heat-level-4 {
            border-color: rgba(220, 38, 38, 0.8) !important;
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.6), 0 0 60px rgba(220, 38, 38, 0.3);
        }

        .dark .load-heat-card.heat-level-4 #load-power-3d,
        .dark .load-heat-card.heat-level-4 #load-label-3d {
            color: rgb(220, 38, 38) !important;
        }

        /* ESSENTIAL CARD - Dark Mode Heat Effect (Red gradient) */
        .dark .essential-heat-card.essential-level-1 {
            border-color: rgba(251, 146, 60, 0.5) !important;
            box-shadow: 0 0 15px rgba(251, 146, 60, 0.3);
        }

        .dark .essential-heat-card.essential-level-1 #essential-power-3d {
            color: rgb(251, 146, 60) !important;
        }

        .dark .essential-heat-card.essential-level-2 {
            border-color: rgba(249, 115, 22, 0.6) !important;
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.4);
        }

        .dark .essential-heat-card.essential-level-2 #essential-power-3d {
            color: rgb(249, 115, 22) !important;
        }

        .dark .essential-heat-card.essential-level-3 {
            border-color: rgba(239, 68, 68, 0.7) !important;
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.5);
        }

        .dark .essential-heat-card.essential-level-3 #essential-power-3d {
            color: rgb(239, 68, 68) !important;
        }

        .dark .essential-heat-card.essential-level-4 {
            border-color: rgba(220, 38, 38, 0.8) !important;
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.6), 0 0 60px rgba(220, 38, 38, 0.3);
        }

        .dark .essential-heat-card.essential-level-4 #essential-power-3d {
            color: rgb(220, 38, 38) !important;
        }

        /* BATTERY CARD - Dark Mode: Charging = Green gradient, Discharging = Red gradient */
        /* Charging Level 0-3 (Green intensifies) */
        .dark .battery-heat-card.battery-charging-0 {
            border-color: rgba(52, 211, 153, 0.4) !important;
        }

        .dark .battery-heat-card.battery-charging-0 #battery-power-3d,
        .dark .battery-heat-card.battery-charging-0 #battery-status-label-3d {
            color: rgb(52, 211, 153) !important;
        }

        .dark .battery-heat-card.battery-charging-1 {
            border-color: rgba(16, 185, 129, 0.6) !important;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }

        .dark .battery-heat-card.battery-charging-1 #battery-power-3d,
        .dark .battery-heat-card.battery-charging-1 #battery-status-label-3d {
            color: rgb(16, 185, 129) !important;
        }

        .dark .battery-heat-card.battery-charging-2 {
            border-color: rgba(16, 185, 129, 0.5) !important;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.25);
        }

        .dark .battery-heat-card.battery-charging-2 #battery-power-3d,
        .dark .battery-heat-card.battery-charging-2 #battery-status-label-3d {
            color: rgb(52, 211, 153) !important;
        }

        .dark .battery-heat-card.battery-charging-3 {
            border-color: rgba(16, 185, 129, 0.6) !important;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.3);
        }

        .dark .battery-heat-card.battery-charging-3 #battery-power-3d,
        .dark .battery-heat-card.battery-charging-3 #battery-status-label-3d {
            color: rgb(52, 211, 153) !important;
        }

        /* Discharging Level 0-3 (Red intensifies) */
        .dark .battery-heat-card.battery-discharging-0 {
            border-color: rgba(251, 146, 60, 0.4) !important;
        }

        .dark .battery-heat-card.battery-discharging-0 #battery-power-3d,
        .dark .battery-heat-card.battery-discharging-0 #battery-status-label-3d {
            color: rgb(251, 146, 60) !important;
        }

        .dark .battery-heat-card.battery-discharging-1 {
            border-color: rgba(249, 115, 22, 0.6) !important;
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.3);
        }

        .dark .battery-heat-card.battery-discharging-1 #battery-power-3d,
        .dark .battery-heat-card.battery-discharging-1 #battery-status-label-3d {
            color: rgb(249, 115, 22) !important;
        }

        .dark .battery-heat-card.battery-discharging-2 {
            border-color: rgba(239, 68, 68, 0.7) !important;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        .dark .battery-heat-card.battery-discharging-2 #battery-power-3d,
        .dark .battery-heat-card.battery-discharging-2 #battery-status-label-3d {
            color: rgb(239, 68, 68) !important;
        }

        .dark .battery-heat-card.battery-discharging-3 {
            border-color: rgba(220, 38, 38, 0.8) !important;
            box-shadow: 0 0 25px rgba(220, 38, 38, 0.5), 0 0 50px rgba(220, 38, 38, 0.3);
        }

        .dark .battery-heat-card.battery-discharging-3 #battery-power-3d,
        .dark .battery-heat-card.battery-discharging-3 #battery-status-label-3d {
            color: rgb(220, 38, 38) !important;
        }

        /* ========================================
           3D HOME HEAT EFFECT - LIGHT MODE
           M√†u nh·∫π nh√†ng h∆°n, ph√π h·ª£p n·ªÅn s√°ng
           ======================================== */

        /* LOAD CARD - Light Mode: Level 0 (0W) = Green like battery charging */
        .load-heat-card.heat-level-0:not(.dark *) {
            border-color: rgba(16, 185, 129, 0.5) !important;
            background: linear-gradient(135deg, rgba(209, 250, 229, 0.8), rgba(167, 243, 208, 0.6)) !important;
        }

        .load-heat-card.heat-level-0:not(.dark *) #load-power-3d,
        .load-heat-card.heat-level-0:not(.dark *) #load-label-3d {
            color: rgb(5, 150, 105) !important;
        }

        /* LOAD CARD - Light Mode Heat Effect */
        .load-heat-card.heat-level-1:not(.dark *) {
            border-color: rgba(217, 119, 6, 0.6) !important;
            background: linear-gradient(135deg, rgba(254, 243, 199, 0.8), rgba(253, 230, 138, 0.6)) !important;
        }

        .load-heat-card.heat-level-1:not(.dark *) #load-power-3d,
        .load-heat-card.heat-level-1:not(.dark *) #load-label-3d {
            color: rgb(180, 83, 9) !important;
        }

        .load-heat-card.heat-level-2:not(.dark *) {
            border-color: rgba(234, 88, 12, 0.7) !important;
            background: linear-gradient(135deg, rgba(255, 237, 213, 0.9), rgba(254, 215, 170, 0.7)) !important;
        }

        .load-heat-card.heat-level-2:not(.dark *) #load-power-3d,
        .load-heat-card.heat-level-2:not(.dark *) #load-label-3d {
            color: rgb(194, 65, 12) !important;
        }

        .load-heat-card.heat-level-3:not(.dark *) {
            border-color: rgba(220, 38, 38, 0.7) !important;
            background: linear-gradient(135deg, rgba(254, 226, 226, 0.9), rgba(254, 202, 202, 0.7)) !important;
        }

        .load-heat-card.heat-level-3:not(.dark *) #load-power-3d,
        .load-heat-card.heat-level-3:not(.dark *) #load-label-3d {
            color: rgb(185, 28, 28) !important;
        }

        .load-heat-card.heat-level-4:not(.dark *) {
            border-color: rgba(185, 28, 28, 0.8) !important;
            background: linear-gradient(135deg, rgba(254, 202, 202, 1), rgba(252, 165, 165, 0.8)) !important;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .load-heat-card.heat-level-4:not(.dark *) #load-power-3d,
        .load-heat-card.heat-level-4:not(.dark *) #load-label-3d {
            color: rgb(153, 27, 27) !important;
        }

        /* ESSENTIAL CARD - Light Mode: Level 0 (0W) = Green like battery charging */
        .essential-heat-card.essential-level-0:not(.dark *) {
            border-color: rgba(16, 185, 129, 0.5) !important;
            background: linear-gradient(135deg, rgba(209, 250, 229, 0.8), rgba(167, 243, 208, 0.6)) !important;
        }

        .essential-heat-card.essential-level-0:not(.dark *) #essential-power-3d {
            color: rgb(5, 150, 105) !important;
        }

        /* ESSENTIAL CARD - Light Mode Heat Effect */
        .essential-heat-card.essential-level-1:not(.dark *) {
            border-color: rgba(217, 119, 6, 0.6) !important;
            background: linear-gradient(135deg, rgba(254, 243, 199, 0.8), rgba(253, 230, 138, 0.6)) !important;
        }

        .essential-heat-card.essential-level-1:not(.dark *) #essential-power-3d {
            color: rgb(180, 83, 9) !important;
        }

        .essential-heat-card.essential-level-2:not(.dark *) {
            border-color: rgba(234, 88, 12, 0.7) !important;
            background: linear-gradient(135deg, rgba(255, 237, 213, 0.9), rgba(254, 215, 170, 0.7)) !important;
        }

        .essential-heat-card.essential-level-2:not(.dark *) #essential-power-3d {
            color: rgb(194, 65, 12) !important;
        }

        .essential-heat-card.essential-level-3:not(.dark *) {
            border-color: rgba(220, 38, 38, 0.7) !important;
            background: linear-gradient(135deg, rgba(254, 226, 226, 0.9), rgba(254, 202, 202, 0.7)) !important;
        }

        .essential-heat-card.essential-level-3:not(.dark *) #essential-power-3d {
            color: rgb(185, 28, 28) !important;
        }

        .essential-heat-card.essential-level-4:not(.dark *) {
            border-color: rgba(185, 28, 28, 0.8) !important;
            background: linear-gradient(135deg, rgba(254, 202, 202, 1), rgba(252, 165, 165, 0.8)) !important;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .essential-heat-card.essential-level-4:not(.dark *) #essential-power-3d {
            color: rgb(153, 27, 27) !important;
        }

        /* BATTERY CARD - Light Mode: Charging = Green, Discharging = Red/Orange */
        /* Charging (Green background tints) */
        .battery-heat-card.battery-charging-0:not(.dark *) {
            border-color: rgba(16, 185, 129, 0.5) !important;
            background: linear-gradient(135deg, rgba(209, 250, 229, 0.8), rgba(167, 243, 208, 0.6)) !important;
        }

        .battery-heat-card.battery-charging-0:not(.dark *) #battery-power-3d,
        .battery-heat-card.battery-charging-0:not(.dark *) #battery-status-label-3d {
            color: rgb(5, 150, 105) !important;
        }

        .battery-heat-card.battery-charging-1:not(.dark *) {
            border-color: rgba(5, 150, 105, 0.6) !important;
            background: linear-gradient(135deg, rgba(167, 243, 208, 0.9), rgba(110, 231, 183, 0.7)) !important;
        }

        .battery-heat-card.battery-charging-1:not(.dark *) #battery-power-3d,
        .battery-heat-card.battery-charging-1:not(.dark *) #battery-status-label-3d {
            color: rgb(4, 120, 87) !important;
        }

        .battery-heat-card.battery-charging-2:not(.dark *) {
            border-color: rgba(4, 120, 87, 0.7) !important;
            background: linear-gradient(135deg, rgba(110, 231, 183, 0.9), rgba(52, 211, 153, 0.7)) !important;
        }

        .battery-heat-card.battery-charging-2:not(.dark *) #battery-power-3d,
        .battery-heat-card.battery-charging-2:not(.dark *) #battery-status-label-3d {
            color: rgb(6, 95, 70) !important;
        }

        .battery-heat-card.battery-charging-3:not(.dark *) {
            border-color: rgba(6, 95, 70, 0.8) !important;
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.9), rgba(16, 185, 129, 0.8)) !important;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .battery-heat-card.battery-charging-3:not(.dark *) #battery-power-3d,
        .battery-heat-card.battery-charging-3:not(.dark *) #battery-status-label-3d {
            color: rgb(6, 78, 59) !important;
        }

        /* Discharging (Orange/Red background tints) */
        .battery-heat-card.battery-discharging-0:not(.dark *) {
            border-color: rgba(251, 146, 60, 0.5) !important;
            background: linear-gradient(135deg, rgba(255, 237, 213, 0.8), rgba(254, 215, 170, 0.6)) !important;
        }

        .battery-heat-card.battery-discharging-0:not(.dark *) #battery-power-3d,
        .battery-heat-card.battery-discharging-0:not(.dark *) #battery-status-label-3d {
            color: rgb(194, 65, 12) !important;
        }

        .battery-heat-card.battery-discharging-1:not(.dark *) {
            border-color: rgba(234, 88, 12, 0.6) !important;
            background: linear-gradient(135deg, rgba(254, 215, 170, 0.9), rgba(253, 186, 116, 0.7)) !important;
        }

        .battery-heat-card.battery-discharging-1:not(.dark *) #battery-power-3d,
        .battery-heat-card.battery-discharging-1:not(.dark *) #battery-status-label-3d {
            color: rgb(180, 83, 9) !important;
        }

        .battery-heat-card.battery-discharging-2:not(.dark *) {
            border-color: rgba(220, 38, 38, 0.7) !important;
            background: linear-gradient(135deg, rgba(254, 226, 226, 0.9), rgba(254, 202, 202, 0.7)) !important;
        }

        .battery-heat-card.battery-discharging-2:not(.dark *) #battery-power-3d,
        .battery-heat-card.battery-discharging-2:not(.dark *) #battery-status-label-3d {
            color: rgb(185, 28, 28) !important;
        }

        .battery-heat-card.battery-discharging-3:not(.dark *) {
            border-color: rgba(185, 28, 28, 0.8) !important;
            background: linear-gradient(135deg, rgba(254, 202, 202, 1), rgba(252, 165, 165, 0.8)) !important;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .battery-heat-card.battery-discharging-3:not(.dark *) #battery-power-3d,
        .battery-heat-card.battery-discharging-3:not(.dark *) #battery-status-label-3d {
            color: rgb(153, 27, 27) !important;
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <!-- Background Gradient Blobs - Dark Mode Only (6 blobs total) -->
    <div id="blob-purple" class="bg-blob bg-blob-purple" aria-hidden="true"></div>
    <div id="blob-teal" class="bg-blob bg-blob-teal" aria-hidden="true"></div>
    <div id="blob-indigo" class="bg-blob bg-blob-indigo" aria-hidden="true"></div>
    <div id="blob-pink" class="bg-blob bg-blob-pink" aria-hidden="true"></div>
    <div id="blob-cyan" class="bg-blob bg-blob-cyan" aria-hidden="true"></div>
    <div id="blob-amber" class="bg-blob bg-blob-amber" aria-hidden="true"></div>

    <!-- Header - Dark theme, Hide on scroll down, show on scroll up -->
    <header b-iwpun16f09 id="mainHeader"
        class="bg-slate-900 border-b border-slate-700/50 shadow-xl sticky top-0 z-50 transition-transform duration-300">
        <div b-iwpun16f09 class="container mx-auto px-3 sm:px-4 py-2.5 sm:py-3">
            <div b-iwpun16f09 class="flex items-center justify-between">
                <!-- Logo + Brand -->
                <div b-iwpun16f09 class="flex items-center gap-2 sm:gap-3">
                    <div class="relative">
                        <img b-iwpun16f09 src="logo.png" alt="LightEarth"
                            class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg shadow-lg">
                        <!-- Solar glow effect -->
                        <div class="absolute -inset-1 bg-amber-500/20 rounded-xl blur-sm -z-10"></div>
                    </div>
                    <div b-iwpun16f09>
                        <h1 b-iwpun16f09 class="text-base sm:text-lg font-bold">
                            <span
                                class="bg-gradient-to-r from-teal-400 via-emerald-400 to-indigo-400 bg-clip-text text-transparent">LightEarth</span>
                            <span class="text-slate-300 font-medium ml-1">Web Pro</span>
                        </h1>
                        <p b-iwpun16f09 class="text-[10px] sm:text-xs text-slate-400 flex items-center gap-1">
                            <svg class="w-3 h-3 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>Gi√°m S√°t NƒÉng L∆∞·ª£ng M·∫∑t Tr·ªùi</span>
                        </p>
                    </div>
                </div>

                <!-- Right side -->
                <div b-iwpun16f09 class="flex items-center gap-2 sm:gap-3">
                    <!-- Connection Status -->
                    <div b-iwpun16f09
                        class="flex items-center gap-1.5 sm:gap-2 bg-slate-800 border border-slate-700 rounded-full px-2.5 sm:px-3 py-1 sm:py-1.5">
                        <div b-iwpun16f09 id="connectionIndicator"
                            class="w-2 h-2 sm:w-2.5 sm:h-2.5 rounded-full status-disconnected"></div>
                        <span b-iwpun16f09 id="connectionText"
                            class="text-[10px] sm:text-xs text-slate-300 font-medium">ƒêang k·∫øt n·ªëi...</span>
                    </div>

                    <!-- Calculator Button in Header - Direct link to /calculator with deviceId (Desktop) -->
                    <a b-iwpun16f09 id="calcLinkHeader" href="/calculator"
                        class="hidden sm:flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-lg transition-all shadow-lg shadow-emerald-900/30 no-underline">
                        <i b-iwpun16f09 data-lucide="calculator" class="w-4 h-4"></i>
                        <span b-iwpun16f09 class="text-sm font-medium">T√≠nh Ti·∫øt Ki·ªám</span>
                    </a>

                    <!-- Theme Toggle -->
                    <button b-iwpun16f09 id="themeToggle"
                        class="w-8 h-8 sm:w-9 sm:h-9 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg flex items-center justify-center transition-all">
                        <i b-iwpun16f09 data-lucide="moon" class="w-4 h-4 sm:w-5 sm:h-5 text-slate-300 dark:hidden"></i>
                        <i b-iwpun16f09 data-lucide="sun"
                            class="w-4 h-4 sm:w-5 sm:h-5 text-amber-400 hidden dark:block"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Community & Bot Links - Side by Side -->
    <div
        class="w-full flex flex-wrap justify-center items-center gap-2 sm:gap-4 py-3 px-2 bg-gradient-to-r from-blue-50 to-teal-50 dark:from-slate-800 dark:to-slate-900 border-b border-blue-200 dark:border-slate-700">
        <!-- Zalo Community -->
        <a href="https://zalo.me/g/kmzrgh433" target="_blank" rel="noopener noreferrer"
            class="flex items-center gap-2 px-3 sm:px-5 py-2 sm:py-2.5 bg-[#0068FF] hover:bg-[#0055DD] text-white rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105 active:scale-95">
            <img src="/zalo-logo.png" alt="Zalo" class="w-5 h-5 sm:w-6 sm:h-6 rounded-lg">
            <span class="text-xs sm:text-sm font-bold whitespace-nowrap">Join Zalo LightEarth VN</span>
        </a>

        <!-- Telegram Bot -->
        <a href="https://t.me/lightearth_bot" target="_blank" rel="noopener noreferrer"
            class="flex items-center gap-2 px-3 sm:px-5 py-2 sm:py-2.5 bg-[#0088cc] hover:bg-[#006699] text-white rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105 active:scale-95">
            <img src="/telegram-logo.png" alt="Telegram" class="w-5 h-5 sm:w-6 sm:h-6 rounded-full">
            <span class="text-xs sm:text-sm font-bold whitespace-nowrap">BOT C·∫£nh B√°o H·ªá Th·ªëng</span>
        </a>
    </div>

    <!-- Main Content -->
    <main b-iwpun16f09 class="container mx-auto px-4 py-6">

        <!-- Premium Hero Section - Landing Page -->
        <div id="heroSection"
            class="hero-landing min-h-[70vh] sm:min-h-[60vh] flex flex-col items-center justify-center relative overflow-hidden mb-6">
            <!-- Animated Background -->
            <div class="absolute inset-0 hero-bg-gradient"></div>
            <div class="absolute inset-0 hero-grid-pattern opacity-30"></div>

            <!-- Floating Elements -->
            <div class="hero-float-element hero-float-1"></div>
            <div class="hero-float-element hero-float-2"></div>
            <div class="hero-float-element hero-float-3"></div>

            <!-- Main Content -->
            <div class="relative z-10 text-center px-4 max-w-2xl mx-auto">
                <!-- Logo Animation -->
                <div class="hero-logo-container mb-6">
                    <div class="hero-logo-ring"></div>
                    <div class="hero-logo-ring hero-logo-ring-2"></div>
                    <img src="logo.png" alt="LightEarth"
                        class="w-20 h-20 sm:w-24 sm:h-24 rounded-2xl shadow-2xl relative z-10 hero-logo-pulse">
                </div>

                <!-- Title -->
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-black mb-3 hero-title">
                    <span
                        class="bg-gradient-to-r from-teal-400 via-emerald-400 to-indigo-400 bg-clip-text text-transparent">LightEarth</span>
                    <span class="text-white dark:text-white"> Monitor</span>
                </h1>

                <!-- Subtitle -->
                <p class="text-white/70 text-sm sm:text-base mb-8 font-light tracking-wide">
                    Real-time Solar Energy Monitoring System
                </p>

                <!-- Premium Input Card -->
                <div
                    class="hero-input-card bg-white/10 dark:bg-slate-800/50 backdrop-blur-xl rounded-2xl sm:rounded-3xl p-5 sm:p-8 border border-white/20 shadow-2xl">
                    <!-- Device ID Input -->
                    <div class="mb-5">
                        <label class="block text-white/60 text-xs font-medium mb-2 uppercase tracking-widest">Device
                            ID</label>
                        <div class="relative">
                            <input type="text" id="deviceId" placeholder="P250812032"
                                class="w-full px-5 py-4 text-lg sm:text-xl font-semibold text-center bg-white/10 dark:bg-slate-900/50 border-2 border-white/20 rounded-xl focus:outline-none focus:border-cyan-400 focus:bg-white/20 text-white placeholder-white/30 transition-all duration-300 tracking-wider">
                            <div class="absolute right-4 top-1/2 -translate-y-1/2">
                                <i data-lucide="cpu" class="w-5 h-5 text-white/40"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Date Selector -->
                    <div class="mb-6">
                        <label
                            class="block text-white/60 text-xs font-medium mb-2 uppercase tracking-widest">Date</label>
                        <div class="flex items-center gap-2">
                            <button id="prevDay" class="hero-date-btn">
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </button>
                            <input type="date" id="dateInput"
                                class="flex-grow px-4 py-3 text-center bg-white/10 dark:bg-slate-900/50 border-2 border-white/20 rounded-xl focus:outline-none focus:border-cyan-400 text-white font-medium transition-all duration-300">
                            <button id="nextDay" class="hero-date-btn">
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button id="viewBtn"
                        class="hero-submit-btn group w-full py-4 sm:py-5 rounded-xl font-bold text-base sm:text-lg uppercase tracking-wider transition-all duration-300">
                        <span class="flex items-center justify-center gap-3">
                            <span>Xem Dashboard</span>
                            <i data-lucide="arrow-right"
                                class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                        </span>
                    </button>
                </div>

                <!-- Stats Preview -->
                <div class="flex items-center justify-center gap-6 sm:gap-10 mt-8 text-white/50 text-xs sm:text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-cyan-400 animate-pulse"></div>
                        <span>Real-time</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i data-lucide="zap" class="w-4 h-4 text-teal-400"></i>
                        <span>H·ªá th·ªëng ƒë√£ k·∫øt n·ªëi</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i data-lucide="shield-check" class="w-4 h-4 text-indigo-400"></i>
                        <span>Secure</span>
                    </div>
                </div>
            </div>

            <!-- Scroll Indicator -->
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 hero-scroll-indicator hidden" id="scrollIndicator">
                <div class="w-6 h-10 rounded-full border-2 border-white/30 flex items-start justify-center p-1">
                    <div class="w-1.5 h-2.5 bg-white/50 rounded-full animate-bounce"></div>
                </div>
            </div>
        </div>

        <!-- Compact Search Bar (shown after data loaded) - NOT sticky on mobile, sticky on PC via CSS -->
        <div id="compactSearch"
            class="hidden mb-3 bg-white/95 dark:bg-slate-800/50 backdrop-blur-md rounded-xl shadow-md p-1.5 sm:p-3 border border-slate-200 dark:border-slate-700/50">
            <!-- Mobile: single compact row | PC: single row with more spacing -->
            <div class="flex items-center justify-between gap-1.5 sm:gap-3">
                <!-- Left side: Logo + Device ID + Change Device Button (cƒÉn gi·ªØa theo chi·ªÅu d·ªçc) -->
                <div class="flex items-center gap-1.5 sm:gap-2 min-w-0">
                    <img src="logo.png" alt="LightEarth" class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg shadow flex-shrink-0">
                    <div class="flex items-center gap-1.5">
                        <span class="text-xs font-bold text-slate-800 dark:text-white truncate"
                            id="deviceIdDisplay">--</span>
                        <!-- Change Device Button - c√≥ ch·ªØ "ƒê·ªïi ID" - LARGER for mobile -->
                        <button id="changeDeviceBtn"
                            class="flex items-center gap-1 px-2.5 py-1.5 rounded-lg bg-teal-100 dark:bg-teal-900/30 text-teal-600 dark:text-teal-400 hover:bg-teal-200 dark:hover:bg-teal-800/50 transition-colors flex-shrink-0"
                            title="ƒê·ªïi ID">
                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                            <span class="text-xs font-medium">ƒê·ªïi ID</span>
                        </button>
                    </div>
                    <!-- Hidden dateDisplay - kept for JS compatibility -->
                    <div class="hidden" id="dateDisplay">--</div>
                </div>

                <!-- Right side: Date Navigation + Calculate Button -->
                <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                    <!-- Date Navigation Group -->
                    <div class="flex items-center gap-0.5 sm:gap-1">
                        <button id="prevDayCompact"
                            class="p-1 sm:p-1.5 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                            title="Ng√†y tr∆∞·ªõc">
                            <i data-lucide="chevron-left" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                        </button>
                        <!-- Date Display with Date Picker -->
                        <div class="relative">
                            <button id="datePickerBtn"
                                class="flex items-center gap-1 px-1.5 sm:px-2.5 py-1 sm:py-1.5 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors pointer-events-none"
                                title="Ch·ªçn ng√†y">
                                <i data-lucide="calendar"
                                    class="w-3 h-3 sm:w-3.5 sm:h-3.5 text-teal-500 hidden sm:block"></i>
                                <span id="compactDateDisplay"
                                    class="text-[11px] sm:text-xs font-semibold text-slate-700 dark:text-slate-200">--/--/----</span>
                            </button>
                            <input type="date" id="compactDateInput"
                                class="absolute inset-0 opacity-0 cursor-pointer w-full h-full z-10"
                                style="pointer-events: auto;" onclick="this.showPicker()" title="Ch·ªçn ng√†y">
                        </div>
                        <button id="nextDayCompact"
                            class="p-1 sm:p-1.5 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                            title="Ng√†y sau">
                            <i data-lucide="chevron-right" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                        </button>
                    </div>

                    <!-- Calculate Button - hi·ªán ch·ªØ tr√™n mobile, chi·ªÅu cao b·∫±ng date box -->
                    <a id="calcLinkCompact" href="/calculator"
                        class="flex items-center gap-1 px-2 sm:px-3 py-2 sm:py-1.5 rounded-lg bg-emerald-500 text-white hover:bg-emerald-600 text-[10px] sm:text-xs font-semibold transition-colors flex-shrink-0 self-stretch"
                        title="T√≠nh Ti·∫øt Ki·ªám">
                        <i data-lucide="calculator" class="w-3 h-3 sm:w-3.5 sm:h-3.5"></i>
                        <span>Ti·∫øt Ki·ªám</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Device Info Panel -->
        <div id="deviceInfo"
            class="hidden bg-white/95 dark:bg-slate-800/50 backdrop-blur-md rounded-xl shadow-md p-3 mb-4 border border-slate-200 dark:border-slate-700/50">
            <div class="flex flex-wrap items-center gap-3 text-xs sm:text-sm">
                <div class="flex items-center gap-2">
                    <i data-lucide="cpu" class="w-4 h-4 text-teal-500"></i>
                    <span class="text-slate-500">ID:</span>
                    <span id="device-id" class="font-semibold text-slate-800 dark:text-white"></span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="box" class="w-4 h-4 text-blue-500"></i>
                    <span class="text-slate-500">Lo·∫°i:</span>
                    <span id="device-type" class="font-semibold"></span>
                </div>
                <div class="flex items-center gap-2">
                    <span id="device-status" class="flex items-center gap-1"></span>
                </div>
                <div class="flex items-center gap-2" title="Nhi·ªát ƒë·ªô bi·∫øn t·∫ßn">
                    <i data-lucide="thermometer" class="w-4 h-4 text-red-500"></i>
                    <span class="text-xs text-slate-400 hidden sm:inline">Bi·∫øn t·∫ßn:</span>
                    <span id="device-temp-info" class="font-semibold">--</span>
                </div>
                <!-- Temperature Min/Max Badge -->
                <div id="tempMinMaxBadge"
                    class="hidden flex items-center gap-2.5 px-2.5 py-1 rounded-lg bg-gradient-to-r from-blue-500/10 to-red-500/10 dark:from-blue-500/20 dark:to-red-500/20 border border-slate-200 dark:border-slate-600">
                    <div class="flex items-center gap-1.5" title="Nhi·ªát ƒë·ªô th·∫•p nh·∫•t h√¥m nay">
                        <i data-lucide="thermometer-snowflake" class="w-3 h-3 text-blue-500"></i>
                        <span class="text-[10px] text-blue-500 font-semibold tracking-wide">MIN:</span>
                        <span id="temp-min-value" class="text-xs font-bold text-blue-600 dark:text-blue-400">--</span>
                    </div>
                    <span class="text-slate-300 dark:text-slate-600">|</span>
                    <div class="flex items-center gap-1.5" title="Nhi·ªát ƒë·ªô cao nh·∫•t h√¥m nay">
                        <i data-lucide="thermometer-sun" class="w-3 h-3 text-red-500"></i>
                        <span class="text-[10px] text-red-500 font-semibold tracking-wide">MAX:</span>
                        <span id="temp-max-value" class="text-xs font-bold text-red-600 dark:text-red-400">--</span>
                    </div>
                </div>
                <div id="lastUpdate" class="ml-auto flex items-center gap-1 text-slate-400">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                    <span class="text-[10px]" id="lastUpdateTime">--</span>
                </div>
            </div>
        </div>

        <!-- Real-Time Energy Flow -->
        <div id="realTimeFlow" class="hidden mb-4">
            <div
                class="bg-white/95 dark:bg-slate-800/50 backdrop-blur-md rounded-xl shadow-md p-3 sm:p-4 border border-slate-200 dark:border-slate-700/50">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        S∆° ƒê·ªì NƒÉng L∆∞·ª£ng
                    </h2>

                    <div class="flex items-center gap-2">
                        <!-- Pro/Basic Interface Toggle -->
                        <div class="flex items-center bg-slate-200 dark:bg-slate-700 rounded-lg p-0.5">
                            <button id="basicViewBtn" onclick="switchEnergyFlowView('basic')" class="px-2.5 py-1.5 text-xs font-medium rounded-md transition-all duration-200
                               text-slate-600 dark:text-slate-300 hover:text-slate-800 dark:hover:text-slate-100"
                                title="Giao di·ªán Basic - ƒê∆°n gi·∫£n">
                                Basic
                            </button>
                            <button id="proViewBtn" onclick="switchEnergyFlowView('pro')" class="px-2.5 py-1.5 text-xs font-medium rounded-md transition-all duration-200
                               bg-teal-500 text-white shadow-sm" title="Giao di·ªán Pro - ƒê·∫ßy ƒë·ªß animation">
                                Pro
                            </button>
                            <button id="home3DViewBtn" onclick="switchEnergyFlowView('3dhome')" class="px-2.5 py-1.5 text-xs font-medium rounded-md transition-all duration-200
                               text-slate-600 dark:text-slate-300 hover:text-slate-800 dark:hover:text-slate-100"
                                title="Giao di·ªán 3D Home">
                                3D Home
                            </button>
                        </div>

                        <!-- Toggle button for animation mode (default: reduced) -->
                        <button id="toggleAnimationBtn" onclick="toggleAnimationMode()" class="flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium rounded-lg transition-all duration-200
                           bg-amber-100 hover:bg-amber-200 dark:bg-amber-900/50 dark:hover:bg-amber-800/50 
                           text-amber-700 dark:text-amber-300 border border-amber-400 dark:border-amber-600"
                            title="B·∫≠t/T·∫Øt ch·∫ø ƒë·ªô tƒÉng hi·ªáu ·ª©ng">
                            <svg id="animationIcon" class="w-4 h-4" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                            </svg>
                            <span id="animationBtnText">TƒÉng hi·ªáu ·ª©ng</span>
                        </button>
                    </div>
                </div>

                <!-- Solar Radiation Forecast - Hourly -->
                <div id="solarForecastSection" class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xl sm:text-2xl">‚òÄÔ∏è</span>
                            <span class="text-sm sm:text-base font-bold text-slate-700 dark:text-slate-300">D·ª± b√°o b·ª©c
                                x·∫° m·∫∑t tr·ªùi</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <!-- City Selector Dropdown -->
                            <div class="relative">
                                <select id="solar-city-select" onchange="changeSolarCity(this.value)" class="appearance-none bg-slate-100 dark:bg-slate-700 text-[10px] text-slate-600 dark:text-slate-300 
                                   pl-5 pr-5 py-1 rounded-md border border-slate-200 dark:border-slate-600 
                                   cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors
                                   focus:outline-none focus:ring-1 focus:ring-amber-400">
                                    <optgroup label="üå¥ Mi·ªÅn Nam">
                                        <option value="TP. H·ªì Ch√≠ Minh" selected>TP. H·ªì Ch√≠ Minh</option>
                                        <option value="B√† R·ªãa - V≈©ng T√†u">B√† R·ªãa - V≈©ng T√†u</option>
                                        <option value="B√¨nh D∆∞∆°ng">B√¨nh D∆∞∆°ng</option>
                                        <option value="B√¨nh Ph∆∞·ªõc">B√¨nh Ph∆∞·ªõc</option>
                                        <option value="ƒê·ªìng Nai">ƒê·ªìng Nai</option>
                                        <option value="T√¢y Ninh">T√¢y Ninh</option>
                                        <option value="Long An">Long An</option>
                                        <option value="Ti·ªÅn Giang">Ti·ªÅn Giang</option>
                                        <option value="B·∫øn Tre">B·∫øn Tre</option>
                                        <option value="Vƒ©nh Long">Vƒ©nh Long</option>
                                        <option value="Tr√† Vinh">Tr√† Vinh</option>
                                        <option value="ƒê·ªìng Th√°p">ƒê·ªìng Th√°p</option>
                                        <option value="An Giang">An Giang</option>
                                        <option value="Ki√™n Giang">Ki√™n Giang</option>
                                        <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
                                        <option value="H·∫≠u Giang">H·∫≠u Giang</option>
                                        <option value="S√≥c TrƒÉng">S√≥c TrƒÉng</option>
                                        <option value="B·∫°c Li√™u">B·∫°c Li√™u</option>
                                        <option value="C√† Mau">C√† Mau</option>
                                    </optgroup>
                                    <optgroup label="üèñÔ∏è Mi·ªÅn Trung">
                                        <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                                        <option value="Th·ª´a Thi√™n Hu·∫ø">Th·ª´a Thi√™n Hu·∫ø</option>
                                        <option value="Qu·∫£ng Nam">Qu·∫£ng Nam</option>
                                        <option value="Qu·∫£ng Ng√£i">Qu·∫£ng Ng√£i</option>
                                        <option value="B√¨nh ƒê·ªãnh">B√¨nh ƒê·ªãnh</option>
                                        <option value="Ph√∫ Y√™n">Ph√∫ Y√™n</option>
                                        <option value="Kh√°nh H√≤a">Kh√°nh H√≤a</option>
                                        <option value="Ninh Thu·∫≠n">Ninh Thu·∫≠n</option>
                                        <option value="B√¨nh Thu·∫≠n">B√¨nh Thu·∫≠n</option>
                                        <option value="Qu·∫£ng B√¨nh">Qu·∫£ng B√¨nh</option>
                                        <option value="Qu·∫£ng Tr·ªã">Qu·∫£ng Tr·ªã</option>
                                        <option value="H√† Tƒ©nh">H√† Tƒ©nh</option>
                                        <option value="Ngh·ªá An">Ngh·ªá An</option>
                                        <option value="Thanh H√≥a">Thanh H√≥a</option>
                                    </optgroup>
                                    <optgroup label="üèîÔ∏è T√¢y Nguy√™n">
                                        <option value="Kon Tum">Kon Tum</option>
                                        <option value="Gia Lai">Gia Lai</option>
                                        <option value="ƒê·∫Øk L·∫Øk">ƒê·∫Øk L·∫Øk</option>
                                        <option value="ƒê·∫Øk N√¥ng">ƒê·∫Øk N√¥ng</option>
                                        <option value="L√¢m ƒê·ªìng">L√¢m ƒê·ªìng</option>
                                    </optgroup>
                                    <optgroup label="‚ùÑÔ∏è Mi·ªÅn B·∫Øc">
                                        <option value="H√† N·ªôi">H√† N·ªôi</option>
                                        <option value="H·∫£i Ph√≤ng">H·∫£i Ph√≤ng</option>
                                        <option value="Qu·∫£ng Ninh">Qu·∫£ng Ninh</option>
                                        <option value="B·∫Øc Giang">B·∫Øc Giang</option>
                                        <option value="B·∫Øc Ninh">B·∫Øc Ninh</option>
                                        <option value="H·∫£i D∆∞∆°ng">H·∫£i D∆∞∆°ng</option>
                                        <option value="H∆∞ng Y√™n">H∆∞ng Y√™n</option>
                                        <option value="Th√°i B√¨nh">Th√°i B√¨nh</option>
                                        <option value="Nam ƒê·ªãnh">Nam ƒê·ªãnh</option>
                                        <option value="Ninh B√¨nh">Ninh B√¨nh</option>
                                        <option value="H√† Nam">H√† Nam</option>
                                        <option value="Vƒ©nh Ph√∫c">Vƒ©nh Ph√∫c</option>
                                        <option value="Ph√∫ Th·ªç">Ph√∫ Th·ªç</option>
                                        <option value="Th√°i Nguy√™n">Th√°i Nguy√™n</option>
                                        <option value="B·∫Øc K·∫°n">B·∫Øc K·∫°n</option>
                                        <option value="Cao B·∫±ng">Cao B·∫±ng</option>
                                        <option value="L·∫°ng S∆°n">L·∫°ng S∆°n</option>
                                        <option value="Tuy√™n Quang">Tuy√™n Quang</option>
                                        <option value="H√† Giang">H√† Giang</option>
                                        <option value="Y√™n B√°i">Y√™n B√°i</option>
                                        <option value="L√†o Cai">L√†o Cai</option>
                                        <option value="Lai Ch√¢u">Lai Ch√¢u</option>
                                        <option value="ƒêi·ªán Bi√™n">ƒêi·ªán Bi√™n</option>
                                        <option value="S∆°n La">S∆°n La</option>
                                        <option value="H√≤a B√¨nh">H√≤a B√¨nh</option>
                                    </optgroup>
                                </select>
                                <span class="absolute left-1.5 top-1/2 -translate-y-1/2 text-[10px]">üìç</span>
                                <svg class="absolute right-1 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                            <span class="text-[10px] text-slate-400 dark:text-slate-500">|</span>
                            <span class="text-[10px] text-slate-500 dark:text-slate-400"
                                id="solar-update-time">--</span>
                        </div>
                    </div>

                    <!-- Current Solar Info - Enhanced with BIGGER TEXT -->
                    <div
                        class="mb-3 p-2.5 sm:p-4 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-xl border-2 border-amber-200 dark:border-amber-700">
                        <!-- Row 1: Main solar info - Compact on mobile -->
                        <div class="flex items-center gap-1.5 sm:gap-3">
                            <div class="flex items-center gap-1 sm:gap-2">
                                <span class="text-lg sm:text-2xl" id="solar-current-icon">‚òÄÔ∏è</span>
                                <span class="text-xs sm:text-base text-slate-600 dark:text-slate-400 font-medium">Hi·ªán
                                    t·∫°i:</span>
                                <span class="text-base sm:text-xl font-black text-amber-600 dark:text-amber-400"
                                    id="solar-current-value">-- W/m¬≤</span>
                            </div>
                            <span class="text-slate-300 dark:text-slate-600 text-base sm:text-lg">|</span>
                            <div class="flex items-center gap-1 sm:gap-1.5">
                                <span class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full" id="solar-level-dot"></span>
                                <span class="text-xs sm:text-base font-semibold" id="solar-level-text">--</span>
                            </div>
                            <span class="text-slate-300 dark:text-slate-600 text-base sm:text-lg">|</span>
                            <div class="flex items-center gap-1 sm:gap-1.5">
                                <span class="text-sm sm:text-lg text-slate-500 dark:text-slate-400">üå°Ô∏è</span>
                                <span class="text-xs sm:text-base font-semibold text-slate-600 dark:text-slate-300"
                                    id="solar-temp">--¬∞C</span>
                            </div>
                            <div class="ml-auto flex items-center gap-1 sm:gap-1.5">
                                <span class="text-sm sm:text-lg text-slate-500 dark:text-slate-400">‚òÅÔ∏è</span>
                                <span class="text-xs sm:text-sm text-slate-500 dark:text-slate-400">M√¢y:</span>
                                <span class="text-xs sm:text-base font-semibold text-slate-600 dark:text-slate-300"
                                    id="solar-cloud">--%</span>
                            </div>
                        </div>
                        <!-- Row 2: UV Index, Sunshine Duration, Precipitation - Compact on mobile -->
                        <div
                            class="flex items-center gap-1.5 sm:gap-2 mt-1.5 sm:mt-2 pt-1.5 sm:pt-2 border-t border-amber-200/50 dark:border-amber-700/50">
                            <!-- UV Index -->
                            <div class="flex items-center gap-1 sm:gap-1" title="Ch·ªâ s·ªë UV - M·ª©c ƒë·ªô tia c·ª±c t√≠m">
                                <span class="text-xs sm:text-sm">üîÜ</span>
                                <span class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400">UV:</span>
                                <span class="text-xs sm:text-sm font-bold" id="solar-uv-value">--</span>
                                <span class="text-[8px] sm:text-[10px] px-1 sm:px-1 py-0.5 rounded font-semibold"
                                    id="solar-uv-badge">--</span>
                            </div>
                            <span class="text-slate-300 dark:text-slate-600 text-xs sm:text-sm">|</span>
                            <!-- Sunshine Duration (Forecast for today) -->
                            <div class="flex items-center gap-1 sm:gap-1" title="D·ª± b√°o t·ªïng th·ªùi gian n·∫Øng h√¥m nay">
                                <span class="text-xs sm:text-sm">‚è±Ô∏è</span>
                                <span class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400">N·∫Øng:</span>
                                <span class="text-xs sm:text-sm font-bold text-orange-600 dark:text-orange-400"
                                    id="solar-sunshine-duration">--h</span>
                            </div>
                            <span class="text-slate-300 dark:text-slate-600 text-xs sm:text-sm">|</span>
                            <!-- Precipitation Probability -->
                            <div class="flex items-center gap-1 sm:gap-1" title="X√°c su·∫•t m∆∞a hi·ªán t·∫°i">
                                <span class="text-xs sm:text-sm">üåßÔ∏è</span>
                                <span class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400">M∆∞a:</span>
                                <span class="text-xs sm:text-sm font-bold" id="solar-rain-prob">--%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Hourly Forecast Scroll -->
                    <div class="relative">
                        <div id="solarHourlyScroll"
                            class="flex gap-1.5 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-slate-300 dark:scrollbar-thumb-slate-600">
                            <!-- Hourly items will be dynamically generated -->
                            <div
                                class="solar-hour-placeholder flex-shrink-0 w-12 h-16 bg-slate-100 dark:bg-slate-700 rounded-lg animate-pulse">
                            </div>
                            <div
                                class="solar-hour-placeholder flex-shrink-0 w-12 h-16 bg-slate-100 dark:bg-slate-700 rounded-lg animate-pulse">
                            </div>
                            <div
                                class="solar-hour-placeholder flex-shrink-0 w-12 h-16 bg-slate-100 dark:bg-slate-700 rounded-lg animate-pulse">
                            </div>
                            <div
                                class="solar-hour-placeholder flex-shrink-0 w-12 h-16 bg-slate-100 dark:bg-slate-700 rounded-lg animate-pulse">
                            </div>
                            <div
                                class="solar-hour-placeholder flex-shrink-0 w-12 h-16 bg-slate-100 dark:bg-slate-700 rounded-lg animate-pulse">
                            </div>
                            <div
                                class="solar-hour-placeholder flex-shrink-0 w-12 h-16 bg-slate-100 dark:bg-slate-700 rounded-lg animate-pulse">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Energy Flow Diagram - Pro View (default) -->
                <div id="energyFlowPro" class="energy-flow-container max-w-[700px] mx-auto">
                    <!-- Row 1: C√¥ng su·∫•t PV + L∆∞·ªõi EVN -->
                    <div class="grid grid-cols-3 gap-2 sm:gap-3">
                        <!-- C√¥ng su·∫•t PV - Style amber/orange (cam v√†ng) -->
                        <div
                            class="flow-item bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/30 dark:to-orange-900/30 rounded-xl p-2.5 sm:p-3 border border-amber-300 dark:border-amber-700">
                            <div class="flex flex-col items-center text-center">
                                <div class="icon-glow-container icon-glow-pv relative" id="pv-icon-container">
                                    <div class="icon-glow-aura"></div>
                                    <!-- Animated Sun 1 (Main - always visible when power > 0) -->
                                    <picture class="sun-animated sun-main" id="sun-1">
                                        <source media="(max-width: 640px)" srcset="/icons/sun-mobile.png">
                                        <img src="/icons/sun.png" loading="lazy" alt="Sun" class="sun-icon">
                                    </picture>
                                    <!-- Animated Sun 2 (visible when power > 2000W) -->
                                    <picture class="sun-animated sun-extra sun-2" id="sun-2">
                                        <source media="(max-width: 640px)" srcset="/icons/sun-mobile.png">
                                        <img src="/icons/sun.png" loading="lazy" alt="Sun" class="sun-icon">
                                    </picture>
                                    <!-- Animated Sun 3 (visible when power > 3000W) -->
                                    <picture class="sun-animated sun-extra sun-3" id="sun-3">
                                        <source media="(max-width: 640px)" srcset="/icons/sun-mobile.png">
                                        <img src="/icons/sun.png" loading="lazy" alt="Sun" class="sun-icon">
                                    </picture>
                                    <!-- Solar Panel -->
                                    <picture class="solar-panel-img">
                                        <source media="(max-width: 640px)" srcset="/icons/solar-panel-mobile.png">
                                        <img src="/icons/solar-panel.png" loading="lazy" alt="C√¥ng su·∫•t PV"
                                            class="icon-glow-img">
                                    </picture>
                                </div>
                                <div class="text-xs font-semibold text-amber-700 dark:text-amber-300 mb-1">C√¥ng su·∫•t PV
                                </div>
                                <div class="text-lg sm:text-xl font-black text-amber-600 dark:text-amber-400"
                                    id="pv-power">--</div>
                                <div class="text-[9px] sm:text-[10px] text-amber-500 dark:text-amber-400 mt-0.5 whitespace-nowrap"
                                    id="pv-desc">--</div>
                            </div>
                        </div>

                        <!-- Kho·∫£ng tr·ªëng gi·ªØa -->
                        <div></div>

                        <!-- L∆∞·ªõi EVN - Style m√†u v√†ng tia s√©t (amber/yellow) -->
                        <div
                            class="flow-item bg-gradient-to-br from-amber-50 to-yellow-50 dark:from-amber-900/30 dark:to-yellow-900/30 rounded-xl p-2.5 sm:p-3 border border-amber-300 dark:border-amber-700">
                            <div class="flex flex-col items-center text-center">
                                <div class="icon-glow-container icon-glow-evn" id="evn-icon-container">
                                    <div class="icon-glow-aura"></div>
                                    <div class="evn-spark-container" id="evn-spark">
                                        <div class="evn-spark evn-spark-1"></div>
                                        <div class="evn-spark evn-spark-2"></div>
                                        <div class="evn-spark evn-spark-3"></div>
                                        <div class="evn-spark evn-spark-4"></div>
                                    </div>
                                    <picture>
                                        <source media="(max-width: 640px)" srcset="/icons/evn-grid-mobile.png">
                                        <img src="/icons/evn-grid.png" loading="lazy" alt="L∆∞·ªõi EVN"
                                            class="icon-glow-img">
                                    </picture>
                                </div>
                                <div class="text-xs font-semibold text-amber-700 dark:text-amber-300 mb-1">L∆∞·ªõi EVN
                                </div>
                                <div class="text-lg sm:text-xl font-black text-amber-600 dark:text-amber-400"
                                    id="grid-power">--</div>
                                <div class="text-xs sm:text-sm font-medium text-amber-500 dark:text-amber-400 mt-0.5"
                                    id="grid-voltage">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- ƒê∆∞·ªùng k·∫ª + Animation: PV xu·ªëng + EVN xu·ªëng ‚Üí Inverter -->
                    <div class="relative h-12 sm:h-14" id="flow-lines-top">
                        <div
                            class="absolute left-[16.67%] top-0 h-1/2 w-0.5 border-l-2 border-solid border-slate-400 dark:border-slate-500 -translate-x-1/2">
                        </div>
                        <div
                            class="absolute left-[83.33%] top-0 h-1/2 w-0.5 border-l-2 border-solid border-slate-400 dark:border-slate-500 -translate-x-1/2">
                        </div>
                        <div
                            class="absolute left-[16.67%] right-[16.67%] top-1/2 h-0.5 border-t-2 border-solid border-slate-400 dark:border-slate-500">
                        </div>
                        <div
                            class="absolute left-1/2 top-1/2 h-1/2 w-0.5 border-l-2 border-solid border-slate-400 dark:border-slate-500 -translate-x-1/2">
                        </div>
                        <!-- Animation dots -->
                        <!-- PV: <3000W=3 particles, >=3000W=5 particles -->
                        <div id="pv-flow-dot" class="energy-dot energy-dot-pv" style="display:none;"></div>
                        <div id="pv-flow-dot-2" class="energy-dot energy-dot-pv energy-dot-pv-2" style="display:none;">
                        </div>
                        <div id="pv-flow-dot-3" class="energy-dot energy-dot-pv energy-dot-pv-3" style="display:none;">
                        </div>
                        <div id="pv-flow-dot-4" class="energy-dot energy-dot-pv energy-dot-pv-4" style="display:none;">
                        </div>
                        <div id="pv-flow-dot-5" class="energy-dot energy-dot-pv energy-dot-pv-5" style="display:none;">
                        </div>
                        <!-- EVN: <3000W=3 particles, >=3000W=5 particles -->
                        <div id="evn-flow-dot" class="energy-dot energy-dot-evn" style="display:none;"></div>
                        <div id="evn-flow-dot-2" class="energy-dot energy-dot-evn energy-dot-evn-2"
                            style="display:none;"></div>
                        <div id="evn-flow-dot-3" class="energy-dot energy-dot-evn energy-dot-evn-3"
                            style="display:none;"></div>
                        <div id="evn-flow-dot-4" class="energy-dot energy-dot-evn energy-dot-evn-4"
                            style="display:none;"></div>
                        <div id="evn-flow-dot-5" class="energy-dot energy-dot-evn energy-dot-evn-5"
                            style="display:none;"></div>
                    </div>

                    <!-- Row 2: Bi·∫øn T·∫ßn -->
                    <div class="flex justify-center">
                        <div
                            class="flow-item w-[140px] sm:w-[160px] bg-gradient-to-br from-slate-100 to-gray-100 dark:from-slate-700 dark:to-gray-700 rounded-xl p-3 border-2 border-slate-400 dark:border-slate-500">
                            <div class="flex flex-col items-center text-center">
                                <div class="icon-glow-container icon-glow-inverter">
                                    <div class="icon-glow-aura"></div>
                                    <img src="/icons/inverter.png" loading="lazy" alt="Bi·∫øn T·∫ßn" class="icon-glow-img">
                                </div>
                                <div class="text-sm font-bold text-slate-700 dark:text-slate-200">Bi·∫øn T·∫ßn</div>
                                <div class="text-[10px] text-slate-500 dark:text-slate-400 truncate max-w-full"
                                    id="inverter-type">--</div>
                                <div class="text-sm font-semibold text-slate-600 dark:text-slate-300" id="device-temp">
                                    --</div>
                            </div>
                        </div>
                    </div>

                    <!-- ƒê∆∞·ªùng k·∫ª + Animation: Inverter ‚Üí 3 nh√°nh -->
                    <div class="relative h-12 sm:h-14" id="flow-lines-bottom">
                        <div
                            class="absolute left-1/2 top-0 h-1/2 w-0.5 border-l-2 border-solid border-slate-400 dark:border-slate-500 -translate-x-1/2">
                        </div>
                        <div
                            class="absolute left-[16.67%] right-[16.67%] top-1/2 h-0.5 border-t-2 border-solid border-slate-400 dark:border-slate-500">
                        </div>
                        <div
                            class="absolute left-[16.67%] top-1/2 h-1/2 w-0.5 border-l-2 border-solid border-slate-400 dark:border-slate-500 -translate-x-1/2">
                        </div>
                        <div
                            class="absolute left-1/2 top-1/2 h-1/2 w-0.5 border-l-2 border-solid border-slate-400 dark:border-slate-500 -translate-x-1/2">
                        </div>
                        <div
                            class="absolute left-[83.33%] top-1/2 h-1/2 w-0.5 border-l-2 border-solid border-slate-400 dark:border-slate-500 -translate-x-1/2">
                        </div>
                        <!-- Animation dots -->
                        <!-- Battery: 1000W=1, 2000W=2, 3000W=3 particles -->
                        <div id="battery-flow-dot" class="energy-dot energy-dot-battery" style="display:none;"></div>
                        <div id="battery-flow-dot-2" class="energy-dot energy-dot-battery energy-dot-battery-2"
                            style="display:none;"></div>
                        <div id="battery-flow-dot-3" class="energy-dot energy-dot-battery energy-dot-battery-3"
                            style="display:none;"></div>
                        <!-- Essential (T·∫£i c·ªïng load): 1000W=1, 2000W=2, 3000W=3 particles -->
                        <div id="essential-flow-dot" class="energy-dot energy-dot-essential" style="display:none;">
                        </div>
                        <div id="essential-flow-dot-2" class="energy-dot energy-dot-essential energy-dot-essential-2"
                            style="display:none;"></div>
                        <div id="essential-flow-dot-3" class="energy-dot energy-dot-essential energy-dot-essential-3"
                            style="display:none;"></div>
                        <!-- Load (T·∫£i h√≤a l∆∞·ªõi): 1000W=1, 2000W=2, 3000W=3 particles -->
                        <div id="load-flow-dot" class="energy-dot energy-dot-load" style="display:none;"></div>
                        <div id="load-flow-dot-2" class="energy-dot energy-dot-load energy-dot-load-2"
                            style="display:none;"></div>
                        <div id="load-flow-dot-3" class="energy-dot energy-dot-load energy-dot-load-3"
                            style="display:none;"></div>
                    </div>

                    <!-- Row 3: Pin, T·∫£i c·ªïng load, T·∫£i h√≤a l∆∞·ªõi -->
                    <div class="grid grid-cols-3 gap-2 sm:gap-3">
                        <!-- Pin l∆∞u tr·ªØ - Style gi·ªëng T·∫£i h√≤a l∆∞·ªõi (emerald) -->
                        <div
                            class="flow-item bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/30 dark:to-green-900/30 rounded-xl p-2.5 sm:p-3 border border-emerald-300 dark:border-emerald-700">
                            <div class="flex flex-col items-center text-center">
                                <div class="icon-glow-container icon-glow-battery mb-1">
                                    <div class="icon-glow-aura"></div>
                                    <div class="battery-icon-wrapper">
                                        <div
                                            class="w-12 h-7 sm:w-14 sm:h-8 rounded-md border-2 border-emerald-500 dark:border-emerald-600 relative overflow-hidden bg-white dark:bg-slate-700">
                                            <div id="battery-fill"
                                                class="absolute left-0 top-0 bottom-0 bg-emerald-500 transition-all duration-500"
                                                style="width: 0%"></div>
                                            <span id="battery-percent-icon"
                                                class="absolute inset-0 flex items-center justify-center text-xs sm:text-sm font-black text-slate-700 dark:text-white z-10">--%</span>
                                        </div>
                                        <div class="w-1 h-3 bg-emerald-500 dark:bg-emerald-600 rounded-r-sm"></div>
                                    </div>
                                </div>
                                <div class="text-xs font-semibold text-emerald-700 dark:text-emerald-300 mb-1">Pin l∆∞u
                                    tr·ªØ</div>
                                <div id="battery-power"
                                    class="text-base sm:text-lg font-black text-emerald-600 dark:text-emerald-400">--
                                </div>
                                <div
                                    class="flex items-center gap-1.5 text-[11px] sm:text-xs text-emerald-600 dark:text-emerald-400 font-semibold">
                                    <span id="battery-current-pro">--A</span>
                                    <span class="text-emerald-400 dark:text-emerald-600">|</span>
                                    <span id="battery-voltage-pro">--V</span>
                                </div>
                                <div id="battery-status-text"
                                    class="text-xs sm:text-sm font-semibold text-emerald-500 dark:text-emerald-400 mt-0.5 truncate max-w-full">
                                    --</div>
                            </div>
                        </div>

                        <!-- T·∫£i c·ªïng load -->
                        <div
                            class="flow-item bg-gradient-to-br from-cyan-50 to-blue-50 dark:from-cyan-900/30 dark:to-blue-900/30 rounded-xl p-2.5 sm:p-3 border border-cyan-300 dark:border-cyan-700">
                            <div class="flex flex-col items-center text-center">
                                <div class="icon-glow-container icon-glow-essential">
                                    <div class="icon-glow-aura"></div>
                                    <img src="/icons/backup.png" loading="lazy" alt="T·∫£i c·ªïng load"
                                        class="icon-glow-img">
                                </div>
                                <div class="text-xs font-semibold text-cyan-700 dark:text-cyan-300 mb-1">T·∫£i c·ªïng load
                                </div>
                                <div class="text-base sm:text-lg font-black text-cyan-600 dark:text-cyan-400"
                                    id="essential-power">--</div>
                            </div>
                        </div>

                        <!-- T·∫£i h√≤a l∆∞·ªõi -->
                        <div
                            class="flow-item bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/30 dark:to-green-900/30 rounded-xl p-2.5 sm:p-3 border border-emerald-300 dark:border-emerald-700">
                            <div class="flex flex-col items-center text-center">
                                <div class="icon-glow-container icon-glow-load">
                                    <div class="icon-glow-aura"></div>
                                    <picture>
                                        <source media="(max-width: 640px)" srcset="/icons/grid-export-mobile.png">
                                        <img src="/icons/grid-export.png" loading="lazy" alt="T·∫£i h√≤a l∆∞·ªõi"
                                            class="icon-glow-img">
                                    </picture>
                                </div>
                                <div class="text-xs font-semibold text-emerald-700 dark:text-emerald-300 mb-1">T·∫£i h√≤a
                                    l∆∞·ªõi</div>
                                <div class="text-base sm:text-lg font-black text-emerald-600 dark:text-emerald-400"
                                    id="load-power">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Energy Flow Diagram - Basic View (hidden by default) -->
                <div id="energyFlowBasic" class="hidden">
                    <div class="grid grid-cols-3 gap-2 sm:gap-3">
                        <!-- Row 1: PV, Inverter, Grid -->
                        <div
                            class="flow-item bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-xl p-2.5 sm:p-3 border border-amber-200 dark:border-amber-800">
                            <div class="flex flex-col items-center">
                                <div class="w-12 h-12 sm:w-14 sm:h-14 mb-1.5 flex items-center justify-center">
                                    <img src="/icons/solar-panel.png" alt="T·∫•m Pin"
                                        class="w-full h-full object-contain drop-shadow-md">
                                </div>
                                <div class="text-xs font-semibold text-amber-700 dark:text-amber-300 text-center">T·∫•m
                                    Pin</div>
                                <div class="text-base sm:text-lg font-black text-amber-600 dark:text-amber-400"
                                    id="pv-power-basic">--</div>
                                <div class="text-[9px] sm:text-[10px] text-amber-500 dark:text-amber-400 mt-0.5 whitespace-nowrap"
                                    id="pv-desc-basic">--</div>
                            </div>
                        </div>

                        <div
                            class="flow-item bg-gradient-to-br from-cyan-50 to-blue-50 dark:from-cyan-900/20 dark:to-blue-900/20 rounded-xl p-2.5 sm:p-3 border border-cyan-200 dark:border-cyan-800">
                            <div class="flex flex-col items-center">
                                <div class="w-12 h-12 sm:w-14 sm:h-14 mb-1.5 flex items-center justify-center">
                                    <img src="/icons/inverter.png" loading="lazy" alt="Inverter"
                                        class="w-full h-full object-contain drop-shadow-md">
                                </div>
                                <div class="text-xs sm:text-sm font-bold text-cyan-700 dark:text-cyan-300 truncate max-w-full"
                                    id="inverter-type-basic">Lumentree Inverter</div>
                                <div class="text-xs sm:text-sm font-medium text-slate-500 dark:text-slate-400"
                                    id="device-temp-basic">--</div>
                            </div>
                        </div>

                        <div
                            class="flow-item bg-gradient-to-br from-amber-50 to-yellow-50 dark:from-amber-900/30 dark:to-yellow-900/30 rounded-xl p-2.5 sm:p-3 border border-amber-300 dark:border-amber-700">
                            <div class="flex flex-col items-center">
                                <div class="w-12 h-12 sm:w-14 sm:h-14 mb-1.5 flex items-center justify-center relative"
                                    id="evn-icon-container-basic">
                                    <div class="evn-spark-container" id="evn-spark-basic">
                                        <div class="evn-spark evn-spark-1"></div>
                                        <div class="evn-spark evn-spark-2"></div>
                                        <div class="evn-spark evn-spark-3"></div>
                                        <div class="evn-spark evn-spark-4"></div>
                                    </div>
                                    <picture>
                                        <source media="(max-width: 640px)" srcset="/icons/evn-grid-mobile.png">
                                        <img src="/icons/evn-grid.png" loading="lazy" alt="L∆∞·ªõi EVN"
                                            class="w-full h-full object-contain drop-shadow-md">
                                    </picture>
                                </div>
                                <div class="text-xs font-semibold text-amber-700 dark:text-amber-300 text-center">L∆∞·ªõi
                                    EVN</div>
                                <div class="text-base sm:text-lg font-black text-amber-600 dark:text-amber-400"
                                    id="grid-power-basic">--</div>
                                <div class="text-[10px] text-amber-500 dark:text-amber-400" id="grid-voltage-basic">--
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Battery, Essential, Load -->
                        <div
                            class="flow-item bg-gradient-to-br from-slate-50 to-gray-50 dark:from-slate-800 dark:to-gray-800 rounded-xl p-2.5 sm:p-3 border border-slate-200 dark:border-slate-700">
                            <div class="flex flex-col items-center">
                                <div class="w-14 h-8 sm:w-16 sm:h-9 mb-1.5 flex items-center justify-center relative">
                                    <div
                                        class="w-12 h-7 sm:w-14 sm:h-8 rounded-md border-2 border-slate-400 dark:border-slate-500 relative overflow-hidden bg-white dark:bg-slate-700">
                                        <div id="battery-fill-basic"
                                            class="absolute left-0 top-0 bottom-0 bg-green-500 transition-all duration-500"
                                            style="width: 0%"></div>
                                        <span id="battery-percent-basic"
                                            class="absolute inset-0 flex items-center justify-center text-xs sm:text-sm font-black text-slate-700 dark:text-white z-10">--%</span>
                                    </div>
                                    <div class="w-1 h-3 bg-slate-400 dark:bg-slate-500 rounded-r-sm"></div>
                                </div>
                                <div class="text-xs font-semibold text-slate-600 dark:text-slate-300 text-center">Pin
                                </div>
                                <div id="battery-power-basic"
                                    class="text-base sm:text-lg font-black text-slate-700 dark:text-slate-300">--</div>
                                <div
                                    class="flex items-center gap-1.5 text-[11px] sm:text-xs text-slate-600 dark:text-slate-300 font-semibold">
                                    <span id="battery-current-basic">--A</span>
                                    <span class="text-slate-400 dark:text-slate-600">|</span>
                                    <span id="battery-voltage-basic">--V</span>
                                </div>
                                <div id="battery-status-basic"
                                    class="text-xs font-medium truncate max-w-full text-slate-500 dark:text-slate-400">
                                    --</div>
                            </div>
                        </div>

                        <div
                            class="flow-item bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-indigo-900/20 dark:to-blue-900/20 rounded-xl p-2.5 sm:p-3 border border-indigo-200 dark:border-indigo-800">
                            <div class="flex flex-col items-center">
                                <div class="w-12 h-12 sm:w-14 sm:h-14 mb-1.5 flex items-center justify-center">
                                    <img src="/icons/backup.png" loading="lazy" alt="T·∫£i c·ªïng load"
                                        class="w-full h-full object-contain drop-shadow-md">
                                </div>
                                <div class="text-xs font-semibold text-indigo-700 dark:text-indigo-300 text-center">T·∫£i
                                    c·ªïng load</div>
                                <div class="text-base sm:text-lg font-black text-indigo-600 dark:text-indigo-400"
                                    id="essential-power-basic">--</div>
                            </div>
                        </div>

                        <div
                            class="flow-item bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/20 dark:to-green-900/20 rounded-xl p-2.5 sm:p-3 border border-emerald-200 dark:border-emerald-800">
                            <div class="flex flex-col items-center">
                                <div class="w-12 h-12 sm:w-14 sm:h-14 mb-1.5 flex items-center justify-center">
                                    <picture>
                                        <source media="(max-width: 640px)" srcset="/icons/grid-export-mobile.png">
                                        <img src="/icons/grid-export.png" loading="lazy" alt="T·∫£i h√≤a l∆∞·ªõi"
                                            class="w-full h-full object-contain drop-shadow-md">
                                    </picture>
                                </div>
                                <div class="text-xs font-semibold text-emerald-700 dark:text-emerald-300 text-center">
                                    T·∫£i h√≤a l∆∞·ªõi</div>
                                <div class="text-base sm:text-lg font-black text-emerald-600 dark:text-emerald-400"
                                    id="load-power-basic">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3D Home View (hidden by default) -->
                <div id="energyFlow3DHome" class="hidden">
                    <div class="relative mx-auto" style="max-width: 500px;">

                        <!-- Top Row: PV Source (Left) | Sun/Moon (Center) | Grid EVN (Right) - OUTSIDE image -->
                        <div class="grid grid-cols-3 gap-2 items-end mb-0 px-1 -mt-4 sm:-mt-6">
                            <!-- PV Source Box (Left) - Gradient amber/yellow gi·ªëng Pro view -->
                            <div
                                class="bg-gradient-to-br from-amber-50 to-yellow-50 dark:from-amber-900/40 dark:to-yellow-900/40 backdrop-blur rounded-xl p-2 sm:p-2.5 border border-amber-400 dark:border-amber-500/50 shadow-lg">
                                <div class="text-center mb-1">
                                    <span
                                        class="text-[10px] sm:text-[10px] font-bold text-amber-700 dark:text-amber-300 uppercase tracking-wider">Ngu·ªìn
                                        PV</span>
                                </div>
                                <div class="text-center mb-1.5">
                                    <span id="pv-power-3d"
                                        class="text-2xl sm:text-2xl font-black text-amber-600 dark:text-amber-400 drop-shadow-lg">--W</span>
                                </div>
                                <!-- PV1/PV2 ƒë∆°n gi·∫£n - m√†u amber gi·ªëng Pro - INNER FRAME -->
                                <div
                                    class="bg-amber-100/60 dark:bg-black/20 rounded-lg p-1.5 px-2 sm:px-2 border border-amber-400/40 dark:border-amber-400/20">
                                    <div class="flex justify-center items-stretch gap-2 sm:gap-1.5 text-center">
                                        <div
                                            class="pr-2 sm:pr-1.5 border-r-2 border-amber-500/60 dark:border-amber-400/50">
                                            <div
                                                class="text-[9px] sm:text-[9px] text-amber-600/70 dark:text-amber-200/70 font-semibold">
                                                PV1</div>
                                            <div id="pv1-power-3d"
                                                class="text-xs sm:text-xs font-bold text-amber-600 dark:text-amber-400">
                                                --W
                                            </div>
                                            <div id="pv1-voltage-3d"
                                                class="text-[10px] sm:text-[11px] font-semibold text-amber-500 dark:text-amber-300">
                                                --V</div>
                                        </div>
                                        <div>
                                            <div
                                                class="text-[9px] sm:text-[9px] text-amber-600/70 dark:text-amber-200/70 font-semibold">
                                                PV2</div>
                                            <div id="pv2-power-3d"
                                                class="text-xs sm:text-xs font-bold text-amber-600 dark:text-amber-400">
                                                --W
                                            </div>
                                            <div id="pv2-voltage-3d"
                                                class="text-[10px] sm:text-[11px] font-semibold text-amber-500 dark:text-amber-300">
                                                --V</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sun/Moon Animation (Center) -->
                            <div class="flex items-center justify-center">
                                <div class="relative w-16 h-16 sm:w-20 sm:h-20">
                                    <!-- Sun (shown when PV > 0) -->
                                    <div id="sun-3d"
                                        class="absolute inset-0 flex items-center justify-center transition-all duration-500">
                                        <div class="sun-3d-container">
                                            <div class="sun-3d-core"></div>
                                            <div class="sun-3d-rays"></div>
                                            <div class="sun-3d-glow"></div>
                                        </div>
                                    </div>
                                    <!-- Moon (shown when PV = 0) -->
                                    <div id="moon-3d"
                                        class="absolute inset-0 flex items-center justify-center hidden transition-all duration-500">
                                        <div class="moon-3d-container">
                                            <div class="moon-3d-core"></div>
                                            <div class="moon-3d-crater moon-3d-crater-1"></div>
                                            <div class="moon-3d-crater moon-3d-crater-2"></div>
                                            <div class="moon-3d-crater moon-3d-crater-3"></div>
                                            <div class="moon-3d-glow"></div>
                                            <div class="stars-container">
                                                <div class="star star-1"></div>
                                                <div class="star star-2"></div>
                                                <div class="star star-3"></div>
                                                <div class="star star-4"></div>
                                                <div class="star star-5"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Grid EVN Box (Right) - Gradient amber/yellow gi·ªëng Pro view -->
                            <div
                                class="bg-gradient-to-br from-amber-50 to-yellow-50 dark:from-amber-900/40 dark:to-yellow-900/40 backdrop-blur rounded-xl p-2 sm:p-2.5 border border-amber-400 dark:border-amber-500/50 shadow-lg">
                                <div class="text-center mb-1">
                                    <span
                                        class="text-[10px] sm:text-[10px] font-bold text-amber-700 dark:text-amber-300 uppercase tracking-wider">L∆∞·ªõi
                                        EVN</span>
                                </div>
                                <div class="text-center">
                                    <div
                                        class="w-7 h-7 sm:w-7 sm:h-7 mx-auto mb-0.5 rounded-lg bg-amber-400/30 dark:bg-amber-500/20 flex items-center justify-center border border-amber-500/50 dark:border-amber-500/40">
                                        <svg class="w-4 h-4 text-amber-600 dark:text-amber-400" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                    <span id="grid-power-3d"
                                        class="text-xl sm:text-xl font-black text-amber-600 dark:text-amber-400 drop-shadow-lg">--W</span>
                                </div>
                                <!-- EVN Voltage - INNER FRAME -->
                                <div id="grid-inner-frame-3d"
                                    class="bg-amber-100/60 dark:bg-black/20 rounded-lg p-1.5 px-2 border border-amber-400/40 dark:border-amber-400/20 mt-1 text-center">
                                    <span id="grid-voltage-3d"
                                        class="text-sm sm:text-base font-bold text-amber-500 dark:text-amber-300">--V</span>
                                </div>
                            </div>
                        </div>

                        <!-- Energy Flow Lines Container - Ng·∫Øn h∆°n ƒë·ªÉ cards l√™n cao -->
                        <div class="relative h-8 sm:h-10">
                            <!-- PV Energy Flow Line (Left) - z-30 n·∫±m tr√™n ·∫£nh, ng·∫Øn h∆°n tr√™n PC -->
                            <div id="pv-energy-line"
                                class="pv-energy-line absolute left-[16.5%] top-0 h-16 sm:h-20 z-30">
                                <!-- Energy particles flowing down -->
                                <div class="energy-particle"></div>
                                <div class="energy-particle"></div>
                                <div class="energy-particle"></div>

                                <!-- Ti·∫øp ƒëi·ªÉm tr√≤n ·ªü cu·ªëi ƒë∆∞·ªùng line (gi·ªØa t·∫•m pin) -->
                                <div
                                    class="energy-endpoint absolute -bottom-1 left-1/2 -translate-x-1/2 w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-amber-400 border-2 border-amber-300 shadow-[0_0_10px_#fbbf24,0_0_20px_rgba(251,191,36,0.5)]">
                                    <div class="absolute inset-0.5 rounded-full bg-amber-200"></div>
                                </div>
                            </div>

                            <!-- EVN Grid Energy Flow Line (Right) - z-0 n·∫±m sau m√°i nh√†, d√†i xu·ªëng ƒë·∫øn ·∫£nh -->
                            <!-- Light mode: shorter line (h-32), Dark mode: longer line (dark:h-48 sm:dark:h-56) -->
                            <div id="evn-energy-line"
                                class="evn-energy-line absolute right-[16.5%] top-0 h-32 sm:h-40 z-0">
                                <!-- Energy particles - controlled by JS based on power level -->
                                <div class="evn-energy-particle" data-particle="1"></div>
                                <div class="evn-energy-particle" data-particle="2"></div>
                                <div class="evn-energy-particle" data-particle="3"></div>

                                <!-- Ti·∫øp ƒëi·ªÉm tr√≤n ·ªü cu·ªëi -->
                                <div
                                    class="evn-endpoint absolute -bottom-1 left-1/2 -translate-x-1/2 w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-amber-400 border-2 border-amber-300 shadow-[0_0_10px_#fbbf24,0_0_20px_rgba(251,191,36,0.5)]">
                                    <div class="absolute inset-0.5 rounded-full bg-amber-200"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 3D House Image with battery overlay -->
                        <div class="relative -mt-24 sm:-mt-28">
                            <img id="house3dImage" src="/images/3dhome/house-3d-dark.png" alt="3D Solar Home"
                                class="w-full h-auto object-contain transition-opacity duration-300">

                            <!-- Battery SOC % (on battery) - d·ªãch xu·ªëng 1 ch√∫t -->
                            <div class="absolute left-[8%] top-[52%] z-20">
                                <div class="flex items-center gap-1">
                                    <div id="battery-status-icon-3d" class="hidden">
                                        <svg id="battery-charging-3d"
                                            class="w-5 h-5 text-emerald-400 animate-bounce hidden" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M5 10l7-7m0 0l7 7m-7-7v18" />
                                        </svg>
                                        <svg id="battery-discharging-3d"
                                            class="w-5 h-5 text-orange-400 animate-bounce hidden" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                                        </svg>
                                    </div>
                                    <span id="battery-soc-3d"
                                        class="text-2xl sm:text-3xl font-black text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.9)]">--%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Stats Cards - 3 columns: Pin s·∫°c/x·∫£ | T·∫£i c·ªïng load | T·∫£i ti√™u th·ª• -->
                        <div class="-mt-10 grid grid-cols-3 gap-2.5 relative z-10 px-1">
                            <!-- 1. Battery Card - Design gi·ªëng ƒëi·ªán tho·∫°i v·ªõi % pin - C√ÇN ƒê·ªêI CHI·ªÄU CAO -->
                            <div id="battery-card-3d"
                                class="battery-heat-card bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-slate-800/90 dark:to-slate-800/90 backdrop-blur rounded-xl p-3 text-center border border-emerald-400 dark:border-emerald-500/30 shadow-lg flex flex-col items-center transition-all duration-300">
                                <!-- Battery icon - container c√πng chi·ªÅu cao v·ªõi icon cards kh√°c -->
                                <div class="w-12 h-12 sm:w-14 sm:h-14 mb-2 flex items-center justify-center">
                                    <div class="battery-phone-icon relative">
                                        <!-- Battery body - Light mode: n·ªÅn t·ªëi, ch·ªØ tr·∫Øng cho d·ªÖ ƒë·ªçc -->
                                        <div id="battery-body-3d"
                                            class="w-16 h-7 sm:w-20 sm:h-8 rounded-[5px] border-2 border-emerald-500 dark:border-emerald-400 relative overflow-hidden bg-slate-800 dark:bg-slate-900/80">
                                            <div id="battery-fill-3d"
                                                class="absolute left-0.5 top-0.5 bottom-0.5 rounded-[3px] bg-gradient-to-r from-emerald-500 to-emerald-400 dark:from-emerald-500 dark:to-emerald-500 transition-all duration-500"
                                                style="width: 0%"></div>
                                            <span id="battery-percent-3d-icon"
                                                class="absolute inset-0 flex items-center justify-center text-sm sm:text-base font-black text-white z-10">--%</span>
                                        </div>
                                        <!-- Battery cap -->
                                        <div id="battery-cap-3d"
                                            class="absolute -right-1.5 top-1/2 -translate-y-1/2 w-1.5 h-4 sm:h-5 bg-emerald-500 dark:bg-emerald-400 rounded-r-sm">
                                        </div>
                                    </div>
                                </div>
                                <!-- Power value -->
                                <div id="battery-power-3d"
                                    class="text-xl sm:text-2xl font-black text-emerald-600 dark:text-emerald-400 leading-tight">
                                    --W</div>
                                <!-- Status Label (ƒë·ªông) - N·∫±m d∆∞·ªõi W -->
                                <div id="battery-status-label-3d"
                                    class="text-xs sm:text-[10px] text-emerald-600 dark:text-emerald-400 mt-0.5 font-semibold text-center">
                                    Pin s·∫°c/x·∫£</div>
                                <!-- Battery Voltage & Current - INNER FRAME (A|V only) -->
                                <div id="battery-inner-frame-3d"
                                    class="battery-inner-frame bg-emerald-100/60 dark:bg-black/20 rounded-lg p-2 px-3 sm:p-1.5 sm:px-2 border border-emerald-400/40 dark:border-emerald-400/20 mt-1">
                                    <div
                                        class="flex items-center justify-center gap-2 sm:gap-1.5 text-base sm:text-sm text-emerald-600 dark:text-emerald-400 font-bold">
                                        <span id="battery-current-3d"
                                            class="pr-2 sm:pr-1.5 border-r-2 sm:border-r border-emerald-500/50 dark:border-emerald-400/40">--A</span>
                                        <span id="battery-voltage-3d">--V</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. Essential Load Card - Mobile optimized v·ªõi picture srcset -->
                            <div id="essential-card-3d"
                                class="essential-heat-card bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-slate-800/90 dark:to-slate-800/90 backdrop-blur rounded-xl p-3 text-center border border-emerald-400 dark:border-emerald-500/30 shadow-lg flex flex-col items-center transition-all duration-300">
                                <div class="w-12 h-12 sm:w-14 sm:h-14 mb-2 flex items-center justify-center">
                                    <picture>
                                        <source media="(max-width: 640px)" srcset="/icons/essential-load-3d-mobile.png">
                                        <img id="essential-icon-3d" src="/icons/essential-load-3d.png" loading="lazy"
                                            alt="T·∫£i c·ªïng load"
                                            class="w-11 h-11 sm:w-12 sm:h-12 object-contain drop-shadow-[0_2px_4px_rgba(16,185,129,0.3)] transition-all duration-300">
                                    </picture>
                                </div>
                                <div id="essential-power-3d"
                                    class="text-xl sm:text-2xl font-black text-emerald-600 dark:text-emerald-400 leading-tight">
                                    --W</div>
                                <div class="text-xs sm:text-sm text-emerald-600 dark:text-emerald-400 mt-1 font-medium">
                                    T·∫£i c·ªïng load</div>
                            </div>

                            <!-- 3. Load Card - Mobile optimized -->
                            <div id="load-card-3d"
                                class="load-heat-card bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-slate-800/90 dark:to-slate-800/90 backdrop-blur rounded-xl p-3 text-center border border-emerald-400 dark:border-emerald-500/30 shadow-lg flex flex-col items-center relative overflow-hidden transition-all duration-300">
                                <div class="w-12 h-12 sm:w-14 sm:h-14 mb-2 flex items-center justify-center">
                                    <!-- Light mode icon -->
                                    <img id="load-icon-3d-light" src="/icons/grid-load-3d-light.png" loading="lazy"
                                        alt="T·∫£i ti√™u th·ª•" class="w-11 h-11 sm:w-12 sm:h-12 object-contain dark:hidden">
                                    <!-- Dark mode icon -->
                                    <picture class="hidden dark:block">
                                        <source media="(max-width: 640px)" srcset="/icons/grid-load-3d-mobile.png">
                                        <img id="load-icon-3d" src="/icons/grid-load-3d.png" loading="lazy"
                                            alt="T·∫£i ti√™u th·ª•"
                                            class="w-11 h-11 sm:w-12 sm:h-12 object-contain drop-shadow-[0_2px_4px_rgba(16,185,129,0.3)]">
                                    </picture>
                                </div>
                                <div id="load-power-3d"
                                    class="text-xl sm:text-2xl font-black text-emerald-600 dark:text-emerald-400 leading-tight">
                                    --W</div>
                                <!-- Label n·∫±m d∆∞·ªõi W -->
                                <div id="load-label-3d"
                                    class="text-xs sm:text-[10px] text-amber-600 dark:text-amber-400 mt-0.5 font-semibold text-center">
                                    T·∫£i ti√™u th·ª•</div>
                                <!-- Load Voltage - INNER FRAME (V only) -->
                                <div id="load-inner-frame-3d"
                                    class="load-inner-frame bg-amber-100/60 dark:bg-black/20 rounded-lg p-2 px-3 sm:p-1.5 sm:px-2 border border-amber-400/40 dark:border-amber-400/20 mt-1">
                                    <div id="load-voltage-3d"
                                        class="text-base sm:text-sm text-amber-600 dark:text-amber-400 font-bold text-center">
                                        --V</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Battery Cell Section -->
        <div id="batteryCellSection" class="hidden mb-4">
            <div
                class="bg-white/95 dark:bg-slate-800/50 backdrop-blur-md rounded-xl border-2 border-teal-200 dark:border-teal-800/50 shadow-lg overflow-hidden">
                <div id="cellSectionHeader"
                    class="p-3 bg-gradient-to-r from-teal-50 to-cyan-50 dark:from-teal-900/30 dark:to-cyan-900/30 border-b border-teal-200 dark:border-teal-800 cursor-pointer hover:bg-teal-100/50 dark:hover:bg-teal-900/40 transition-colors">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div
                                class="w-9 h-9 bg-gradient-to-br from-teal-400 to-cyan-500 rounded-lg flex items-center justify-center shadow-lg">
                                <i data-lucide="battery" class="w-4 h-4 text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-sm font-bold text-slate-800 dark:text-white">ƒêi·ªán √Åp Cell Pin</h2>
                                <p class="text-[10px] text-teal-600 dark:text-teal-400 font-medium">Gi√°m s√°t t·ª´ng cell
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="cellCountBadge"
                                class="bg-teal-500 text-white px-2 py-0.5 rounded-full text-[10px] font-bold">--
                                cell</span>
                            <span id="cellUpdateTime"
                                class="text-[9px] text-slate-500 dark:text-slate-400">--:--:--</span>
                            <button id="reloadCellBtn"
                                class="p-1.5 bg-teal-500 hover:bg-teal-600 text-white rounded-lg transition-colors"
                                title="T·∫£i l·∫°i d·ªØ li·ªáu cell">
                                <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
                            </button>
                            <div class="flex items-center gap-1 px-2 py-1 bg-white dark:bg-slate-700 rounded-lg shadow">
                                <span class="text-[10px] font-medium text-slate-600 dark:text-slate-300"
                                    id="toggleText">·∫®n</span>
                                <i data-lucide="chevron-up" class="w-4 h-4 text-teal-500 transition-transform"
                                    id="toggleIcon"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="cellSectionContent" class="p-3">
                    <div class="grid grid-cols-5 gap-2 mb-3">
                        <div
                            class="bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900/40 dark:to-indigo-900/40 rounded-lg p-2 text-center border border-blue-200 dark:border-blue-700">
                            <div class="text-[8px] font-bold text-blue-600 dark:text-blue-400 uppercase">ƒêi·ªán √Åp Pin
                            </div>
                            <div class="text-sm sm:text-lg font-black text-blue-700 dark:text-blue-300"
                                id="batteryVoltageDisplay">--</div>
                        </div>
                        <div
                            class="bg-gradient-to-br from-teal-100 to-cyan-100 dark:from-teal-900/40 dark:to-cyan-900/40 rounded-lg p-2 text-center border border-teal-200 dark:border-teal-700">
                            <div class="text-[8px] font-bold text-teal-600 dark:text-teal-400 uppercase">Trung B√¨nh
                            </div>
                            <div class="text-sm sm:text-lg font-black text-teal-700 dark:text-teal-300" id="cellAvg">--
                            </div>
                        </div>
                        <div
                            class="bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900/40 dark:to-indigo-900/40 rounded-lg p-2 text-center border border-blue-300 dark:border-blue-600">
                            <div class="text-[8px] font-bold text-blue-600 dark:text-blue-400 uppercase">Cao Nh·∫•t Hi·ªán
                                T·∫°i</div>
                            <div class="text-sm sm:text-lg font-black text-blue-700 dark:text-blue-300" id="cellMax">--
                            </div>
                        </div>
                        <div
                            class="bg-gradient-to-br from-amber-100 to-yellow-100 dark:from-amber-900/40 dark:to-yellow-900/40 rounded-lg p-2 text-center border border-amber-200 dark:border-amber-700">
                            <div class="text-[8px] font-bold text-amber-600 dark:text-amber-400 uppercase">Th·∫•p Nh·∫•t
                                Hi·ªán T·∫°i</div>
                            <div class="text-sm sm:text-lg font-black text-amber-700 dark:text-amber-300" id="cellMin">
                                --</div>
                        </div>
                        <div
                            class="bg-gradient-to-br from-rose-100 to-red-100 dark:from-rose-900/40 dark:to-red-900/40 rounded-lg p-2 text-center border border-rose-200 dark:border-rose-700">
                            <div class="text-[8px] font-bold text-rose-600 dark:text-rose-400 uppercase">ƒê·ªô L·ªách</div>
                            <div class="text-sm sm:text-lg font-black" id="cellDiffValue">--</div>
                        </div>
                    </div>

                    <div
                        class="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-2 sm:p-3 border border-slate-200 dark:border-slate-700">
                        <div id="cellGrid">
                            <div
                                class="cell-placeholder bg-slate-100 dark:bg-slate-800 rounded-lg h-16 flex items-center justify-center">
                                <span class="text-slate-400 text-xs">ƒêang ch·ªù d·ªØ li·ªáu cell...</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-center justify-center gap-3 mt-3">
                        <div class="flex items-center gap-1.5">
                            <div class="w-4 h-4 bg-gradient-to-br from-blue-400 to-blue-600 rounded"></div>
                            <span class="text-slate-600 dark:text-slate-400 font-medium text-[10px]">T·ªët
                                (&lt;0.020V)</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-4 h-4 bg-gradient-to-br from-amber-400 to-amber-600 rounded"></div>
                            <span class="text-slate-600 dark:text-slate-400 font-medium text-[10px]">Kh√° (0.020V -
                                0.050V)</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-4 h-4 bg-gradient-to-br from-red-400 to-red-600 rounded"></div>
                            <span class="text-slate-600 dark:text-slate-400 font-medium text-[10px]">C·∫£nh b√°o
                                (&gt;0.050V)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- D·ªÆ LI·ªÜU TRONG NG√ÄY + SOC - Combined Section -->
        <div id="summaryStats" class="hidden mb-4">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg overflow-hidden border-l-4 border-teal-500">
                <!-- Section Header -->
                <div
                    class="p-3 sm:p-4 bg-gradient-to-r from-teal-50 to-cyan-50 dark:from-teal-900/30 dark:to-cyan-900/30 border-b border-teal-200 dark:border-teal-700">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div
                                class="w-9 h-9 bg-gradient-to-br from-teal-400 to-cyan-500 rounded-lg flex items-center justify-center shadow-lg">
                                <i data-lucide="calendar-days" class="w-4 h-4 text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-sm sm:text-base font-bold text-slate-800 dark:text-white">D·ªØ Li·ªáu Trong
                                    Ng√†y</h2>
                                <p class="text-[11px] sm:text-xs text-teal-600 dark:text-teal-400 font-medium">NƒÉng
                                    l∆∞·ª£ng ‚Ä¢ Pin ‚Ä¢ Ngu·ªìn ƒëi·ªán ‚Ä¢ SOC</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="soc-last-update" class="text-[9px] text-slate-400 dark:text-slate-500"></span>
                            <span class="flex items-center gap-1 text-[10px] text-emerald-600 dark:text-emerald-400">
                                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                                Live
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="p-3 sm:p-4 space-y-4">
                    <!-- 3 Data Cards Row -->
                    <div class="grid grid-cols-3 gap-1.5 sm:gap-3">
                        <!-- Card 1: S·∫£n L∆∞·ª£ng PV + Ti√™u Th·ª• -->
                        <div id="pv-load-card"
                            class="cursor-pointer bg-gradient-to-br from-teal-500 to-teal-600 dark:from-slate-700 dark:to-slate-900 rounded-xl sm:rounded-2xl p-2.5 sm:p-4 shadow-lg hover:scale-[1.02] transition-all">
                            <div class="flex items-center gap-1 sm:gap-2 mb-1.5 sm:mb-2">
                                <div
                                    class="w-6 h-6 sm:w-8 sm:h-8 bg-white/20 rounded-md sm:rounded-lg flex items-center justify-center">
                                    <i data-lucide="sun" class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-white"></i>
                                </div>
                                <div class="text-white/90 text-sm sm:text-base font-bold">NƒÉng L∆∞·ª£ng</div>
                            </div>
                            <div class="space-y-1.5 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-3">
                                <div class="bg-white/10 rounded-md sm:rounded-lg p-2 sm:p-2 text-center">
                                    <div class="text-white/70 text-[11px] sm:text-xs font-medium">S·∫£n L∆∞·ª£ng PV</div>
                                    <div id="pv-total" class="text-base sm:text-lg font-black text-white">--</div>
                                </div>
                                <div class="bg-white/10 rounded-md sm:rounded-lg p-2 sm:p-2 text-center">
                                    <div class="text-white/70 text-[11px] sm:text-xs font-medium">Ti√™u Th·ª•</div>
                                    <div id="load-total" class="text-base sm:text-lg font-black text-white">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Card 2: N·∫°p Pin + X·∫£ Pin -->
                        <div id="bat-card"
                            class="cursor-pointer bg-gradient-to-br from-emerald-500 to-emerald-600 dark:from-slate-700 dark:to-slate-900 rounded-xl sm:rounded-2xl p-2.5 sm:p-4 shadow-lg hover:scale-[1.02] transition-all">
                            <div class="flex items-center gap-1 sm:gap-2 mb-1.5 sm:mb-2">
                                <div
                                    class="w-6 h-6 sm:w-8 sm:h-8 bg-white/20 rounded-md sm:rounded-lg flex items-center justify-center">
                                    <i data-lucide="battery-charging" class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-white"></i>
                                </div>
                                <div class="text-white/90 text-sm sm:text-base font-bold">Pin L∆∞u Tr·ªØ</div>
                            </div>
                            <div class="space-y-1.5 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-3">
                                <div class="bg-white/10 rounded-md sm:rounded-lg p-2 sm:p-2 text-center">
                                    <div class="text-white/70 text-[11px] sm:text-xs font-medium">N·∫°p Pin</div>
                                    <div id="bat-charge" class="text-base sm:text-lg font-black text-emerald-300">--
                                    </div>
                                </div>
                                <div class="bg-white/10 rounded-md sm:rounded-lg p-2 sm:p-2 text-center">
                                    <div class="text-white/70 text-[11px] sm:text-xs font-medium">X·∫£ Pin</div>
                                    <div id="bat-discharge" class="text-base sm:text-lg font-black text-rose-300">--
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Card 3: ƒêi·ªán EVN + ƒêi·ªán D·ª± Ph√≤ng -->
                        <div id="grid-essential-card"
                            class="cursor-pointer bg-gradient-to-br from-indigo-500 to-indigo-600 dark:from-slate-700 dark:to-slate-900 rounded-xl sm:rounded-2xl p-2.5 sm:p-4 shadow-lg hover:scale-[1.02] transition-all">
                            <div class="flex items-center gap-1 sm:gap-2 mb-1.5 sm:mb-2">
                                <div
                                    class="w-6 h-6 sm:w-8 sm:h-8 bg-white/20 rounded-md sm:rounded-lg flex items-center justify-center">
                                    <i data-lucide="zap" class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-white"></i>
                                </div>
                                <div class="text-white/90 text-sm sm:text-base font-bold">Ngu·ªìn ƒêi·ªán</div>
                            </div>
                            <div class="space-y-1.5 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-3">
                                <div class="bg-white/10 rounded-md sm:rounded-lg p-2 sm:p-2 text-center">
                                    <div class="text-white/70 text-[11px] sm:text-xs font-medium">X√†i ƒêi·ªán EVN</div>
                                    <div id="grid-total" class="text-base sm:text-lg font-black text-amber-300">--</div>
                                </div>
                                <div class="bg-white/10 rounded-md sm:rounded-lg p-2 sm:p-2 text-center">
                                    <div class="text-white/70 text-[11px] sm:text-xs font-medium">ƒêi·ªán D·ª± Ph√≤ng</div>
                                    <div id="essential-total" class="text-base sm:text-lg font-black text-cyan-300">--
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SOC & Temperature Section - With Toggle -->
                    <div class="pt-3 border-t border-slate-200 dark:border-slate-700">
                        <!-- SOC/Temp Header with Toggle Buttons -->
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2 sm:gap-3">
                                <h3 id="socTempTitle"
                                    class="text-sm sm:text-base font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                    <i data-lucide="battery-full" class="w-5 h-5 text-teal-500" id="socTempIcon"></i>
                                    <span id="socTempTitleText">Ph·∫ßn TrƒÉm Pin (SOC)</span>
                                </h3>
                                <!-- Toggle Buttons -->
                                <div id="socTempToggleBtns"
                                    class="flex items-center bg-slate-100 dark:bg-slate-700/50 rounded-lg p-0.5">
                                    <button id="socChartBtn" onclick="switchSocTempChart('soc')"
                                        class="soc-temp-tab-btn active px-2 py-1 rounded-md text-[10px] sm:text-xs font-semibold transition-all bg-teal-500 text-white shadow">
                                        SOC
                                    </button>
                                    <button id="tempChartBtn" onclick="switchSocTempChart('temp')"
                                        class="soc-temp-tab-btn px-2 py-1 rounded-md text-[10px] sm:text-xs font-semibold transition-all text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600">
                                        Nhi·ªát ƒê·ªô
                                    </button>
                                </div>
                            </div>
                            <span class="flex items-center gap-1 text-[10px] text-emerald-600 dark:text-emerald-400">
                                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                                Auto-reload m·ªói 5 ph√∫t
                            </span>
                        </div>

                        <!-- SOC Container (Default - Visible) -->
                        <div id="socContainer">
                            <!-- Big SOC Display + Stats Row -->
                            <div class="flex items-center mb-4 gap-4">
                                <!-- Big SOC Value -->
                                <div class="flex items-center gap-3">
                                    <div class="text-4xl sm:text-5xl font-black text-teal-600 dark:text-teal-400"
                                        id="soc-big-value">--%</div>
                                    <div class="flex flex-col gap-1.5">
                                        <span
                                            class="text-xs sm:text-sm font-bold px-2 sm:px-3 py-1 rounded-full bg-emerald-100 dark:bg-emerald-900/40 text-emerald-600 dark:text-emerald-400">
                                            MAX: <span id="soc-max" class="font-black">--%</span> <span
                                                id="soc-max-time" class="text-[10px] sm:text-xs opacity-80"></span>
                                        </span>
                                        <span
                                            class="text-xs sm:text-sm font-bold px-2 sm:px-3 py-1 rounded-full bg-amber-100 dark:bg-amber-900/40 text-amber-600 dark:text-amber-400">
                                            MIN: <span id="soc-min" class="font-black">--%</span> <span
                                                id="soc-min-time" class="text-[10px] sm:text-xs opacity-80"></span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- SOC Chart Container -->
                            <div class="chart-container relative" style="height: 200px;">
                                <canvas id="socChart"></canvas>
                            </div>
                        </div>

                        <!-- Temperature Container (Hidden by default) -->
                        <div id="tempContainer" class="hidden">
                            <!-- Big Temperature Display + Stats Row -->
                            <div class="flex items-center mb-4 gap-4">
                                <!-- Big Temperature Value -->
                                <div class="flex items-center gap-3">
                                    <div class="text-4xl sm:text-5xl font-black text-orange-600 dark:text-orange-400"
                                        id="temp-big-value">--¬∞C</div>
                                    <div class="flex flex-col gap-1.5">
                                        <span
                                            class="text-xs sm:text-sm font-bold px-2 sm:px-3 py-1 rounded-full bg-red-100 dark:bg-red-900/40 text-red-600 dark:text-red-400">
                                            MAX: <span id="temp-max" class="font-black">--¬∞C</span> <span
                                                id="temp-max-time" class="text-[10px] sm:text-xs opacity-80"></span>
                                        </span>
                                        <span
                                            class="text-xs sm:text-sm font-bold px-2 sm:px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-400">
                                            MIN: <span id="temp-min" class="font-black">--¬∞C</span> <span
                                                id="temp-min-time" class="text-[10px] sm:text-xs opacity-80"></span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Temperature Chart Container -->
                            <div class="chart-container relative" style="height: 200px;">
                                <canvas id="tempChart"></canvas>
                                <!-- Loading Overlay -->
                                <div id="tempChartLoading"
                                    class="hidden absolute inset-0 flex items-center justify-center bg-slate-50/90 dark:bg-slate-900/90 rounded-lg">
                                    <div class="flex flex-col items-center gap-1.5">
                                        <div
                                            class="w-6 h-6 border-2 border-orange-500 border-t-transparent rounded-full animate-spin">
                                        </div>
                                        <span class="text-[10px] text-slate-500 dark:text-slate-400">ƒêang t·∫£i...</span>
                                    </div>
                                </div>
                                <!-- External HTML Tooltip for Temperature -->
                                <div id="temp-tooltip"
                                    class="hidden absolute z-50 bg-slate-900/95 text-white text-xs rounded-lg shadow-xl p-2.5 pointer-events-none backdrop-blur-sm border border-slate-700">
                                    <div id="temp-tooltip-time" class="text-slate-300 text-xs font-medium"></div>
                                    <div id="temp-tooltip-value" class="text-xl font-black text-orange-400"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div id="chart-section" class="hidden space-y-4">

            <!-- Combined Energy Chart - COMPACT V3.0 -->
            <div id="energy-chart-section"
                class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-3 sm:p-4 border-l-4 border-indigo-500">
                <!-- Header with title, chart tabs and date -->
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2 sm:gap-3">
                        <h2
                            class="text-xs sm:text-sm font-bold text-slate-800 dark:text-white flex items-center gap-1.5">
                            <i data-lucide="zap" class="w-4 h-4 text-indigo-500"></i>
                            C√¥ng Su·∫•t Trong Ng√†y
                        </h2>
                        <!-- Chart Toggle Buttons - Scrollable on mobile -->
                        <div id="chartToggleBtns"
                            class="flex items-center bg-slate-100 dark:bg-slate-700/50 rounded-lg p-0.5 overflow-x-auto no-scrollbar gap-0.5">
                            <button id="chart1Btn" onclick="switchPowerChart(1)"
                                class="chart-tab-btn active px-2 py-1 rounded-md text-[9px] sm:text-xs font-semibold transition-all bg-indigo-500 text-white shadow whitespace-nowrap">
                                Chart t·ªïng h·ª£p
                            </button>
                            <button id="chart2Btn" onclick="switchPowerChart(2)"
                                class="chart-tab-btn px-2 py-1 rounded-md text-[9px] sm:text-xs font-semibold transition-all text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 whitespace-nowrap">
                                T·ªïng Ngu·ªìn ƒëi·ªán
                            </button>
                            <button id="chart3Btn" onclick="switchPowerChart(3)"
                                class="chart-tab-btn px-2 py-1 rounded-md text-[9px] sm:text-xs font-semibold transition-all text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 whitespace-nowrap">
                                Chart T·ªïng PV
                            </button>
                            <button id="chart4Btn" onclick="switchPowerChart(4)"
                                class="chart-tab-btn px-2 py-1 rounded-md text-[9px] sm:text-xs font-semibold transition-all text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 whitespace-nowrap">
                                S·∫°c & X·∫£ Pin
                            </button>
                        </div>
                    </div>
                    <input type="date" id="energy-chart-date-picker"
                        class="text-[10px] sm:text-xs font-medium text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md px-2 py-1 cursor-pointer focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        onchange="refreshAllDataForDate(this.value)" />
                </div>

                <!-- Peak Power Grid - 6 items compact -->
                <div class="grid grid-cols-6 gap-1 sm:gap-2 mb-3">
                    <!-- PV Peak -->
                    <div
                        class="bg-gradient-to-br from-amber-50 to-yellow-50 dark:from-amber-900/30 dark:to-yellow-900/20 rounded-lg p-1.5 sm:p-2.5 text-center border border-amber-200/50 dark:border-amber-700/50">
                        <div class="flex items-center justify-center gap-0.5 mb-0.5">
                            <i data-lucide="sun" class="w-3 h-3 sm:w-3.5 sm:h-3.5 text-amber-500"></i>
                            <span class="text-[10px] sm:text-xs font-bold text-amber-600 dark:text-amber-400">PV</span>
                        </div>
                        <div class="text-xs sm:text-sm font-black text-amber-600 dark:text-amber-300"
                            id="chart-pv-peak">--</div>
                        <div class="text-[10px] sm:text-xs font-semibold text-amber-500/90" id="chart-pv-time">--:--
                        </div>
                    </div>
                    <!-- EVN Peak -->
                    <div
                        class="bg-gradient-to-br from-purple-50 to-violet-50 dark:from-purple-900/30 dark:to-violet-900/20 rounded-lg p-1.5 sm:p-2.5 text-center border border-purple-200/50 dark:border-purple-700/50">
                        <div class="flex items-center justify-center gap-0.5 mb-0.5">
                            <i data-lucide="plug" class="w-3 h-3 sm:w-3.5 sm:h-3.5 text-purple-500"></i>
                            <span
                                class="text-[10px] sm:text-xs font-bold text-purple-600 dark:text-purple-400">EVN</span>
                        </div>
                        <div class="text-xs sm:text-sm font-black text-purple-600 dark:text-purple-300"
                            id="chart-grid-peak">--</div>
                        <div class="text-[10px] sm:text-xs font-semibold text-purple-500/90" id="chart-grid-time">--:--
                        </div>
                    </div>
                    <!-- Load Peak -->
                    <div
                        class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/20 rounded-lg p-1.5 sm:p-2.5 text-center border border-blue-200/50 dark:border-blue-700/50">
                        <div class="flex items-center justify-center gap-0.5 mb-0.5">
                            <i data-lucide="home" class="w-3 h-3 sm:w-3.5 sm:h-3.5 text-blue-500"></i>
                            <span class="text-[10px] sm:text-xs font-bold text-blue-600 dark:text-blue-400">T·∫£i</span>
                        </div>
                        <div class="text-xs sm:text-sm font-black text-blue-600 dark:text-blue-300"
                            id="chart-load-peak">--</div>
                        <div class="text-[10px] sm:text-xs font-semibold text-blue-500/90" id="chart-load-time">--:--
                        </div>
                    </div>
                    <!-- Charge Peak -->
                    <div
                        class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/20 rounded-lg p-1.5 sm:p-2.5 text-center border border-green-200/50 dark:border-green-700/50">
                        <div class="flex items-center justify-center gap-0.5 mb-0.5">
                            <i data-lucide="battery-charging" class="w-3 h-3 sm:w-3.5 sm:h-3.5 text-green-500"></i>
                            <span class="text-[10px] sm:text-xs font-bold text-green-600 dark:text-green-400">S·∫°c</span>
                        </div>
                        <div class="text-xs sm:text-sm font-black text-green-600 dark:text-green-300"
                            id="chart-charge-peak">--</div>
                        <div class="text-[10px] sm:text-xs font-semibold text-green-500/90" id="chart-charge-time">--:--
                        </div>
                    </div>
                    <!-- Discharge Peak -->
                    <div
                        class="bg-gradient-to-br from-red-50 to-rose-50 dark:from-red-900/30 dark:to-rose-900/20 rounded-lg p-1.5 sm:p-2.5 text-center border border-red-200/50 dark:border-red-700/50">
                        <div class="flex items-center justify-center gap-0.5 mb-0.5">
                            <i data-lucide="zap" class="w-3 h-3 sm:w-3.5 sm:h-3.5 text-red-500"></i>
                            <span class="text-[10px] sm:text-xs font-bold text-red-600 dark:text-red-400">X·∫£</span>
                        </div>
                        <div class="text-xs sm:text-sm font-black text-red-600 dark:text-red-300"
                            id="chart-discharge-peak">--</div>
                        <div class="text-[10px] sm:text-xs font-semibold text-red-500/90" id="chart-discharge-time">
                            --:--</div>
                    </div>
                    <!-- Essential Peak -->
                    <div
                        class="bg-gradient-to-br from-cyan-50 to-teal-50 dark:from-cyan-900/30 dark:to-teal-900/20 rounded-lg p-1.5 sm:p-2.5 text-center border border-cyan-200/50 dark:border-cyan-700/50">
                        <div class="flex items-center justify-center gap-0.5 mb-0.5">
                            <i data-lucide="shield" class="w-3 h-3 sm:w-3.5 sm:h-3.5 text-cyan-500"></i>
                            <span
                                class="text-[10px] sm:text-xs font-bold text-cyan-600 dark:text-cyan-400">Backup</span>
                        </div>
                        <div class="text-xs sm:text-sm font-black text-cyan-600 dark:text-cyan-300"
                            id="chart-essential-peak">--</div>
                        <div class="text-[10px] sm:text-xs font-semibold text-cyan-500/90" id="chart-essential-time">
                            --:--</div>
                    </div>
                </div>

                <!-- CHART 1: Line Chart (Default) -->
                <div id="chart1Container"
                    class="bg-slate-50/50 dark:bg-slate-900/30 rounded-xl p-2 sm:p-3 border border-slate-200/50 dark:border-slate-700/50">
                    <!-- Chart Header with Legend -->
                    <div class="flex items-center justify-between gap-2 mb-2">
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="activity" class="w-3.5 h-3.5 text-indigo-500"></i>
                            <span
                                class="text-[10px] sm:text-xs font-semibold text-slate-600 dark:text-slate-300">Timeline
                                24h</span>
                        </div>
                        <!-- Compact Legend Toggles -->
                        <div id="powerChartLegend" class="flex flex-wrap gap-0.5 sm:gap-1">
                            <button onclick="togglePowerDataset(0)"
                                class="power-legend-btn active flex items-center gap-0.5 px-1.5 py-0.5 rounded text-[8px] sm:text-[10px] font-medium transition-all bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-300 hover:opacity-80">
                                <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>PV
                            </button>
                            <button onclick="togglePowerDataset(1)"
                                class="power-legend-btn active flex items-center gap-0.5 px-1.5 py-0.5 rounded text-[8px] sm:text-[10px] font-medium transition-all bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 hover:opacity-80">
                                <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>T·∫£i
                            </button>
                            <button onclick="togglePowerDataset(2)"
                                class="power-legend-btn active flex items-center gap-0.5 px-1.5 py-0.5 rounded text-[8px] sm:text-[10px] font-medium transition-all bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300 hover:opacity-80">
                                <span class="w-1.5 h-1.5 rounded-full bg-purple-500"></span>EVN
                            </button>
                            <button onclick="togglePowerDataset(3)"
                                class="power-legend-btn active flex items-center gap-0.5 px-1.5 py-0.5 rounded text-[8px] sm:text-[10px] font-medium transition-all bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300 hover:opacity-80">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>N·∫°p
                            </button>
                            <button onclick="togglePowerDataset(4)"
                                class="power-legend-btn active flex items-center gap-0.5 px-1.5 py-0.5 rounded text-[8px] sm:text-[10px] font-medium transition-all bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300 hover:opacity-80">
                                <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span>X·∫£
                            </button>
                            <button onclick="togglePowerDataset(5)"
                                class="power-legend-btn active flex items-center gap-0.5 px-1.5 py-0.5 rounded text-[8px] sm:text-[10px] font-medium transition-all bg-cyan-100 dark:bg-cyan-900/40 text-cyan-700 dark:text-cyan-300 hover:opacity-80">
                                <span class="w-1.5 h-1.5 rounded-full bg-cyan-500"></span>Backup
                            </button>
                        </div>
                    </div>

                    <!-- Chart Container - Compact height -->
                    <div class="relative rounded-lg overflow-hidden" style="height: 280px;">
                        <canvas id="powerTimelineChart"></canvas>
                        <!-- Loading Overlay -->
                        <div id="powerChartLoading"
                            class="absolute inset-0 flex items-center justify-center bg-slate-50/90 dark:bg-slate-900/90 rounded-lg">
                            <div class="flex flex-col items-center gap-1.5">
                                <div
                                    class="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin">
                                </div>
                                <span class="text-[10px] text-slate-500 dark:text-slate-400">ƒêang t·∫£i...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CHART 2: T·ªïng Ngu·ªìn ƒëi·ªán (Hidden by default) -->
                <div id="chart2Container"
                    class="hidden bg-slate-50/50 dark:bg-slate-900/30 rounded-xl p-2 sm:p-3 border border-slate-200/50 dark:border-slate-700/50">
                    <!-- Chart Header with Legend -->
                    <div class="flex items-center justify-between gap-2 mb-2">
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="plug-zap" class="w-3.5 h-3.5 text-blue-500"></i>
                            <span class="text-[10px] sm:text-xs font-semibold text-slate-600 dark:text-slate-300">C√¥ng
                                su·∫•t (W)</span>
                        </div>
                        <!-- Legend -->
                        <div class="flex flex-wrap gap-1 sm:gap-2">
                            <span
                                class="flex items-center gap-1 text-[9px] sm:text-[11px] font-medium text-amber-600 dark:text-amber-400">
                                <span class="w-2 h-2 rounded-full bg-amber-400"></span>CS mua t·ª´ l∆∞·ªõi
                            </span>
                            <span
                                class="flex items-center gap-1 text-[9px] sm:text-[11px] font-medium text-green-600 dark:text-green-400">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span>C√¥ng su·∫•t c·ªïng load
                            </span>
                            <span
                                class="flex items-center gap-1 text-[9px] sm:text-[11px] font-medium text-blue-600 dark:text-blue-400">
                                <span class="w-2 h-2 rounded-full bg-blue-500"></span>T·∫£i h√≤a l∆∞·ªõi
                            </span>
                        </div>
                    </div>
                    <!-- Chart Canvas -->
                    <div class="relative rounded-lg overflow-hidden" style="height: 280px;">
                        <canvas id="gridSourceChart"></canvas>
                    </div>
                </div>

                <!-- CHART 3: T·ªïng PV h√¥m nay (Hidden by default) -->
                <div id="chart3Container"
                    class="hidden bg-slate-50/50 dark:bg-slate-900/30 rounded-xl p-2 sm:p-3 border border-slate-200/50 dark:border-slate-700/50">
                    <!-- Chart Header with total kWh -->
                    <div class="flex items-center justify-between gap-2 mb-2">
                        <div class="flex flex-col">
                            <span id="pvTodayTotal"
                                class="text-xl sm:text-2xl font-black text-cyan-500 dark:text-cyan-400">0.0 KWh</span>
                            <span class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400">S·∫£n l∆∞·ª£ng ƒëi·ªán
                                PV</span>
                        </div>
                        <span class="text-[10px] sm:text-xs text-slate-400">C√¥ng su·∫•t (W)</span>
                    </div>
                    <!-- Chart Canvas -->
                    <div class="relative rounded-lg overflow-hidden" style="height: 280px;">
                        <canvas id="pvTodayChart"></canvas>
                    </div>
                </div>

                <!-- CHART 4: S·∫°c & X·∫£ Pin (Hidden by default) -->
                <div id="chart4Container"
                    class="hidden bg-slate-50/50 dark:bg-slate-900/30 rounded-xl p-2 sm:p-3 border border-slate-200/50 dark:border-slate-700/50">
                    <!-- Chart Header with Charge/Discharge totals -->
                    <div class="flex items-center justify-center gap-6 sm:gap-10 mb-2">
                        <div class="text-center">
                            <span id="chargeTotal"
                                class="text-lg sm:text-xl font-black text-slate-600 dark:text-slate-300">0.0 KWh</span>
                            <span class="block text-[10px] sm:text-xs text-slate-400">S·∫°c pin</span>
                        </div>
                        <div class="text-center">
                            <span id="dischargeTotal"
                                class="text-lg sm:text-xl font-black text-slate-600 dark:text-slate-300">0.0 KWh</span>
                            <span class="block text-[10px] sm:text-xs text-slate-400">X·∫£ pin</span>
                        </div>
                    </div>
                    <div class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 mb-2">C√¥ng su·∫•t (W)</div>
                    <!-- Chart Canvas -->
                    <div class="relative rounded-lg overflow-hidden" style="height: 280px;">
                        <canvas id="batteryFlowChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Solar Project Summary Section - With Card Container -->
        <div id="solarProjectSummary" class="mt-6 mb-4 hidden">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-4 sm:p-5 border-l-4 border-emerald-500">
                <!-- Header -->
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-xl sm:text-2xl">üìä</span>
                        <span class="text-base sm:text-lg font-bold text-emerald-700 dark:text-emerald-300">T·ªïng Qu√°t D·ª±
                            √Ån Solar</span>
                    </div>
                    <a href="/calculator" id="viewCalculatorLink"
                        class="px-3 py-1.5 sm:px-4 sm:py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-xs sm:text-sm font-semibold rounded-lg shadow-md hover:shadow-lg transition-all flex items-center gap-1.5">
                        <span>üìä Si√™u Chi Ti·∫øt</span>
                        <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>
                </div>

                <!-- 3 rows x 2 cols grid -->
                <div class="grid grid-cols-1 gap-3">
                    <!-- Row 1: T·ªïng ti·∫øt ki·ªám + T·ªïng ƒëi·ªán ti√™u th·ª• -->
                    <div class="grid grid-cols-2 gap-3">
                        <!-- T·ªïng Ti·∫øt Ki·ªám -->
                        <div
                            class="bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/30 dark:to-green-900/30 rounded-xl p-3 sm:p-4 border border-emerald-200 dark:border-emerald-700 text-center">
                            <div class="flex items-center gap-2 mb-2 justify-center">
                                <span class="text-lg sm:text-xl">üí∞</span>
                                <span
                                    class="text-xs sm:text-sm text-emerald-600 dark:text-emerald-400 font-semibold">T·ªïng
                                    Ti·∫øt Ki·ªám</span>
                            </div>
                            <div class="text-base sm:text-xl font-black text-emerald-600 dark:text-emerald-400 animate-glow"
                                id="summaryTotalSavings">0 VNƒê</div>
                            <button onclick="showMonthlySavingsPopup()"
                                class="mt-2 text-xs px-3 py-1.5 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/40 text-emerald-600 dark:text-emerald-400 font-medium transition-colors w-full"
                                title="Xem chi ti·∫øt t·ª´ng th√°ng">
                                üìã Chi ti·∫øt t·ª´ng th√°ng
                            </button>
                        </div>
                        <!-- T·ªïng ƒêi·ªán Ti√™u Th·ª• -->
                        <div
                            class="bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/30 dark:to-green-900/30 rounded-xl p-3 sm:p-4 border border-emerald-200 dark:border-emerald-700 text-center">
                            <div class="flex items-center gap-2 mb-2 justify-center">
                                <span class="text-lg sm:text-xl">‚ö°</span>
                                <span
                                    class="text-xs sm:text-sm text-emerald-600 dark:text-emerald-400 font-semibold">T·ªïng
                                    ƒêi·ªán Ti√™u Th·ª•</span>
                            </div>
                            <div class="text-base sm:text-xl font-black text-emerald-600 dark:text-emerald-400 animate-glow"
                                id="summaryTotalLoad">0 kWh</div>
                            <button onclick="showMonthlyDetailPopup('load')"
                                class="mt-2 text-xs px-3 py-1.5 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/40 text-emerald-600 dark:text-emerald-400 font-medium transition-colors w-full"
                                title="Xem chi ti·∫øt t·ª´ng th√°ng">
                                üìã Chi ti·∫øt t·ª´ng th√°ng
                            </button>
                        </div>
                    </div>

                    <!-- Row 2: T·ªïng ƒëi·ªán Solar s·∫£n xu·∫•t + T·ªïng ƒëi·ªán l∆∞·ªõi EVN -->
                    <div class="grid grid-cols-2 gap-3">
                        <!-- T·ªïng ƒêi·ªán Solar S·∫£n Xu·∫•t -->
                        <div
                            class="bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/30 dark:to-green-900/30 rounded-xl p-3 sm:p-4 border border-emerald-200 dark:border-emerald-700 text-center">
                            <div class="flex items-center gap-2 mb-2 justify-center">
                                <span class="text-lg sm:text-xl">‚òÄÔ∏è</span>
                                <span
                                    class="text-xs sm:text-sm text-emerald-600 dark:text-emerald-400 font-semibold">T·ªïng
                                    ƒêi·ªán Solar</span>
                            </div>
                            <div class="text-base sm:text-xl font-black text-emerald-600 dark:text-emerald-400 animate-glow"
                                id="summaryTotalSolar">0 kWh</div>
                            <button onclick="showMonthlyDetailPopup('pv')"
                                class="mt-2 text-xs px-3 py-1.5 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/40 text-emerald-600 dark:text-emerald-400 font-medium transition-colors w-full"
                                title="Xem chi ti·∫øt t·ª´ng th√°ng">
                                üìã Chi ti·∫øt t·ª´ng th√°ng
                            </button>
                        </div>
                        <!-- T·ªïng ƒêi·ªán L∆∞·ªõi EVN -->
                        <div
                            class="bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/30 dark:to-green-900/30 rounded-xl p-3 sm:p-4 border border-emerald-200 dark:border-emerald-700 text-center">
                            <div class="flex items-center gap-2 mb-2 justify-center">
                                <span class="text-lg sm:text-xl">üîå</span>
                                <span
                                    class="text-xs sm:text-sm text-emerald-600 dark:text-emerald-400 font-semibold">T·ªïng
                                    ƒêi·ªán L∆∞·ªõi EVN</span>
                            </div>
                            <div class="text-base sm:text-xl font-black text-emerald-600 dark:text-emerald-400 animate-glow"
                                id="summaryTotalGrid">0 kWh</div>
                            <button onclick="showMonthlyDetailPopup('grid')"
                                class="mt-2 text-xs px-3 py-1.5 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/40 text-emerald-600 dark:text-emerald-400 font-medium transition-colors w-full"
                                title="Xem chi ti·∫øt t·ª´ng th√°ng">
                                üìã Chi ti·∫øt t·ª´ng th√°ng
                            </button>
                        </div>
                    </div>

                    <!-- Row 3: Chi ph√≠ n·∫øu kh√¥ng c√≥ Solar + Trung b√¨nh ti·∫øt ki·ªám/th√°ng -->
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Chi Ph√≠ N·∫øu Kh√¥ng C√≥ Solar -->
                        <div
                            class="bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/30 dark:to-green-900/30 rounded-xl p-3 sm:p-4 border border-emerald-200 dark:border-emerald-700 text-center">
                            <div class="flex items-center gap-2 mb-2 justify-center">
                                <span class="text-lg sm:text-xl">üìâ</span>
                                <span
                                    class="text-xs sm:text-sm text-emerald-600 dark:text-emerald-400 font-semibold">Kh√¥ng
                                    C√≥ Solar</span>
                            </div>
                            <div class="text-base sm:text-xl font-black text-emerald-600 dark:text-emerald-400 animate-glow"
                                id="summaryCostWithoutSolar">0 VNƒê</div>
                            <button onclick="showMonthlyDetailPopup('costWithoutSolar')"
                                class="mt-2 text-xs px-3 py-1.5 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/40 text-emerald-600 dark:text-emerald-400 font-medium transition-colors w-full"
                                title="Xem chi ti·∫øt t·ª´ng th√°ng">
                                üìã Chi ti·∫øt t·ª´ng th√°ng
                            </button>
                        </div>
                        <!-- Trung B√¨nh Ti·∫øt Ki·ªám/Th√°ng -->
                        <div
                            class="bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/30 dark:to-green-900/30 rounded-xl p-3 sm:p-4 border border-emerald-200 dark:border-emerald-700 text-center">
                            <div class="flex items-center gap-2 mb-2 justify-center">
                                <span class="text-lg sm:text-xl">üìà</span>
                                <span class="text-xs sm:text-sm text-emerald-600 dark:text-emerald-400 font-semibold">TB
                                    Ti·∫øt Ki·ªám/Th√°ng</span>
                            </div>
                            <div class="text-base sm:text-xl font-black text-emerald-600 dark:text-emerald-400 animate-glow"
                                id="summaryAvgSavings">0 VNƒê</div>
                            <button onclick="showMonthlySavingsPopup()"
                                class="mt-2 text-xs px-3 py-1.5 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/40 text-emerald-600 dark:text-emerald-400 font-medium transition-colors w-full"
                                title="Xem chi ti·∫øt t·ª´ng th√°ng">
                                üìã Chi ti·∫øt t·ª´ng th√°ng
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Monthly Chart Section -->
                <div id="summaryChartSection" class="mt-4 hidden">
                    <div
                        class="bg-gradient-to-br from-slate-50 to-gray-50 dark:from-slate-800/50 dark:to-slate-700/50 rounded-xl p-3 sm:p-4 border border-gray-200 dark:border-slate-600">
                        <!-- Chart Header -->
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-base sm:text-lg">üìä</span>
                                <span class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">Bi·ªÉu ƒê·ªì
                                    Theo Th√°ng</span>
                            </div>
                            <div id="summaryChartYearBadges" class="flex gap-1">
                                <!-- Year badges will be dynamically inserted -->
                            </div>
                        </div>
                        <!-- Chart Canvas Container - Optimized for touch -->
                        <div class="relative w-full" style="min-height: 200px; height: 220px;"
                            id="summaryChartContainer">
                            <canvas id="summaryMonthlyChart"
                                style="touch-action: pan-y; -webkit-tap-highlight-color: transparent;"></canvas>
                        </div>
                        <!-- Chart Legend -->
                        <div class="flex flex-wrap justify-center gap-2 sm:gap-4 mt-3 text-[10px] sm:text-xs">
                            <div class="flex items-center gap-1">
                                <span class="w-3 h-3 rounded-full bg-yellow-400"></span>
                                <span class="text-gray-600 dark:text-gray-400">PV</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                                <span class="text-gray-600 dark:text-gray-400">Load</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="w-3 h-3 rounded-full bg-red-500"></span>
                                <span class="text-gray-600 dark:text-gray-400">Grid</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
                                <span class="text-gray-600 dark:text-gray-400">Ti·∫øt Ki·ªám</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Link to Calculator -->
                <div class="mt-4 text-center">
                    <a href="/calculator" id="goToCalculatorBtn" class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 
                      text-white text-sm font-semibold rounded-lg shadow-md hover:shadow-lg transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        <span>M·ªü Calculator Chi Ti·∫øt</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Telegram Notification Settings Section -->
        <div id="telegramSettingsSection" class="mt-6 mb-4 hidden">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-4 sm:p-5 border-l-4 border-blue-500">
                <!-- Header -->
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-xl sm:text-2xl">üì±</span>
                        <span class="text-base sm:text-lg font-bold text-blue-700 dark:text-blue-300">Th√¥ng B√°o
                            Telegram</span>
                    </div>
                    <span id="telegramStatus"
                        class="text-xs px-2 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400">Ch∆∞a
                        k·∫øt n·ªëi</span>
                </div>

                <!-- Description -->
                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Nh·∫≠n th√¥ng b√°o t·ª± ƒë·ªông v·ªÅ tr·∫°ng th√°i thi·∫øt b·ªã: m·∫•t ƒëi·ªán, c√≥ ƒëi·ªán l·∫°i, pin y·∫øu, b√°o c√°o h√†ng gi·ªù k√®m
                    th·ªùi ti·∫øt.
                </p>

                <!-- Settings Grid -->
                <div class="space-y-3">
                    <!-- Notification Types -->
                    <div
                        class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-slate-800/80 dark:to-slate-700/80 rounded-xl p-4 border border-blue-200 dark:border-slate-600">
                        <div class="text-sm font-semibold text-blue-700 dark:text-blue-300 mb-3">üîî Lo·∫°i th√¥ng b√°o:
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <label
                                class="tg-checkbox-label flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-blue-100 dark:hover:bg-slate-600/50 transition-colors">
                                <input type="checkbox" id="tgMorningGreeting" checked
                                    class="tg-checkbox w-5 h-5 rounded border-2 border-gray-300 dark:border-slate-500 text-emerald-500 focus:ring-emerald-500 focus:ring-2 bg-white dark:bg-slate-700 cursor-pointer">
                                <span class="text-sm text-gray-700 dark:text-gray-200 font-medium">‚òÄÔ∏è B·∫Øt ƒë·∫ßu PV</span>
                            </label>
                            <label
                                class="tg-checkbox-label flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-blue-100 dark:hover:bg-slate-600/50 transition-colors">
                                <input type="checkbox" id="tgPvEnded" checked
                                    class="tg-checkbox w-5 h-5 rounded border-2 border-gray-300 dark:border-slate-500 text-emerald-500 focus:ring-emerald-500 focus:ring-2 bg-white dark:bg-slate-700 cursor-pointer">
                                <span class="text-sm text-gray-700 dark:text-gray-200 font-medium">üåá H·∫øt PV</span>
                            </label>
                            <label
                                class="tg-checkbox-label flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-blue-100 dark:hover:bg-slate-600/50 transition-colors">
                                <input type="checkbox" id="tgPowerOutage" checked
                                    class="tg-checkbox w-5 h-5 rounded border-2 border-gray-300 dark:border-slate-500 text-emerald-500 focus:ring-emerald-500 focus:ring-2 bg-white dark:bg-slate-700 cursor-pointer">
                                <span class="text-sm text-gray-700 dark:text-gray-200 font-medium">‚ö° M·∫•t ƒëi·ªán EVN</span>
                            </label>
                            <label
                                class="tg-checkbox-label flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-blue-100 dark:hover:bg-slate-600/50 transition-colors">
                                <input type="checkbox" id="tgPowerRestored" checked
                                    class="tg-checkbox w-5 h-5 rounded border-2 border-gray-300 dark:border-slate-500 text-emerald-500 focus:ring-emerald-500 focus:ring-2 bg-white dark:bg-slate-700 cursor-pointer">
                                <span class="text-sm text-gray-700 dark:text-gray-200 font-medium">‚úÖ C√≥ ƒëi·ªán l·∫°i</span>
                            </label>
                            <label
                                class="tg-checkbox-label flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-blue-100 dark:hover:bg-slate-600/50 transition-colors">
                                <input type="checkbox" id="tgLowBattery" checked
                                    class="tg-checkbox w-5 h-5 rounded border-2 border-gray-300 dark:border-slate-500 text-emerald-500 focus:ring-emerald-500 focus:ring-2 bg-white dark:bg-slate-700 cursor-pointer">
                                <span class="text-sm text-gray-700 dark:text-gray-200 font-medium">üîã Pin y·∫øu
                                    (&lt;20%)</span>
                            </label>
                            <label
                                class="tg-checkbox-label flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-blue-100 dark:hover:bg-slate-600/50 transition-colors">
                                <input type="checkbox" id="tgHourlyStatus"
                                    class="tg-checkbox w-5 h-5 rounded border-2 border-gray-300 dark:border-slate-500 text-emerald-500 focus:ring-emerald-500 focus:ring-2 bg-white dark:bg-slate-700 cursor-pointer">
                                <span class="text-sm text-gray-700 dark:text-gray-200 font-medium">‚è∞ B√°o c√°o m·ªói
                                    gi·ªù</span>
                            </label>
                        </div>
                    </div>

                    <!-- Custom Threshold Alerts -->
                    <div
                        class="bg-gradient-to-br from-orange-50 to-amber-50 dark:from-slate-800/80 dark:to-slate-700/80 rounded-xl p-4 border border-orange-200 dark:border-slate-600">
                        <div class="text-sm font-semibold text-orange-700 dark:text-orange-300 mb-3">‚ö° Ng∆∞·ª°ng c·∫£nh b√°o
                            t√πy ch·ªânh:</div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <!-- Battery Full Alert -->
                            <div class="flex items-center gap-2 bg-white/50 dark:bg-slate-700/50 rounded-lg p-2">
                                <span class="text-sm text-gray-700 dark:text-gray-200 flex-1">üîã Pin ƒë·∫ßy (%)</span>
                                <input type="number" id="thBatteryFull" min="80" max="100" value="" placeholder="100"
                                    class="w-20 text-sm px-2 py-1.5 rounded-lg border-2 border-orange-300 dark:border-slate-500 bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-orange-500 font-medium text-center">
                            </div>
                            <!-- Battery Low Alert -->
                            <div class="flex items-center gap-2 bg-white/50 dark:bg-slate-700/50 rounded-lg p-2">
                                <span class="text-sm text-gray-700 dark:text-gray-200 flex-1">üîª Pin th·∫•p (%)</span>
                                <input type="number" id="thBatteryLow" min="5" max="50" value="" placeholder="20"
                                    class="w-20 text-sm px-2 py-1.5 rounded-lg border-2 border-orange-300 dark:border-slate-500 bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-orange-500 font-medium text-center">
                            </div>
                            <!-- Voltage High Alert - ngay d∆∞·ªõi Pin th·∫•p -->
                            <div class="flex items-center gap-2 bg-white/50 dark:bg-slate-700/50 rounded-lg p-2">
                                <span class="text-sm text-gray-700 dark:text-gray-200 flex-1">üîã ƒêi·ªán √°p pin cao
                                    (V)</span>
                                <input type="number" id="thBatteryVoltHigh" min="0" max="300" value="" step="1"
                                    placeholder="55"
                                    class="w-20 text-sm px-2 py-1.5 rounded-lg border-2 border-red-300 dark:border-slate-500 bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-red-500 font-medium text-center">
                            </div>
                            <!-- Voltage Low Alert - ngay d∆∞·ªõi Pin th·∫•p -->
                            <div class="flex items-center gap-2 bg-white/50 dark:bg-slate-700/50 rounded-lg p-2">
                                <span class="text-sm text-gray-700 dark:text-gray-200 flex-1">üîã ƒêi·ªán √°p pin th·∫•p
                                    (V)</span>
                                <input type="number" id="thBatteryVoltLow" min="0" max="250" value="" step="1"
                                    placeholder="45"
                                    class="w-20 text-sm px-2 py-1.5 rounded-lg border-2 border-yellow-300 dark:border-slate-500 bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-yellow-500 font-medium text-center">
                            </div>
                            <!-- PV Daily Alert -->
                            <div class="flex items-center gap-2 bg-white/50 dark:bg-slate-700/50 rounded-lg p-2">
                                <span class="text-sm text-gray-700 dark:text-gray-200 flex-1">‚òÄÔ∏è S·∫£n l∆∞·ª£ng PV
                                    (kWh)</span>
                                <input type="number" id="thPvDaily" min="0" max="100" value="" step="0.5" placeholder=""
                                    class="w-20 text-sm px-2 py-1.5 rounded-lg border-2 border-orange-300 dark:border-slate-500 bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-orange-500 font-medium text-center">
                            </div>
                            <!-- Grid Usage Alert -->
                            <div class="flex items-center gap-2 bg-white/50 dark:bg-slate-700/50 rounded-lg p-2">
                                <span class="text-sm text-gray-700 dark:text-gray-200 flex-1">‚ö° ƒêi·ªán EVN (kWh)</span>
                                <input type="number" id="thGridUsage" min="0" max="100" value="" step="0.5"
                                    placeholder=""
                                    class="w-20 text-sm px-2 py-1.5 rounded-lg border-2 border-orange-300 dark:border-slate-500 bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-orange-500 font-medium text-center">
                            </div>
                            <!-- Load Daily Alert -->
                            <div
                                class="flex items-center gap-2 bg-white/50 dark:bg-slate-700/50 rounded-lg p-2 sm:col-span-2">
                                <span class="text-sm text-gray-700 dark:text-gray-200 flex-1">üè† Ti√™u th·ª• trong ng√†y
                                    (kWh)</span>
                                <input type="number" id="thLoadDaily" min="0" max="200" value="" step="0.5"
                                    placeholder=""
                                    class="w-20 text-sm px-2 py-1.5 rounded-lg border-2 border-orange-300 dark:border-slate-500 bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-orange-500 font-medium text-center">
                            </div>
                        </div>
                        <p class="text-xs text-orange-600 dark:text-orange-400 mt-2">üí° ƒê·∫∑t = 0 ƒë·ªÉ t·∫Øt c·∫£nh b√°o. Pin ƒë·∫ßy
                            = 100 ƒë·ªÉ t·∫Øt. ƒêi·ªán √°p pin VD: Cao 55V, Th·∫•p 45V (pin 48V).</p>
                    </div>

                    <!-- Location Setting -->
                    <div
                        class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-slate-800/80 dark:to-slate-700/80 rounded-xl p-4 border border-blue-200 dark:border-slate-600">
                        <div class="text-sm font-semibold text-blue-700 dark:text-blue-300 mb-3">üìç V√πng th·ªùi ti·∫øt:
                        </div>
                        <select id="tgLocation"
                            class="w-full text-sm px-4 py-3 rounded-lg border-2 border-blue-300 dark:border-slate-500 bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium">
                            <optgroup label="üèôÔ∏è Th√†nh ph·ªë tr·ª±c thu·ªôc TW">
                                <option value="TP. Ho Chi Minh">TP. H·ªì Ch√≠ Minh</option>
                                <option value="Ha Noi">H√† N·ªôi</option>
                                <option value="Da Nang">ƒê√† N·∫µng</option>
                                <option value="Can Tho">C·∫ßn Th∆°</option>
                                <option value="Hai Phong">H·∫£i Ph√≤ng</option>
                            </optgroup>
                            <optgroup label="üå¥ Mi·ªÅn Nam">
                                <option value="Binh Duong">B√¨nh D∆∞∆°ng</option>
                                <option value="Dong Nai">ƒê·ªìng Nai</option>
                                <option value="Ba Ria - Vung Tau">B√† R·ªãa - V≈©ng T√†u</option>
                                <option value="Binh Phuoc">B√¨nh Ph∆∞·ªõc</option>
                                <option value="Tay Ninh">T√¢y Ninh</option>
                                <option value="Long An">Long An</option>
                                <option value="Tien Giang">Ti·ªÅn Giang</option>
                                <option value="Ben Tre">B·∫øn Tre</option>
                                <option value="Vinh Long">Vƒ©nh Long</option>
                                <option value="Tra Vinh">Tr√† Vinh</option>
                                <option value="Dong Thap">ƒê·ªìng Th√°p</option>
                                <option value="An Giang">An Giang</option>
                                <option value="Kien Giang">Ki√™n Giang</option>
                                <option value="Hau Giang">H·∫≠u Giang</option>
                                <option value="Soc Trang">S√≥c TrƒÉng</option>
                                <option value="Bac Lieu">B·∫°c Li√™u</option>
                                <option value="Ca Mau">C√† Mau</option>
                            </optgroup>
                            <optgroup label="üèîÔ∏è T√¢y Nguy√™n">
                                <option value="Lam Dong">L√¢m ƒê·ªìng (ƒê√† L·∫°t)</option>
                                <option value="Dak Lak">ƒê·∫Øk L·∫Øk</option>
                                <option value="Dak Nong">ƒê·∫Øk N√¥ng</option>
                                <option value="Gia Lai">Gia Lai</option>
                                <option value="Kon Tum">Kon Tum</option>
                            </optgroup>
                            <optgroup label="üèñÔ∏è Mi·ªÅn Trung">
                                <option value="Khanh Hoa">Kh√°nh H√≤a (Nha Trang)</option>
                                <option value="Binh Thuan">B√¨nh Thu·∫≠n (Phan Thi·∫øt)</option>
                                <option value="Ninh Thuan">Ninh Thu·∫≠n</option>
                                <option value="Phu Yen">Ph√∫ Y√™n</option>
                                <option value="Binh Dinh">B√¨nh ƒê·ªãnh</option>
                                <option value="Quang Ngai">Qu·∫£ng Ng√£i</option>
                                <option value="Quang Nam">Qu·∫£ng Nam (H·ªôi An)</option>
                                <option value="Thua Thien Hue">Th·ª´a Thi√™n Hu·∫ø</option>
                                <option value="Quang Tri">Qu·∫£ng Tr·ªã</option>
                                <option value="Quang Binh">Qu·∫£ng B√¨nh</option>
                                <option value="Ha Tinh">H√† Tƒ©nh</option>
                                <option value="Nghe An">Ngh·ªá An</option>
                                <option value="Thanh Hoa">Thanh H√≥a</option>
                            </optgroup>
                            <optgroup label="‚ùÑÔ∏è Mi·ªÅn B·∫Øc - ƒê·ªìng b·∫±ng">
                                <option value="Quang Ninh">Qu·∫£ng Ninh (H·∫° Long)</option>
                                <option value="Bac Giang">B·∫Øc Giang</option>
                                <option value="Bac Ninh">B·∫Øc Ninh</option>
                                <option value="Hai Duong">H·∫£i D∆∞∆°ng</option>
                                <option value="Hung Yen">H∆∞ng Y√™n</option>
                                <option value="Thai Binh">Th√°i B√¨nh</option>
                                <option value="Nam Dinh">Nam ƒê·ªãnh</option>
                                <option value="Ninh Binh">Ninh B√¨nh</option>
                                <option value="Ha Nam">H√† Nam</option>
                                <option value="Vinh Phuc">Vƒ©nh Ph√∫c</option>
                                <option value="Phu Tho">Ph√∫ Th·ªç</option>
                            </optgroup>
                            <optgroup label="üèîÔ∏è Mi·ªÅn B·∫Øc - Trung du & Mi·ªÅn n√∫i">
                                <option value="Thai Nguyen">Th√°i Nguy√™n</option>
                                <option value="Bac Kan">B·∫Øc K·∫°n</option>
                                <option value="Cao Bang">Cao B·∫±ng</option>
                                <option value="Lang Son">L·∫°ng S∆°n</option>
                                <option value="Tuyen Quang">Tuy√™n Quang</option>
                                <option value="Ha Giang">H√† Giang</option>
                                <option value="Yen Bai">Y√™n B√°i</option>
                                <option value="Lao Cai">L√†o Cai (Sa Pa)</option>
                                <option value="Lai Chau">Lai Ch√¢u</option>
                                <option value="Dien Bien">ƒêi·ªán Bi√™n</option>
                                <option value="Son La">S∆°n La</option>
                                <option value="Hoa Binh">H√≤a B√¨nh</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <!-- Action Button -->
                <div class="mt-4">
                    <button id="saveTelegramSettings" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-gradient-to-r from-sky-500 to-blue-500 hover:from-sky-600 hover:to-blue-600 
                           text-white text-sm font-semibold rounded-lg shadow-md hover:shadow-lg transition-all">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.692-1.653-1.123-2.678-1.799-1.185-.781-.417-1.21.258-1.911.177-.184 3.247-2.977 3.307-3.23.007-.032.015-.15-.056-.212s-.174-.041-.248-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.009-1.252-.242-1.865-.442-.751-.244-1.349-.374-1.297-.789.027-.216.324-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.015 3.333-1.386 4.025-1.627 4.477-1.635.099-.002.321.023.465.141.121.1.154.234.169.332.016.098.035.32.019.493z" />
                        </svg>
                        <span>L∆∞u C√†i ƒê·∫∑t Telegram Bot</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Telegram Success Modal -->
        <div id="tgSuccessModal" class="tg-modal-overlay">
            <div class="tg-modal-content">
                <div class="text-center">
                    <!-- Success Icon -->
                    <div
                        class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-emerald-400 to-green-500 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>

                    <!-- Title -->
                    <h3 class="text-xl font-bold text-white mb-2">ƒê√£ l∆∞u c√†i ƒë·∫∑t!</h3>

                    <!-- Message -->
                    <p class="text-gray-300 text-sm mb-4">
                        C√†i ƒë·∫∑t ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°m th·ªùi. ƒê·ªÉ ƒë·ªìng b·ªô v√†o Telegram Bot, vui l√≤ng ·∫•n n√∫t b√™n d∆∞·ªõi.
                    </p>

                    <!-- Device Info -->
                    <div class="bg-slate-700/50 rounded-lg p-3 mb-4">
                        <div class="text-xs text-gray-400 mb-1">Thi·∫øt b·ªã</div>
                        <div id="tgModalDeviceId" class="text-lg font-bold text-emerald-400">P250801055</div>
                    </div>

                    <!-- Buttons -->
                    <div class="flex flex-col gap-2">
                        <button id="tgModalOpenBot"
                            class="w-full py-3 px-4 bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 text-white font-semibold rounded-xl flex items-center justify-center gap-2 transition-all">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.692-1.653-1.123-2.678-1.799-1.185-.781-.417-1.21.258-1.911.177-.184 3.247-2.977 3.307-3.23.007-.032.015-.15-.056-.212s-.174-.041-.248-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.009-1.252-.242-1.865-.442-.751-.244-1.349-.374-1.297-.789.027-.216.324-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.015 3.333-1.386 4.025-1.627 4.477-1.635.099-.002.321.023.465.141.121.1.154.234.169.332.016.098.035.32.019.493z" />
                            </svg>
                            M·ªü Telegram Bot ƒë·ªÉ l∆∞u
                        </button>
                        <button id="tgModalClose"
                            class="w-full py-2.5 px-4 bg-slate-600 hover:bg-slate-500 text-gray-300 font-medium rounded-xl transition-all">
                            ƒê·ªÉ sau
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="loading" class="hidden flex justify-center items-center p-8">
            <div class="flex flex-col items-center gap-3">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-teal-500 border-t-transparent"></div>
                <span class="text-sm text-slate-500">ƒêang t·∫£i d·ªØ li·ªáu...</span>
            </div>
        </div>

        <!-- Error message -->
        <div id="errorMessage"
            class="hidden bg-red-50 dark:bg-red-900/20 border-2 border-red-300 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-4 rounded-xl mb-4 mx-4 max-w-lg mx-auto">
            <div class="flex items-start gap-3">
                <i data-lucide="alert-circle" class="w-6 h-6 flex-shrink-0 mt-0.5"></i>
                <div id="errorText" class="font-medium text-sm leading-relaxed">ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu.</div>
            </div>
        </div>


    </main>

    <!-- Floating Action Button - Calculator with deviceId -->
    <a b-iwpun16f09 id="calcLinkFAB" href="/calculator"
        class="fab gradient-brand shadow-brand text-white sm:hidden no-underline flex items-center justify-center"
        title="T√≠nh Ti·∫øt Ki·ªám">
        <i b-iwpun16f09 data-lucide="calculator" class="w-6 h-6"></i>
    </a>

    <!-- Calculator Modal removed - now uses direct link to /calculator -->

    <!-- Scripts -->
    <script>
        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Theme management
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;

        // DEFAULT: Dark mode (unless explicitly set to light)
        // Dark mode is default for first visit and all subsequent visits
        if (localStorage.theme === 'light') {
            html.classList.remove('dark');
        } else {
            // Default to dark mode (first visit or saved as dark)
            html.classList.add('dark');
            if (!localStorage.theme) {
                localStorage.theme = 'dark'; // Save default preference
            }
        }

        // Function to update 3D house image based on theme
        function updateHouse3DImage() {
            const house3dImg = document.getElementById('house3dImage');
            if (house3dImg) {
                const isDark = html.classList.contains('dark');
                const newSrc = isDark ? '/images/3dhome/house-3d-dark.png' : '/images/3dhome/house-3d-light.png';
                if (house3dImg.src !== newSrc) {
                    house3dImg.style.opacity = '0.5';
                    house3dImg.src = newSrc;
                    house3dImg.onload = () => {
                        house3dImg.style.opacity = '1';
                    };
                }
            }
        }

        // Initial update for house image
        updateHouse3DImage();

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
            // Update 3D house image when theme changes
            updateHouse3DImage();
        });

        // Update calculator links with current deviceId
        (function updateCalculatorLinks() {
            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            if (deviceId) {
                const calcUrl = '/calculator?deviceId=' + encodeURIComponent(deviceId);

                // Update all calculator links
                ['calcLinkHeader', 'calcLinkCompact', 'calcLinkFAB', 'viewCalculatorLink', 'goToCalculatorBtn'].forEach(id => {
                    const link = document.getElementById(id);
                    if (link) link.href = calcUrl;
                });
            }
        })();

        // ========================================
        // SOLAR PROJECT SUMMARY - Load from API (auto-synced data)
        // Global function - can be called on page load, F5, or device change
        // ========================================
        window.loadSolarProjectSummary = async function (customDeviceId) {
            try {
                // Get deviceId from parameter or URL
                let deviceId = customDeviceId;
                if (!deviceId) {
                    const urlParams = new URLSearchParams(window.location.search);
                    deviceId = (urlParams.get('deviceId') || '').toUpperCase();
                }
                deviceId = (deviceId || '').toUpperCase();

                if (!deviceId) {
                    console.log('No deviceId provided, hiding solar summary');
                    document.getElementById('solarProjectSummary')?.classList.add('hidden');
                    return;
                }

                console.log(`üîÑ Loading solar summary for device: ${deviceId}`);

                // Format functions
                function formatVND(value) {
                    return new Intl.NumberFormat('vi-VN', {
                        style: 'decimal',
                        maximumFractionDigits: 0
                    }).format(value) + ' VNƒê';
                }

                function formatKWh(value) {
                    return new Intl.NumberFormat('vi-VN', {
                        style: 'decimal',
                        maximumFractionDigits: 1
                    }).format(value) + ' kWh';
                }

                // Store chart instance for cleanup
                let summaryChartInstance = null;

                // Function to render the monthly chart with mobile optimization
                function renderSummaryChart(chartData, years = []) {
                    const chartSection = document.getElementById('summaryChartSection');
                    const canvas = document.getElementById('summaryMonthlyChart');
                    const yearBadges = document.getElementById('summaryChartYearBadges');

                    console.log('üìä renderSummaryChart called:', { chartData, years });

                    if (!chartData || !chartData.labels || chartData.labels.length === 0) {
                        console.log('‚ö†Ô∏è No chartData or empty labels, hiding chart');
                        chartSection?.classList.add('hidden');
                        return;
                    }

                    // Show chart section
                    chartSection?.classList.remove('hidden');
                    console.log('‚úÖ Chart section shown, labels:', chartData.labels);

                    // Add year badges
                    if (yearBadges && years.length > 0) {
                        yearBadges.innerHTML = years.map(y =>
                            `<span class="px-2 py-0.5 text-[10px] sm:text-xs font-semibold rounded-full bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300">${y}</span>`
                        ).join('');
                    }

                    try {
                        // Destroy existing chart
                        if (summaryChartInstance) {
                            summaryChartInstance.destroy();
                            summaryChartInstance = null;
                        }

                        const ctx = canvas.getContext('2d');

                        // Check if mobile
                        const isMobile = window.innerWidth < 768;

                        // Chart configuration with mobile optimization
                        summaryChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: chartData.labels,
                                datasets: [
                                    {
                                        label: 'PV (kWh)',
                                        data: chartData.pv || [],
                                        backgroundColor: 'rgba(250, 204, 21, 0.8)',
                                        borderColor: 'rgb(250, 204, 21)',
                                        borderWidth: 1,
                                        borderRadius: 4,
                                        order: 2
                                    },
                                    {
                                        label: 'Load (kWh)',
                                        data: chartData.load || [],
                                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                        borderColor: 'rgb(59, 130, 246)',
                                        borderWidth: 1,
                                        borderRadius: 4,
                                        order: 3
                                    },
                                    {
                                        label: 'Grid (kWh)',
                                        data: chartData.grid || [],
                                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                        borderColor: 'rgb(239, 68, 68)',
                                        borderWidth: 1,
                                        borderRadius: 4,
                                        order: 4
                                    },
                                    {
                                        label: 'Ti·∫øt Ki·ªám (ƒë)',
                                        data: chartData.savings || [],
                                        type: 'line',
                                        yAxisID: 'y1',
                                        borderColor: 'rgb(16, 185, 129)',
                                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: isMobile ? 6 : 4,
                                        pointHoverRadius: isMobile ? 10 : 8,
                                        pointBackgroundColor: 'rgb(16, 185, 129)',
                                        pointBorderColor: '#fff',
                                        pointBorderWidth: 2,
                                        borderWidth: 2,
                                        order: 1
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'index',
                                    intersect: false,
                                    // Mobile touch optimization
                                    axis: 'x'
                                },
                                // Touch/hover optimization for mobile
                                hover: {
                                    mode: 'index',
                                    intersect: false
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        enabled: true,
                                        mode: 'index',
                                        intersect: false,
                                        backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                        titleColor: '#fff',
                                        bodyColor: '#fff',
                                        borderColor: 'rgb(16, 185, 129)',
                                        borderWidth: 1,
                                        cornerRadius: 8,
                                        padding: isMobile ? 12 : 10,
                                        titleFont: { size: isMobile ? 14 : 12, weight: 'bold' },
                                        bodyFont: { size: isMobile ? 13 : 11 },
                                        displayColors: true,
                                        boxWidth: 12,
                                        boxHeight: 12,
                                        usePointStyle: true,
                                        // Larger touch area
                                        caretSize: isMobile ? 8 : 6,
                                        caretPadding: isMobile ? 10 : 6,
                                        callbacks: {
                                            label: function (context) {
                                                const value = context.parsed.y;
                                                if (context.dataset.label.includes('Ti·∫øt Ki·ªám')) {
                                                    return context.dataset.label + ': ' + new Intl.NumberFormat('vi-VN').format(value) + ' ƒë';
                                                }
                                                return context.dataset.label + ': ' + value.toFixed(1) + ' kWh';
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        grid: { display: false },
                                        ticks: {
                                            font: { size: isMobile ? 9 : 10 },
                                            color: '#9CA3AF',
                                            maxRotation: 45,
                                            minRotation: 0
                                        }
                                    },
                                    y: {
                                        position: 'left',
                                        grid: { color: 'rgba(156, 163, 175, 0.2)' },
                                        ticks: {
                                            font: { size: isMobile ? 9 : 10 },
                                            color: '#9CA3AF',
                                            callback: function (value) { return value + ' kWh'; }
                                        },
                                        title: {
                                            display: !isMobile,
                                            text: 'kWh',
                                            font: { size: 10 },
                                            color: '#9CA3AF'
                                        }
                                    },
                                    y1: {
                                        position: 'right',
                                        grid: { drawOnChartArea: false },
                                        ticks: {
                                            font: { size: isMobile ? 9 : 10 },
                                            color: 'rgb(16, 185, 129)',
                                            callback: function (value) {
                                                if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                                if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                                                return value;
                                            }
                                        },
                                        title: {
                                            display: !isMobile,
                                            text: 'VNƒê',
                                            font: { size: 10 },
                                            color: 'rgb(16, 185, 129)'
                                        }
                                    }
                                },
                                // Mobile touch events optimization
                                events: ['mousemove', 'mouseout', 'click', 'touchstart', 'touchmove', 'touchend'],
                                animation: {
                                    duration: 500
                                }
                            }
                        });

                        // Enhanced mobile touch handling
                        if (isMobile) {
                            canvas.addEventListener('touchstart', function (e) {
                                // Prevent scroll when touching chart
                                if (e.touches.length === 1) {
                                    const rect = canvas.getBoundingClientRect();
                                    const touch = e.touches[0];
                                    if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
                                        touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                                        // Show tooltip on touch
                                        const x = touch.clientX - rect.left;
                                        const y = touch.clientY - rect.top;
                                        summaryChartInstance.setActiveElements([]);
                                        summaryChartInstance.tooltip.setActiveElements(
                                            summaryChartInstance.getElementsAtEventForMode(e, 'index', { intersect: false }, false),
                                            { x, y }
                                        );
                                        summaryChartInstance.update('none');
                                    }
                                }
                            }, { passive: true });

                            canvas.addEventListener('touchmove', function (e) {
                                if (e.touches.length === 1) {
                                    const rect = canvas.getBoundingClientRect();
                                    const touch = e.touches[0];
                                    const x = touch.clientX - rect.left;
                                    const y = touch.clientY - rect.top;
                                    summaryChartInstance.tooltip.setActiveElements(
                                        summaryChartInstance.getElementsAtEventForMode(e, 'index', { intersect: false }, false),
                                        { x, y }
                                    );
                                    summaryChartInstance.update('none');
                                }
                            }, { passive: true });
                        }

                        console.log('üìä Summary chart rendered with', chartData.labels.length, 'months');

                    } catch (chartError) {
                        console.error('‚ùå Error rendering chart:', chartError);
                        // Keep chart section visible even if there's an error
                    }
                }

                // Function to update UI with data
                function updateSummaryUI(data, chartData = null, years = []) {
                    document.getElementById('summaryTotalSavings').textContent = formatVND(data.totalSavings);
                    document.getElementById('summaryTotalLoad').textContent = formatKWh(data.totalLoad);
                    document.getElementById('summaryTotalSolar').textContent = formatKWh(data.totalSolarProduced);
                    document.getElementById('summaryTotalGrid').textContent = formatKWh(data.totalGrid);
                    document.getElementById('summaryCostWithoutSolar').textContent = formatVND(data.costWithoutSolar);
                    document.getElementById('summaryAvgSavings').textContent = formatVND(data.avgSavings);

                    // Show section
                    document.getElementById('solarProjectSummary').classList.remove('hidden');

                    // Render chart if chartData is available
                    if (chartData) {
                        renderSummaryChart(chartData, years);
                    } else {
                        document.getElementById('summaryChartSection')?.classList.add('hidden');
                    }
                }

                // Try Cloudflare Worker API first (direct Home Assistant data)
                const CLOUDFLARE_WORKER_TSP = 'https://temperature-soc-power.applike098.workers.dev';
                try {
                    const response = await fetch(`${CLOUDFLARE_WORKER_TSP}/api/solar/dashboard/${deviceId}`);
                    const result = await response.json();

                    if (result.success && result.hasData) {
                        console.log(`‚úÖ Loaded solar summary from Cloudflare Worker (${result.source}) for ${deviceId}`);

                        // Extract years from chartData for badges
                        const years = result.chartData?.labels ?
                            [...new Set(result.chartData.labels.map(l => l.split('/')[1]).filter(Boolean))] :
                            (result.years || []);

                        updateSummaryUI({
                            totalSavings: result.raw.totalSavings,
                            totalLoad: result.raw.totalLoad,
                            totalSolarProduced: result.raw.totalSolarProduced,
                            totalGrid: result.raw.totalGrid,
                            costWithoutSolar: result.raw.costWithoutSolar,
                            avgSavings: result.raw.avgSavings
                        }, result.chartData || null, years);
                        return;
                    } else {
                        console.log(`‚ö†Ô∏è Cloudflare Worker returned no data for ${deviceId}, trying localStorage...`);
                    }
                } catch (apiError) {
                    console.log('Cloudflare Worker not available, falling back to localStorage:', apiError.message);
                }

                // Fallback to localStorage (for backward compatibility)
                const storageKey = `solarSettings_${deviceId}`;
                const savedSettings = localStorage.getItem(storageKey);

                if (!savedSettings) {
                    console.log(`No localStorage data for ${deviceId}, hiding section`);
                    document.getElementById('solarProjectSummary')?.classList.add('hidden');
                    return;
                }

                const settings = JSON.parse(savedSettings);
                if (!settings.monthlyData || settings.monthlyData.length === 0) {
                    document.getElementById('solarProjectSummary')?.classList.add('hidden');
                    return;
                }

                // Calculate from localStorage (same logic as before)
                function calculateTieredPrice(kWh, vatRate) {
                    if (kWh <= 0) return 0;

                    let totalCost = 0;
                    let remaining = kWh;

                    // B·∫≠c 1: 0 - 50 kWh = 1,984 ƒë·ªìng/kWh
                    if (remaining > 0) {
                        const tier1 = Math.min(remaining, 50);
                        totalCost += tier1 * 1984;
                        remaining -= tier1;
                    }

                    // B·∫≠c 2: 51 - 100 kWh = 2,050 ƒë·ªìng/kWh
                    if (remaining > 0) {
                        const tier2 = Math.min(remaining, 50);
                        totalCost += tier2 * 2050;
                        remaining -= tier2;
                    }

                    // B·∫≠c 3: 101 - 200 kWh = 2,380 ƒë·ªìng/kWh
                    if (remaining > 0) {
                        const tier3 = Math.min(remaining, 100);
                        totalCost += tier3 * 2380;
                        remaining -= tier3;
                    }

                    // B·∫≠c 4: 201 - 300 kWh = 2,998 ƒë·ªìng/kWh
                    if (remaining > 0) {
                        const tier4 = Math.min(remaining, 100);
                        totalCost += tier4 * 2998;
                        remaining -= tier4;
                    }

                    // B·∫≠c 5: 301 - 400 kWh = 3,350 ƒë·ªìng/kWh
                    if (remaining > 0) {
                        const tier5 = Math.min(remaining, 100);
                        totalCost += tier5 * 3350;
                        remaining -= tier5;
                    }

                    // B·∫≠c 6: 401+ kWh = 3,460 ƒë·ªìng/kWh
                    if (remaining > 0) {
                        totalCost += remaining * 3460;
                    }

                    return totalCost * (1 + vatRate);
                }

                let totalSavings = 0;
                let totalLoad = 0;
                let totalSolarProduced = 0;
                let totalGrid = 0;
                let totalCostWithoutSolar = 0;
                let monthsWithData = 0;
                const solarPrice = parseFloat(settings.solarPrice) || 0;
                const vatRate = (parseFloat(settings.vatRate) || 8) / 100;

                // Build chartData from localStorage
                const chartLabels = [];
                const chartPv = [];
                const chartLoad = [];
                const chartGrid = [];
                const chartSavings = [];
                const yearsSet = new Set();

                settings.monthlyData.forEach((month, index) => {
                    const load = parseFloat(month.load) || 0;
                    const grid = parseFloat(month.grid) || 0;
                    const backup = parseFloat(month.backup) || 0;

                    if (load > 0 || grid > 0 || backup > 0) {
                        monthsWithData++;

                        // Extract month label from month.month (format: "YYYY-MM" or index-based)
                        let label = `T${index + 1}`;
                        let year = new Date().getFullYear();
                        if (month.month && month.month.includes('-')) {
                            const [y, m] = month.month.split('-');
                            label = `T${parseInt(m)}/${y}`;
                            year = y;
                        }
                        chartLabels.push(label);
                        yearsSet.add(year);
                    }

                    const totalConsumption = load + backup;
                    const solarProduced = Math.max(0, totalConsumption - grid);
                    const gridCost = calculateTieredPrice(grid, vatRate);
                    const costWithoutSolar = calculateTieredPrice(totalConsumption, vatRate);
                    const solarCost = solarProduced * solarPrice;
                    const actualCost = gridCost + solarCost;
                    const savings = costWithoutSolar - actualCost;

                    if (load > 0 || grid > 0 || backup > 0) {
                        chartPv.push(Math.round(solarProduced * 10) / 10);
                        chartLoad.push(Math.round(load * 10) / 10);
                        chartGrid.push(Math.round(grid * 10) / 10);
                        chartSavings.push(Math.round(savings));
                    }

                    totalSavings += savings;
                    totalLoad += load;
                    totalSolarProduced += solarProduced;
                    totalGrid += grid;
                    totalCostWithoutSolar += costWithoutSolar;
                });

                const avgSavings = monthsWithData > 0 ? totalSavings / monthsWithData : 0;

                // Build chartData object
                const localChartData = chartLabels.length > 0 ? {
                    labels: chartLabels,
                    pv: chartPv,
                    load: chartLoad,
                    grid: chartGrid,
                    savings: chartSavings
                } : null;

                if (monthsWithData > 0) {
                    console.log(`‚úÖ Loaded solar summary from localStorage for ${deviceId}`);
                    updateSummaryUI({
                        totalSavings,
                        totalLoad,
                        totalSolarProduced,
                        totalGrid,
                        costWithoutSolar: totalCostWithoutSolar,
                        avgSavings
                    }, localChartData, [...yearsSet]);
                } else {
                    document.getElementById('solarProjectSummary')?.classList.add('hidden');
                }

            } catch (e) {
                console.error('Error loading solar summary:', e);
                document.getElementById('solarProjectSummary')?.classList.add('hidden');
            }
        };

        // Call on page load
        window.loadSolarProjectSummary();

        // ========================================
        // TELEGRAM NOTIFICATION SETTINGS
        // ========================================
        const TELEGRAM_BOT_API = 'https://lightearth-telegram-bot.applike098.workers.dev';

        // SHORT LOCATION CODES for Deep Link v1.9.0
        const LOCATION_CODES = {
            'TP. Ho Chi Minh': 'hcm', 'Ha Noi': 'hn', 'Da Nang': 'dng', 'Can Tho': 'ct',
            'Binh Duong': 'bd', 'Tay Ninh': 'tn', 'Dong Nai': 'dn', 'Lam Dong': 'dl',
            'Long An': 'la', 'Tien Giang': 'tg', 'Ben Tre': 'bt', 'Vinh Long': 'vl',
            'Tra Vinh': 'tv', 'Dong Thap': 'dt', 'An Giang': 'ag', 'Kien Giang': 'kg',
            'Hau Giang': 'hg', 'Soc Trang': 'st', 'Bac Lieu': 'bl', 'Ca Mau': 'cm',
            'Ba Ria - Vung Tau': 'brvt', 'Binh Phuoc': 'bp', 'Thua Thien Hue': 'tth',
            'Quang Nam': 'qna', 'Quang Ngai': 'qng', 'Binh Dinh': 'bdi', 'Phu Yen': 'py',
            'Khanh Hoa': 'kh', 'Ninh Thuan': 'nt', 'Binh Thuan': 'bth', 'Quang Binh': 'qb',
            'Quang Tri': 'qt', 'Ha Tinh': 'hti', 'Nghe An': 'na', 'Thanh Hoa': 'th',
            'Kon Tum': 'kt', 'Gia Lai': 'gl', 'Dak Lak': 'dlk', 'Dak Nong': 'dno',
            'Hai Phong': 'hp', 'Quang Ninh': 'qni', 'Bac Giang': 'bg', 'Bac Ninh': 'bn',
            'Hai Duong': 'hdu', 'Hung Yen': 'hy', 'Thai Binh': 'tb', 'Nam Dinh': 'nd',
            'Ninh Binh': 'nb', 'Ha Nam': 'hna', 'Vinh Phuc': 'vp', 'Phu Tho': 'pt',
            'Thai Nguyen': 'tnu', 'Bac Kan': 'bk', 'Cao Bang': 'cb', 'Lang Son': 'ls',
            'Tuyen Quang': 'tqu', 'Ha Giang': 'hgi', 'Yen Bai': 'yb', 'Lao Cai': 'lc',
            'Lai Chau': 'lch', 'Dien Bien': 'db', 'Son La': 'sla', 'Hoa Binh': 'hbi'
        };

        // Convert notification settings to 6-bit string
        function getNotificationBits() {
            return [
                document.getElementById('tgMorningGreeting').checked ? '1' : '0',
                document.getElementById('tgPowerOutage').checked ? '1' : '0',
                document.getElementById('tgPowerRestored').checked ? '1' : '0',
                document.getElementById('tgLowBattery').checked ? '1' : '0',
                document.getElementById('tgPvEnded').checked ? '1' : '0',
                document.getElementById('tgHourlyStatus').checked ? '1' : '0'
            ].join('');
        }

        // Build SHORT deep link (max 64 chars) - v2.0 format with voltage
        // Format: add_DEVICEID_NNNNNN_bf_bl_pv_gr_ld_vh_vl_loc
        // v2.4: Voltage * 10 trong Deep Link (54.7V -> 547)
        // Telegram ch·ªâ cho ph√©p: A-Z, a-z, 0-9, _, - (KH√îNG cho d·∫•u ch·∫•m)
        function buildShortDeepLink(deviceId, thresholds, location) {
            const notifBits = getNotificationBits();
            const locCode = LOCATION_CODES[location] || 'hcm';
            const bf = Math.round(thresholds.batteryFull);
            const bl = Math.round(thresholds.batteryLow);
            const pv = Math.round(thresholds.pvDaily);
            const gr = Math.round(thresholds.gridUsage);
            const ld = Math.round(thresholds.loadDaily);
            // v2.4: Nh√¢n 10 ƒë·ªÉ tr√°nh d·∫•u ch·∫•m (54.7 -> 547)
            const vh = Math.round((thresholds.batteryVoltHigh || 0) * 10);
            const vl = Math.round((thresholds.batteryVoltLow || 0) * 10);

            const payload = `add_${deviceId}_${notifBits}_${bf}_${bl}_${pv}_${gr}_${ld}_${vh}_${vl}_${locCode}`;
            console.log('Short Deep Link v2.4:', payload, `(${payload.length} chars)`);
            return payload;
        }

        // Show telegram section when device is selected
        window.initTelegramSettings = async function () {
            // Priority: URL params > localStorage
            const urlParams = new URLSearchParams(window.location.search);
            let deviceId = urlParams.get('deviceId') || localStorage.getItem('selectedDevice');
            if (deviceId) deviceId = deviceId.toUpperCase();
            if (!deviceId) return;

            // Save to localStorage for future use
            localStorage.setItem('selectedDevice', deviceId);

            const section = document.getElementById('telegramSettingsSection');
            if (!section) return;

            // Show section
            section.classList.remove('hidden');

            // Load existing settings from Bot API
            try {
                const response = await fetch(`${TELEGRAM_BOT_API}/api/device-settings?deviceId=${deviceId}`);
                const result = await response.json();

                if (result.success && result.settings) {
                    const s = result.settings;
                    document.getElementById('tgMorningGreeting').checked = s.morningGreeting !== false;
                    document.getElementById('tgPowerOutage').checked = s.powerOutage !== false;
                    document.getElementById('tgPowerRestored').checked = s.powerRestored !== false;
                    document.getElementById('tgLowBattery').checked = s.lowBattery !== false;
                    document.getElementById('tgPvEnded').checked = s.pvEnded !== false;
                    document.getElementById('tgHourlyStatus').checked = s.hourlyStatus === true;

                    if (result.location) {
                        document.getElementById('tgLocation').value = result.location;
                    }

                    // Load thresholds - only show if device has custom thresholds
                    if (result.thresholds) {
                        const th = result.thresholds;
                        // Only show non-default values to encourage user to set their own
                        if (th.batteryFull !== undefined && th.batteryFull !== 100) {
                            document.getElementById('thBatteryFull').value = th.batteryFull;
                        }
                        if (th.batteryLow !== undefined && th.batteryLow !== 20) {
                            document.getElementById('thBatteryLow').value = th.batteryLow;
                        }
                        if (th.pvDaily !== undefined && th.pvDaily !== 0) {
                            document.getElementById('thPvDaily').value = th.pvDaily;
                        }
                        if (th.gridUsage !== undefined && th.gridUsage !== 0) {
                            document.getElementById('thGridUsage').value = th.gridUsage;
                        }
                        if (th.loadDaily !== undefined && th.loadDaily !== 0) {
                            document.getElementById('thLoadDaily').value = th.loadDaily;
                        }
                        if (th.batteryVoltHigh !== undefined && th.batteryVoltHigh !== 0) {
                            document.getElementById('thBatteryVoltHigh').value = th.batteryVoltHigh;
                        }
                        if (th.batteryVoltLow !== undefined && th.batteryVoltLow !== 0) {
                            document.getElementById('thBatteryVoltLow').value = th.batteryVoltLow;
                        }
                    }

                    // Update status
                    const statusEl = document.getElementById('telegramStatus');
                    statusEl.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi';
                    statusEl.className = 'text-xs px-2 py-1 rounded-full bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-400';
                }
            } catch (e) {
                console.log('Could not load telegram settings:', e.message);
            }
        };

        // Save settings - Show modal to open Telegram Bot
        document.getElementById('saveTelegramSettings')?.addEventListener('click', async function () {
            // Priority: URL params > localStorage
            const urlParams = new URLSearchParams(window.location.search);
            let deviceId = urlParams.get('deviceId') || localStorage.getItem('selectedDevice');
            if (deviceId) deviceId = deviceId.toUpperCase();
            if (!deviceId) {
                alert('Vui l√≤ng ch·ªçn thi·∫øt b·ªã tr∆∞·ªõc!');
                return;
            }

            // Show success modal and prompt to open Telegram
            const modal = document.getElementById('tgSuccessModal');
            document.getElementById('tgModalDeviceId').textContent = deviceId;
            modal.classList.add('active');

            // Change button state
            const btn = this;
            btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> ƒê√£ l∆∞u!';
            btn.className = btn.className.replace('from-sky-500 to-blue-500', 'from-green-500 to-emerald-500');

            setTimeout(() => {
                btn.innerHTML = '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.692-1.653-1.123-2.678-1.799-1.185-.781-.417-1.21.258-1.911.177-.184 3.247-2.977 3.307-3.23.007-.032.015-.15-.056-.212s-.174-.041-.248-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.009-1.252-.242-1.865-.442-.751-.244-1.349-.374-1.297-.789.027-.216.324-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.015 3.333-1.386 4.025-1.627 4.477-1.635.099-.002.321.023.465.141.121.1.154.234.169.332.016.098.035.32.019.493z"/></svg> L∆∞u C√†i ƒê·∫∑t Telegram Bot';
                btn.className = btn.className.replace('from-green-500 to-emerald-500', 'from-sky-500 to-blue-500');
            }, 2000);
        });

        // Modal: Open Telegram Bot button
        document.getElementById('tgModalOpenBot')?.addEventListener('click', async function () {
            // Get device ID
            const urlParams = new URLSearchParams(window.location.search);
            let deviceId = urlParams.get('deviceId') || localStorage.getItem('selectedDevice');
            if (deviceId) deviceId = deviceId.toUpperCase();

            // Get current settings
            const settings = [];
            if (document.getElementById('tgMorningGreeting').checked) settings.push('mg');
            if (document.getElementById('tgPowerOutage').checked) settings.push('po');
            if (document.getElementById('tgPowerRestored').checked) settings.push('pr');
            if (document.getElementById('tgLowBattery').checked) settings.push('lb');
            if (document.getElementById('tgPvEnded').checked) settings.push('pe');
            if (document.getElementById('tgHourlyStatus').checked) settings.push('hs');

            // Get location and thresholds
            // Helper function to properly parse threshold values
            // Returns the value if valid number (including 0), otherwise returns default
            function getThresholdValue(elementId, defaultValue) {
                const el = document.getElementById(elementId);
                const val = el ? parseFloat(el.value) : NaN;
                return !isNaN(val) ? val : defaultValue;
            }

            const location = document.getElementById('tgLocation').value;
            const thresholds = {
                batteryFull: getThresholdValue('thBatteryFull', 100),
                batteryLow: getThresholdValue('thBatteryLow', 20),
                pvDaily: getThresholdValue('thPvDaily', 0),
                gridUsage: getThresholdValue('thGridUsage', 0),
                loadDaily: getThresholdValue('thLoadDaily', 0),
                batteryVoltHigh: getThresholdValue('thBatteryVoltHigh', 0),
                batteryVoltLow: getThresholdValue('thBatteryVoltLow', 0)
            };

            // Save thresholds via API (for existing devices)
            try {
                await fetch(`${TELEGRAM_BOT_API}/api/update-settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceId, thresholds })
                });
            } catch (e) {
                console.log('Thresholds will be saved when device is added via Telegram');
            }

            // Build SHORT deep link v1.9.0 (max 64 chars)
            // Format: add_DEVICEID_NNNNNN_bf_bl_pv_gr_ld_loc
            const payload = buildShortDeepLink(deviceId, thresholds, location);
            const telegramUrl = `https://t.me/lightearth_bot?start=${encodeURIComponent(payload)}`;

            // Close modal and open Telegram
            document.getElementById('tgSuccessModal').classList.remove('active');
            window.open(telegramUrl, '_blank');
        });

        // Modal: Close button
        document.getElementById('tgModalClose')?.addEventListener('click', function () {
            document.getElementById('tgSuccessModal').classList.remove('active');
        });

        // Close modal when clicking overlay
        document.getElementById('tgSuccessModal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });

        // Initialize telegram settings on load
        window.initTelegramSettings();

        // Update Telegram Bot link with device ID and settings
        document.getElementById('openTelegramBot')?.addEventListener('click', async function (e) {
            e.preventDefault();

            // Get device ID
            const urlParams = new URLSearchParams(window.location.search);
            let deviceId = urlParams.get('deviceId') || localStorage.getItem('selectedDevice');
            if (deviceId) deviceId = deviceId.toUpperCase();

            if (!deviceId) {
                alert('Vui l√≤ng ch·ªçn thi·∫øt b·ªã tr∆∞·ªõc!');
                return;
            }

            // Get location and thresholds
            // Helper function to properly parse threshold values
            // Returns the value if valid number (including 0), otherwise returns default
            function getThresholdValue(elementId, defaultValue) {
                const el = document.getElementById(elementId);
                const val = el ? parseFloat(el.value) : NaN;
                return !isNaN(val) ? val : defaultValue;
            }

            const location = document.getElementById('tgLocation').value;
            const thresholds = {
                batteryFull: getThresholdValue('thBatteryFull', 100),
                batteryLow: getThresholdValue('thBatteryLow', 20),
                pvDaily: getThresholdValue('thPvDaily', 0),
                gridUsage: getThresholdValue('thGridUsage', 0),
                loadDaily: getThresholdValue('thLoadDaily', 0),
                batteryVoltHigh: getThresholdValue('thBatteryVoltHigh', 0),
                batteryVoltLow: getThresholdValue('thBatteryVoltLow', 0)
            };

            // Save thresholds via API (for existing devices)
            try {
                await fetch(`${TELEGRAM_BOT_API}/api/update-settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceId, thresholds })
                });
            } catch (e) {
                console.log('Thresholds will be saved when device is added via Telegram');
            }

            // Build SHORT deep link v1.9.0 (max 64 chars)
            // Format: add_DEVICEID_NNNNNN_bf_bl_pv_gr_ld_loc
            const payload = buildShortDeepLink(deviceId, thresholds, location);
            const telegramUrl = `https://t.me/lightearth_bot?start=${encodeURIComponent(payload)}`;

            // Open Telegram
            window.open(telegramUrl, '_blank');
        });

        // ========================================
        // HEADER SCROLL HIDE - Always hide when scrolled
        // ========================================
        (function () {
            const header = document.getElementById('mainHeader');

            function handleHeaderScroll() {
                if (header) {
                    if (window.scrollY > 50) {
                        // Scrolled down - hide header
                        header.classList.add('header-hidden');
                    } else {
                        // At top - show header
                        header.classList.remove('header-hidden');
                    }
                }
            }

            window.addEventListener('scroll', handleHeaderScroll, { passive: true });
        })();
    </script>


    <!-- CSS first for fast rendering -->
    <link href="css/index.css" rel="stylesheet" crossorigin />

    <!-- SignalR Client Library - defer -->
    <script src="https://unpkg.com/@microsoft/signalr@latest" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="js/index.js" defer crossorigin></script>

    <!-- Monthly Savings Popup Modal -->
    <div id="monthlySavingsPopup" class="fixed inset-0 z-[9999] hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeMonthlySavingsPopup()"></div>
        <!-- Modal - wider on PC -->
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md lg:max-w-xl max-h-[80vh] bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-emerald-200 dark:border-emerald-700 overflow-hidden">
            <!-- Header - larger text on PC -->
            <div
                class="flex items-center justify-between px-4 py-3 lg:px-6 lg:py-4 bg-gradient-to-r from-emerald-500 to-green-500 text-white">
                <h3 class="text-sm lg:text-base font-bold">üìã Chi Ti·∫øt Ti·∫øt Ki·ªám T·ª´ng Th√°ng</h3>
                <button onclick="closeMonthlySavingsPopup()"
                    class="p-1 hover:bg-white/20 rounded-full transition-colors">
                    <svg class="w-5 h-5 lg:w-6 lg:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- Content - more padding & centered on PC -->
            <div id="monthlySavingsContent" class="p-4 lg:p-6 max-h-[60vh] overflow-y-auto lg:text-center">
                <p class="text-slate-500 dark:text-slate-400 text-sm lg:text-base">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
        </div>
    </div>

    <script>
        // Global variable to store chart data for popup
        let chartDataForPopup = null;

        async function showMonthlySavingsPopup() {
            const popup = document.getElementById('monthlySavingsPopup');
            const content = document.getElementById('monthlySavingsContent');

            if (!popup || !content) return;

            // Show popup immediately with loading state
            content.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-sm text-center py-4">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ h·ªá th·ªëng...</p>';
            popup.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Get deviceId from URL
            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            if (!deviceId) {
                content.innerHTML = '<p class="text-red-500 text-sm text-center py-4">‚ùå Kh√¥ng t√¨m th·∫•y Device ID</p>';
                return;
            }

            let html = '';
            let dataFound = false;

            // Try to fetch from Cloudflare Worker API
            try {
                const CLOUDFLARE_API = 'https://temperature-soc-power.applike098.workers.dev';
                const response = await fetch(`${CLOUDFLARE_API}/api/solar/dashboard/${deviceId}`);
                const result = await response.json();

                if (result.success && result.hasData && result.chartData) {
                    const labels = result.chartData.labels || [];
                    const savingsData = result.chartData.savings || [];

                    if (labels.length > 0 && savingsData.length > 0) {
                        dataFound = true;
                        html += '<div class="space-y-2 lg:space-y-3">';
                        let total = 0;
                        labels.forEach((label, i) => {
                            const savings = savingsData[i] || 0;
                            total += savings;
                            html += `
                                <div class="flex justify-between items-center py-2 px-3 lg:py-3 lg:px-4 rounded-lg ${i % 2 === 0 ? 'bg-emerald-50 dark:bg-emerald-900/20' : 'bg-slate-50 dark:bg-slate-700/30'}">
                                    <span class="text-sm lg:text-base font-medium text-slate-700 dark:text-slate-300">${label}</span>
                                    <span class="text-sm lg:text-base font-bold text-emerald-600 dark:text-emerald-400">${new Intl.NumberFormat('vi-VN').format(Math.round(savings))}ƒë</span>
                                </div>
                            `;
                        });
                        html += '</div>';
                        html += `
                            <div class="mt-4 lg:mt-6 pt-4 lg:pt-5 border-t border-emerald-200 dark:border-emerald-700">
                                <div class="flex justify-between lg:justify-center lg:gap-4 items-center">
                                    <span class="text-sm lg:text-base font-semibold text-slate-700 dark:text-slate-300">üí∞ T·ªïng c·ªông:</span>
                                    <span class="text-lg lg:text-xl font-black text-emerald-600 dark:text-emerald-400">${new Intl.NumberFormat('vi-VN').format(Math.round(total))}ƒë</span>
                                </div>
                                <p class="text-[10px] lg:text-xs text-slate-500 dark:text-slate-400 mt-1 lg:mt-2">EVN 6 b·∫≠c + 8% VAT | Ngu·ªìn: Lumentree API</p>
                            </div>
                        `;
                    }
                }
            } catch (apiError) {
                console.log('API fetch failed, trying chart instance:', apiError);
            }

            // Fallback to chart instance if API failed
            if (!dataFound && typeof summaryChartInstance !== 'undefined' && summaryChartInstance && summaryChartInstance.data) {
                const labels = summaryChartInstance.data.labels || [];
                const savingsData = summaryChartInstance.data.datasets?.find(d => d.label?.includes('Ti·∫øt Ki·ªám'))?.data || [];

                if (labels.length > 0 && savingsData.length > 0) {
                    dataFound = true;
                    html += '<div class="space-y-2">';
                    let total = 0;
                    labels.forEach((label, i) => {
                        const savings = savingsData[i] || 0;
                        total += savings;
                        html += `
                            <div class="flex justify-between items-center py-2 px-3 rounded-lg ${i % 2 === 0 ? 'bg-emerald-50 dark:bg-emerald-900/20' : 'bg-slate-50 dark:bg-slate-700/30'}">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">${label}</span>
                                <span class="text-sm font-bold text-emerald-600 dark:text-emerald-400">${new Intl.NumberFormat('vi-VN').format(Math.round(savings))}ƒë</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                    html += `
                        <div class="mt-4 pt-4 border-t border-emerald-200 dark:border-emerald-700">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-semibold text-slate-700 dark:text-slate-300">üí∞ T·ªïng c·ªông:</span>
                                <span class="text-lg font-black text-emerald-600 dark:text-emerald-400">${new Intl.NumberFormat('vi-VN').format(Math.round(total))}ƒë</span>
                            </div>
                            <p class="text-[10px] text-slate-500 dark:text-slate-400 mt-1">EVN 6 b·∫≠c + 8% VAT | Ngu·ªìn: Chart</p>
                        </div>
                    `;
                }
            }

            if (!dataFound) {
                html = `
                    <div class="text-center py-4">
                        <p class="text-slate-500 dark:text-slate-400 text-sm mb-3">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>
                        <p class="text-xs text-slate-400 dark:text-slate-500">Vui l√≤ng ƒë·ªìng b·ªô t·ª´ Calculator (Lumentree) tr∆∞·ªõc.</p>
                        <a href="/calculator.html?deviceId=${deviceId}" target="_blank" 
                           class="inline-block mt-3 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition-colors">
                            üìä M·ªü Calculator
                        </a>
                    </div>
                `;
            }

            content.innerHTML = html;
        }

        function closeMonthlySavingsPopup() {
            const popup = document.getElementById('monthlySavingsPopup');
            if (popup) {
                popup.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeMonthlySavingsPopup();
        });

        // EVN 6-tier pricing calculation (for popup)
        function calculateTieredPricePopup(kWh) {
            if (!kWh || kWh <= 0) return 0;

            let totalCost = 0;
            let remaining = kWh;

            // B·∫≠c 1: 0-50 kWh = 1,984ƒë
            if (remaining > 0) { const t = Math.min(remaining, 50); totalCost += t * 1984; remaining -= t; }
            // B·∫≠c 2: 51-100 kWh = 2,050ƒë
            if (remaining > 0) { const t = Math.min(remaining, 50); totalCost += t * 2050; remaining -= t; }
            // B·∫≠c 3: 101-200 kWh = 2,380ƒë
            if (remaining > 0) { const t = Math.min(remaining, 100); totalCost += t * 2380; remaining -= t; }
            // B·∫≠c 4: 201-300 kWh = 2,998ƒë
            if (remaining > 0) { const t = Math.min(remaining, 100); totalCost += t * 2998; remaining -= t; }
            // B·∫≠c 5: 301-400 kWh = 3,350ƒë
            if (remaining > 0) { const t = Math.min(remaining, 100); totalCost += t * 3350; remaining -= t; }
            // B·∫≠c 6: 401+ kWh = 3,460ƒë
            if (remaining > 0) { totalCost += remaining * 3460; }

            return totalCost * 1.08; // +8% VAT
        }

        // Generic monthly detail popup for load, pv, grid
        async function showMonthlyDetailPopup(dataType) {
            const popup = document.getElementById('monthlySavingsPopup');
            const content = document.getElementById('monthlySavingsContent');
            const header = popup?.querySelector('h3');

            if (!popup || !content) return;

            // Set header based on type
            const titles = {
                'load': '‚ö° Chi Ti·∫øt ƒêi·ªán Ti√™u Th·ª•',
                'pv': '‚òÄÔ∏è Chi Ti·∫øt ƒêi·ªán Solar',
                'grid': 'üîå Chi Ti·∫øt ƒêi·ªán L∆∞·ªõi EVN',
                'costWithoutSolar': 'üìâ Chi Ph√≠ N·∫øu Kh√¥ng C√≥ Solar'
            };
            const isMoney = dataType === 'costWithoutSolar';
            const units = isMoney ? 'ƒë' : 'kWh';

            if (header) header.textContent = titles[dataType] || 'üìã Chi Ti·∫øt T·ª´ng Th√°ng';

            // Show popup with loading
            content.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-sm text-center py-4">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ h·ªá th·ªëng...</p>';
            popup.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Get deviceId
            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            if (!deviceId) {
                content.innerHTML = '<p class="text-red-500 text-sm text-center py-4">‚ùå Kh√¥ng t√¨m th·∫•y Device ID</p>';
                return;
            }

            let html = '';
            let dataFound = false;

            try {
                const CLOUDFLARE_API = 'https://temperature-soc-power.applike098.workers.dev';
                const response = await fetch(`${CLOUDFLARE_API}/api/solar/dashboard/${deviceId}`);
                const result = await response.json();

                if (result.success && result.hasData && result.chartData) {
                    const labels = result.chartData.labels || [];

                    // For costWithoutSolar, calculate from load values using tiered pricing
                    let dataArray;
                    if (dataType === 'costWithoutSolar') {
                        const loadArray = result.chartData.load || [];
                        dataArray = loadArray.map(load => calculateTieredPricePopup(load));
                    } else {
                        dataArray = result.chartData[dataType] || [];
                    }

                    if (labels.length > 0 && dataArray.length > 0) {
                        dataFound = true;
                        html += '<div class="space-y-2 lg:space-y-3">';
                        let total = 0;
                        labels.forEach((label, i) => {
                            const value = dataArray[i] || 0;
                            total += value;
                            const displayValue = isMoney
                                ? new Intl.NumberFormat('vi-VN').format(Math.round(value)) + 'ƒë'
                                : value.toFixed(1) + ' ' + units;
                            html += `
                                <div class="flex justify-between items-center py-2 px-3 lg:py-3 lg:px-4 rounded-lg ${i % 2 === 0 ? 'bg-emerald-50 dark:bg-emerald-900/20' : 'bg-slate-50 dark:bg-slate-700/30'}">
                                    <span class="text-sm lg:text-base font-medium text-slate-700 dark:text-slate-300">${label}</span>
                                    <span class="text-sm lg:text-base font-bold text-emerald-600 dark:text-emerald-400">${displayValue}</span>
                                </div>
                            `;
                        });
                        html += '</div>';
                        const totalDisplay = isMoney
                            ? new Intl.NumberFormat('vi-VN').format(Math.round(total)) + 'ƒë'
                            : total.toFixed(1) + ' ' + units;
                        html += `
                            <div class="mt-4 lg:mt-6 pt-4 lg:pt-5 border-t border-emerald-200 dark:border-emerald-700">
                                <div class="flex justify-between lg:justify-center lg:gap-4 items-center">
                                    <span class="text-sm lg:text-base font-semibold text-slate-700 dark:text-slate-300">üìä T·ªïng c·ªông:</span>
                                    <span class="text-lg lg:text-xl font-black text-emerald-600 dark:text-emerald-400">${totalDisplay}</span>
                                </div>
                                <p class="text-[10px] lg:text-xs text-slate-500 dark:text-slate-400 mt-1 lg:mt-2">Ngu·ªìn: Lumentree API${isMoney ? ' | EVN 6 b·∫≠c + VAT' : ''}</p>
                            </div>
                        `;
                    }
                }
            } catch (apiError) {
                console.log('API fetch failed:', apiError);
            }

            if (!dataFound) {
                html = `
                    <div class="text-center py-4">
                        <p class="text-slate-500 dark:text-slate-400 text-sm mb-3">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>
                        <a href="/calculator.html?deviceId=${deviceId}" target="_blank" 
                           class="inline-block mt-3 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition-colors">
                            üìä M·ªü Calculator
                        </a>
                    </div>
                `;
            }

            content.innerHTML = html;
        }
    </script>

</body>

</html>