const API_POOL=[{name:"Realtime-1 (applike098)",worker:"https://realtime.applike098.workers.dev",tsp:"https://temperature-soc-power.applike098.workers.dev",failCount:0,disabled:!1,priority:1},{name:"Realtime-2 (dimencity996)",worker:"https://realtime.dimencity996.workers.dev",tsp:"https://temperature-soc-power.minhlongt358.workers.dev",failCount:0,disabled:!1,priority:1},{name:"Realtime-3 (jeniphernen)",worker:"https://realtime.jeniphernen.workers.dev",tsp:"https://temperature-soc-power.applike098.workers.dev",failCount:0,disabled:!1,priority:1},{name:"Full-1 (applike098)",worker:"https://lightearth.applike098.workers.dev",tsp:"https://temperature-soc-power.applike098.workers.dev",failCount:0,disabled:!1,priority:2},{name:"Full-2 (minhlongt358)",worker:"https://lightearth-proxy.minhlongt358.workers.dev",tsp:"https://temperature-soc-power.minhlongt358.workers.dev",failCount:0,disabled:!1,priority:2}];let currentApiIndex=0;const MAX_FAILS_PER_API=2,POLLING_INTERVAL=4e3,ROTATION_THRESHOLD=5;let currentApiSuccessCount=0,lastSuccessfulApiName=null;const DAILY_ENERGY_API="https://temperature-soc-power.applike098.workers.dev";let latestRealtimeData={},deviceNotFoundShown=!1,previousValues={},powerTimelineChart=null,powerStackedChart=null,activeChartNumber=1,cachedChartData=null,tempChartInstance=null,activeSocTempTab="soc",lastHapticTime=0;const HAPTIC_THROTTLE_MS=100;let cachedTempData=null,temperatureCache={data:null,timestamp:0,deviceId:null,date:null},socCache={data:null,timestamp:0,deviceId:null,date:null},socChartInstance=null,socData=[],socApiStats={min:null,max:null,minTime:null,maxTime:null},lastCellsFetch=0,socAutoReloadInterval=null;const CELLS_FETCH_INTERVAL=5e3,LIGHTEARTH_PROXY_API="https://lightearth-proxy.minhlongt358.workers.dev";function triggerHaptic(e=5){const t=Date.now();if(navigator.vibrate&&t-lastHapticTime>100)try{navigator.vibrate(e),lastHapticTime=t}catch(e){}}function getNextHealthyApi(){for(let e=0;e<API_POOL.length;e++){const t=(currentApiIndex+e)%API_POOL.length;if(!API_POOL[t].disabled)return currentApiIndex=t,API_POOL[t]}return console.warn("‚ö†Ô∏è All APIs disabled, resetting..."),API_POOL.forEach(e=>{e.disabled=!1,e.failCount=0}),currentApiIndex=0,API_POOL[0]}setTimeout(()=>{const e=document.getElementById("socChartBtn");e&&(e.click(),console.log("üîî Auto-clicked SOC button to enable haptic feedback"))},1500);let lastUsedApiIndex=-1,lastUsedPriority1Index=-1,lastUsedPriority2Index=-1;function getAlternatingHealthyApi(){const e=API_POOL.filter(e=>1===e.priority&&!e.disabled),t=API_POOL.filter(e=>2===e.priority&&!e.disabled);if(e.length>0){lastUsedPriority1Index=(lastUsedPriority1Index+1)%e.length;const t=e[lastUsedPriority1Index];return console.log(`üöÄ Using ${t.name} (Priority 1 - Realtime)`),t}if(t.length>0){lastUsedPriority2Index=(lastUsedPriority2Index+1)%t.length;const e=t[lastUsedPriority2Index];return console.log(`üîÑ Using ${e.name} (Priority 2 - Fallback)`),e}return console.warn("‚ö†Ô∏è All APIs disabled, resetting..."),API_POOL.forEach(e=>{e.disabled=!1,e.failCount=0}),lastUsedPriority1Index=0,lastUsedPriority2Index=-1,API_POOL[0]}function getRandomHealthyApi(e=null){const t=API_POOL.filter(e=>1===e.priority&&!e.disabled),a=API_POOL.filter(e=>2===e.priority&&!e.disabled);let n=t.length>0?t:a;if(n.length>1&&e&&(n=n.filter(t=>t.name!==e)),0===n.length)return console.warn("‚ö†Ô∏è No healthy APIs for random selection, resetting..."),API_POOL.forEach(e=>{e.disabled=!1,e.failCount=0}),API_POOL[0];const o=n[Math.floor(Math.random()*n.length)];return console.log(`üé≤ Random API rotation: ${o.name} (from ${n.length} candidates)`),o}function getCurrentWorkerAPI(){return getAlternatingHealthyApi().worker}function getCurrentWorkerTSP(){return getAlternatingHealthyApi().tsp}function getCurrentPollingInterval(){return 4e3}function markApiFailed(e){const t=API_POOL.find(t=>e.includes(t.worker.replace("https://","").split(".")[0]));t&&(t.failCount++,console.warn(`‚ö†Ô∏è ${t.name} fail count: ${t.failCount}/2`),t.failCount>=2&&(t.disabled=!0,console.error(`‚ùå ${t.name} DISABLED after 2 failures`)))}function markApiSuccess(e){const t=API_POOL.find(t=>e.includes(t.worker.replace("https://","").split(".")[0]));t&&t.failCount>0&&(t.failCount=0,console.log(`‚úÖ ${t.name} recovered, fail count reset`))}function switchToFallbackAPI(){}function tryPrimaryAPI(){}window.switchEnergyFlowView=function(e){console.log("[switchEnergyFlowView] Called with view:",e);const t=document.getElementById("energyFlowPro"),a=document.getElementById("energyFlowBasic"),n=document.getElementById("energyFlow3DHome"),o=document.getElementById("proViewBtn"),l=document.getElementById("basicViewBtn"),r=document.getElementById("home3DViewBtn");if(!t||!a)return console.warn("Energy flow views not found, retrying in 100ms..."),void setTimeout(()=>window.switchEnergyFlowView(e),100);const s=e=>{e&&(e.classList.remove("text-slate-600","dark:text-slate-300","hover:text-slate-800","dark:hover:text-slate-100"),e.classList.add("bg-teal-500","text-white","shadow-sm"))};t.classList.add("hidden"),a.classList.add("hidden"),n&&n.classList.add("hidden"),(()=>{const e=["text-slate-600","dark:text-slate-300","hover:text-slate-800","dark:hover:text-slate-100"],t=["bg-teal-500","text-white","shadow-sm"];[o,l,r].forEach(a=>{a&&(a.classList.remove(...t),a.classList.add(...e))})})(),"basic"===e?(a.classList.remove("hidden"),s(l),"function"==typeof window.autoSyncBasicView&&window.autoSyncBasicView()):"3dhome"===e&&n?(n.classList.remove("hidden"),s(r),"function"==typeof window.autoSync3DHomeView&&window.autoSync3DHomeView()):(t.classList.remove("hidden"),s(o)),localStorage.setItem("energyFlowView",e),console.log("Energy flow view switched to:",e)},window.autoSync3DHomeView=function(){const e=document.getElementById("pv-power")?.textContent||"--W",t=document.getElementById("grid-power")?.textContent||"--W",a=document.getElementById("battery-percent-icon")?.textContent||"--%",n=document.getElementById("battery-power")?.textContent||"--W",o=document.getElementById("battery-voltage-pro")?.textContent||"--V",l=document.getElementById("battery-current-pro")?.textContent||"--A",r=document.getElementById("load-power")?.textContent||"--W",s=document.getElementById("essential-power")?.textContent||"--W";let i="--W",d="--W",c="--V",g="--V";latestRealtimeData&&latestRealtimeData.pv1Power&&(i=latestRealtimeData.pv1Power+"W",c=(latestRealtimeData.pv1Voltage||0)+"V"),latestRealtimeData&&latestRealtimeData.pv2Power&&(d=latestRealtimeData.pv2Power+"W",g=(latestRealtimeData.pv2Voltage||0)+"V");const m=(e,t)=>{const a=document.getElementById(e);if(a){a.textContent!==t&&(a.textContent=t,a.classList.remove("value-updated"),a.offsetWidth,a.classList.add("value-updated"),setTimeout(()=>a.classList.remove("value-updated"),600))}};m("pv-power-3d",e),m("pv1-power-3d",i),m("pv2-power-3d",d),m("pv1-voltage-3d",c),m("pv2-voltage-3d",g),m("grid-power-3d",t),m("load-power-3d",r),m("battery-soc-3d",a);const u=document.getElementById("battery-soc-3d");if(u){const e=parseInt(a.replace(/[^\d]/g,""))||0;u.classList.remove("text-red-500","text-yellow-500","text-emerald-400","text-white"),e<=20?u.classList.add("text-red-500"):e<=50?u.classList.add("text-yellow-500"):u.classList.add("text-emerald-400")}m("essential-power-3d",s);m("grid-voltage-3d",document.getElementById("grid-voltage")?.textContent||"--V"),m("battery-voltage-3d",o),m("battery-current-3d",l);const p=parseInt(n.replace(/[^\d-]/g,""))||0,h=document.getElementById("battery-power-3d"),y=document.getElementById("battery-status-label-3d");if(h){let e;p>10?(e="+"+Math.abs(p)+"W",y&&(y.textContent="Pin ƒëang s·∫°c")):p<-10?(e="-"+Math.abs(p)+"W",y&&(y.textContent="Pin ƒëang x·∫£")):(e="0W",y&&(y.textContent="Pin ch·ªù")),h.textContent!==e&&(h.textContent=e,h.classList.remove("value-updated"),h.offsetWidth,h.classList.add("value-updated"),setTimeout(()=>h.classList.remove("value-updated"),600))}const v=document.getElementById("battery-percent-3d-icon");v&&(v.textContent=a);const f=parseInt(a.replace(/[^\d]/g,""))||0,b=document.getElementById("battery-fill-3d"),w=document.getElementById("battery-body-3d"),x=document.getElementById("battery-cap-3d");let I="bg-emerald-500",C="border-emerald-400",k="bg-emerald-400";f<=20?(I="bg-red-500",C="border-red-400",k="bg-red-400"):f<=50&&(I="bg-yellow-500",C="border-yellow-400",k="bg-yellow-400"),b&&(b.style.width=Math.max(f-3,0)+"%",b.className=`battery-fill-3d absolute left-0.5 top-0.5 bottom-0.5 rounded-[3px] ${I} transition-all duration-500`),w&&(w.className=`battery-body-3d w-16 h-7 sm:w-20 sm:h-8 rounded-[5px] border-2 ${C} relative overflow-hidden bg-slate-900/80 transition-all duration-300`),x&&(x.className=`absolute -right-1.5 top-1/2 -translate-y-1/2 w-1.5 h-4 sm:h-5 ${k} rounded-r-sm transition-all duration-300`);const E=parseInt(e.replace(/[^\d-]/g,""))||0,B=document.getElementById("sun-3d"),L=document.getElementById("moon-3d");B&&L&&(E>0?(B.classList.remove("hidden"),L.classList.add("hidden")):(B.classList.add("hidden"),L.classList.remove("hidden")));const $=document.getElementById("pv-energy-line");$&&(E>0?$.classList.remove("hidden-flow"):$.classList.add("hidden-flow"));const S=parseInt(t.replace(/[^\d-]/g,""))||0,T=document.getElementById("evn-energy-line");T&&(T.classList.remove("hidden-flow","flow-level-1","flow-level-2","flow-level-3"),S>0?S>1e3?T.classList.add("flow-level-3"):S>20?T.classList.add("flow-level-2"):T.classList.add("flow-level-1"):T.classList.add("hidden-flow"));const D=parseInt(n.replace(/[^\d-]/g,""))||0,P=document.getElementById("battery-charging-3d"),A=document.getElementById("battery-discharging-3d"),M=document.getElementById("battery-status-icon-3d");M&&(D>10?(M.classList.remove("hidden"),P?.classList.remove("hidden"),A?.classList.add("hidden")):D<-10?(M.classList.remove("hidden"),P?.classList.add("hidden"),A?.classList.remove("hidden")):M.classList.add("hidden"))},window.autoSyncBasicView=function(){const e=document.getElementById("pv-power")?.textContent||"--",t=document.getElementById("pv-desc")?.innerHTML||"--",a=document.getElementById("grid-power")?.textContent||"--",n=document.getElementById("grid-voltage")?.textContent||"--",o=document.getElementById("battery-percent-icon")?.textContent||"--%",l=document.getElementById("battery-power")?.textContent||"--",r=document.getElementById("battery-voltage-pro")?.textContent||"--V",s=document.getElementById("battery-current-pro")?.textContent||"--A",i=document.getElementById("essential-power")?.textContent||"--",d=document.getElementById("load-power")?.textContent||"--",c=document.getElementById("device-temp")?.textContent||"--",g=document.getElementById("inverter-type")?.textContent||"--",m=(e,t)=>{const a=document.getElementById(e);if(a){a.textContent!==t&&(a.textContent=t,a.classList.remove("value-updated"),a.offsetWidth,a.classList.add("value-updated"),setTimeout(()=>a.classList.remove("value-updated"),600))}};m("pv-power-basic",e),((e,t)=>{const a=document.getElementById(e);if(a){a.innerHTML!==t&&(a.innerHTML=t,a.classList.remove("value-updated"),a.offsetWidth,a.classList.add("value-updated"),setTimeout(()=>a.classList.remove("value-updated"),600))}})("pv-desc-basic",t),m("grid-power-basic",a),m("grid-voltage-basic",n),m("battery-percent-basic",o),m("battery-power-basic",l),m("battery-voltage-basic",r),m("battery-current-basic",s),m("essential-power-basic",i),m("load-power-basic",d),m("device-temp-basic",c),m("inverter-type-basic",g);const u=parseInt(l.replace(/[^\d-]/g,""))||0,p=document.getElementById("battery-status-text-basic");p&&(u>0?(p.textContent="ƒêang s·∫°c",p.className="text-xs font-medium text-emerald-500 dark:text-emerald-400"):u<0?(p.textContent="ƒêang x·∫£",p.className="text-xs font-medium text-orange-500 dark:text-orange-400"):(p.textContent="Ch·ªù",p.className="text-xs font-medium text-slate-500 dark:text-slate-400"));const h=document.getElementById("battery-power-basic");h&&(h.classList.remove("text-slate-700","dark:text-slate-300","text-emerald-500","dark:text-emerald-400","text-orange-500","dark:text-orange-400"),u>0?h.classList.add("text-emerald-500","dark:text-emerald-400"):u<0?h.classList.add("text-orange-500","dark:text-orange-400"):h.classList.add("text-slate-700","dark:text-slate-300"))},console.log("‚úÖ window.autoSync3DHomeView and window.autoSyncBasicView defined GLOBALLY"),document.addEventListener("DOMContentLoaded",function(){const e=new Date,t=document.getElementById("dateInput");t&&(t.value=De(e));const a=document.getElementById("energy-chart-date-picker");a&&(a.value=e.toISOString().split("T")[0]);const n=new URLSearchParams(window.location.search),o=n.get("deviceId");if(o){const e=document.getElementById("deviceId");e&&(e.value=o)}const l=document.getElementById("deviceId");let r,s;l&&l.addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),q())}),O();let i="",d=!1,c=!1,g=0,m="normal"!==localStorage.getItem("energyFlowAnimationMode");const u="https://lightearth.applike098.workers.dev",p="https://device-register.applike098.workers.dev",h=(window.location.origin,{get base(){return u},month:e=>`${u}/api/month/${e}`,year:e=>`${u}/api/year/${e}`,historyYear:e=>`${u}/api/history-year/${e}`,cloudPowerHistory:(e,t)=>`${getCurrentWorkerTSP()}/api/realtime/power-history/${e}?date=${t}`,cloudSocHistory:(e,t)=>`${getCurrentWorkerTSP()}/api/realtime/soc-history/${e}?date=${t}`,cloudTemperature:(e,t)=>`${getCurrentWorkerTSP()}/api/cloud/temperature/${e}/${t}`,cloudPowerPeak:(e,t)=>`${getCurrentWorkerTSP()}/api/realtime/power-peak/${e}?date=${t}`,cloudStates:e=>`${u}/api/cloud/states/${e}`,cloudDeviceInfo:e=>`${u}/api/cloud/device-info/${e}`});async function y(e,t={}){const a="function"==typeof e?e():e;console.log(`üì° [Railway API] Fetching: ${a}`);const n=await fetch(a,t);if(!n.ok)throw new Error(`HTTP ${n.status}`);return n}let v={data:null,deviceId:null,date:null,timestamp:0};const f=18e5,b={lightearthData:"solar_lightearth_cache",chartData:"solar_chart_cache",summaryData:"solar_summary_cache"};function w(){try{x.data&&(localStorage.setItem(b.summaryData,JSON.stringify(x)),console.log(`üíæ Summary cache saved to localStorage (device: ${x.deviceId})`))}catch(e){console.warn("Failed to save summary cache to localStorage:",e)}}let x={deviceId:null,data:null,timestamp:0};!function(){try{const e=new URLSearchParams(window.location.search).get("deviceId");console.log(`üîç URL deviceId: ${e}`);const t=localStorage.getItem(b.lightearthData);if(t){const a=JSON.parse(t),n=Date.now()-a.timestamp;e&&a.deviceId!==e?(console.log(`üîÑ Cache device (${a.deviceId}) != URL device (${e}), clearing cache`),localStorage.removeItem(b.lightearthData)):n<f?(console.log(`üì¶ Loaded Lightearth cache from localStorage (age: ${Math.round(n/1e3)}s, device: ${a.deviceId}, date: ${a.date})`),v=a):(console.log("‚ö†Ô∏è LocalStorage cache expired, clearing"),localStorage.removeItem(b.lightearthData))}const a=localStorage.getItem(b.summaryData);if(a){const t=JSON.parse(a),n=Date.now()-t.timestamp;e&&t.deviceId!==e?(console.log(`üîÑ Summary cache device (${t.deviceId}) != URL device (${e}), clearing`),localStorage.removeItem(b.summaryData)):n<f?(console.log(`üì¶ Loaded Summary cache from localStorage (age: ${Math.round(n/1e3)}s, device: ${t.deviceId})`),x=t):(console.log("‚ö†Ô∏è Summary cache expired, clearing"),localStorage.removeItem(b.summaryData))}}catch(e){console.warn("Failed to load cache from localStorage:",e)}}();let I={},C=0,k=!1,E=!1,B=null;const L=document.getElementById("viewBtn");L&&L.addEventListener("click",q);const $=document.getElementById("prevDay"),S=document.getElementById("nextDay");$&&$.addEventListener("click",()=>Pe(-1)),S&&S.addEventListener("click",()=>Pe(1));[{cardId:"pv-card",sectionId:"pv-section"},{cardId:"bat-charge-card",sectionId:"bat-section"},{cardId:"bat-discharge-card",sectionId:"bat-section"},{cardId:"load-card",sectionId:"load-section"},{cardId:"grid-card",sectionId:"grid-section"},{cardId:"essential-card",sectionId:"essential-section"}].forEach(({cardId:e,sectionId:t})=>{const a=document.getElementById(e);a&&a.addEventListener("click",()=>function(e){const t=document.getElementById(e);t&&t.scrollIntoView({behavior:"smooth"})}(t))});const T=document.getElementById("heroToggle"),D=document.getElementById("heroContent");T&&D&&T.addEventListener("click",()=>{D.classList.toggle("collapsed"),T.classList.toggle("rotated")});const P=document.getElementById("cellSectionHeader"),A=document.getElementById("cellSectionContent"),M=document.getElementById("toggleIcon"),V=document.getElementById("toggleText");P&&A&&P.addEventListener("click",e=>{if(e.target.closest("#reloadCellBtn"))return;const t=A.classList.toggle("hidden");M&&(M.style.transform=t?"rotate(180deg)":"rotate(0deg)"),V&&(V.textContent=t?"Hi·ªán":"·∫®n")});const H=document.getElementById("reloadCellBtn");H&&H.addEventListener("click",e=>{e.stopPropagation(),function(){const e=document.getElementById("reloadCellBtn");e&&(e.classList.add("animate-spin"),setTimeout(()=>e.classList.remove("animate-spin"),1e3));s;console.log("Cell data reload requested")}()});const R=document.getElementById("changeDeviceBtn");R&&R.addEventListener("click",()=>{const e=document.getElementById("heroSection"),t=document.getElementById("compactSearch");e&&e.classList.remove("hidden"),t&&t.classList.add("hidden");const a=document.getElementById("deviceId");a&&(a.focus(),a.select())});const N=document.getElementById("prevDayCompact"),W=document.getElementById("nextDayCompact");N&&N.addEventListener("click",()=>Pe(-1)),W&&W.addEventListener("click",()=>Pe(1));const F=document.getElementById("compactDateInput");function O(){Chart.defaults.font.family="'Inter', 'Segoe UI', 'Helvetica', 'Arial', sans-serif",Chart.defaults.color="#64748b",Chart.defaults.elements.line.borderWidth=2,Chart.defaults.elements.point.hitRadius=8;const e=document.documentElement.classList.contains("dark")||window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;Chart.defaults.scale.grid.color=e?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.05)",Chart.defaults.scale.ticks.color=e?"rgba(255, 255, 255, 0.7)":"rgba(0, 0, 0, 0.7)",Chart.Tooltip.positioners.edgeAware=function(e,t){if(!e.length)return!1;const a=this.chart.chartArea,n=140;let o=e[0].element.x,l=e[0].element.y;return o+70>a.right-20&&(o=a.right-n-20),o-70<a.left+20&&(o=a.left+70+20),{x:o,y:l}},Chart.Tooltip.positioners.topRight=function(e,t){const a=this.chart.chartArea;return{x:a.right-10,y:a.top+10}}}function _(e,t="system"){const a=document.getElementById("connectionIndicator"),n=document.getElementById("connectionText");"system"===t?d="connected"===e:"http"===t&&(c="connected"===e,"connected"===e&&(g=Date.now()));let o="disconnected",l="M·∫•t k·∫øt n·ªëi";d?(o="connected",l="H·ªá th·ªëng: ƒê√£ k·∫øt n·ªëi"):c?(o="connected",l="HTTP API: ƒêang ho·∫°t ƒë·ªông"):"connecting"===e&&(o="connecting",l="ƒêang k·∫øt n·ªëi..."),a&&(a.className="w-2.5 h-2.5 rounded-full","connected"===o?a.classList.add("status-connected"):"connecting"===o?a.classList.add("status-connecting"):a.classList.add("status-disconnected")),n&&(n.textContent=l)}function U(e){e&&(console.log(`üåê [Cloudflare Mode] Subscribing to device: ${e} via HTTP polling`),i=e,function(e){B&&clearInterval(B);const t=getCurrentPollingInterval(),a=API_POOL.filter(e=>!e.disabled).length;console.log(`üîÑ Starting realtime polling for device: ${e} (every ${t/1e3}s - ${a}/${API_POOL.length} APIs healthy)`),j(e),B=setInterval(()=>{j(e)},t)}(e))}async function j(e){let t=null;currentApiSuccessCount>=5&&lastSuccessfulApiName&&(console.log(`üîÑ Rotation: ${lastSuccessfulApiName} reached ${currentApiSuccessCount} successes, switching...`),t=getRandomHealthyApi(lastSuccessfulApiName),currentApiSuccessCount=0);let a=API_POOL.filter(e=>!e.disabled);if(0===a.length)return console.warn("‚ö†Ô∏è All APIs disabled, resetting..."),API_POOL.forEach(e=>{e.disabled=!1,e.failCount=0}),currentApiSuccessCount=0,lastSuccessfulApiName=null,j(e);if(t)a=[t,...a.filter(e=>e.name!==t.name)];else{const e=a.filter(e=>1===e.priority),t=a.filter(e=>2===e.priority);for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}a=[...e,...t],console.log(`üé≤ Shuffled API order: ${a.map(e=>e.name.split(" ")[0]).join(" ‚Üí ")}`)}let n=null;for(let t=0;t<a.length;t++){const o=a[t],l=`${o.worker}/api/realtime/device/${e}`;console.log(`üì° [${t+1}/${a.length}] Trying ${o.name}:`,l);try{const t=new AbortController,a=setTimeout(()=>t.abort(),6e3),r=await fetch(l,{signal:t.signal});if(clearTimeout(a),!r.ok){console.error(`‚ùå API error ${r.status}: ${r.statusText} for ${l}`),markApiFailed(l),n=new Error(`HTTP ${r.status}`);continue}markApiSuccess(l),lastSuccessfulApiName===o.name?currentApiSuccessCount++:(currentApiSuccessCount=1,lastSuccessfulApiName=o.name),console.log(`‚úÖ ${o.name} success #${currentApiSuccessCount}/5`);const s=await r.json();if(console.log("üîç RAW API Response:",JSON.stringify(s).substring(0,500)),console.log("üîç data.deviceData exists:",void 0!==s.deviceData),console.log("üîç data.deviceData?.battery:",s.deviceData?.battery),console.log("üîç data.deviceData?.battery?.cells:",s.deviceData?.battery?.cells),s.error)return;if(!1===s.success)return console.warn(`‚ö†Ô∏è Device ${e} not found:`,s.message),void ve({noRealtimeData:!0,deviceNotFound:!0,errorMessage:s.message||`Device ${e} not found in LightEarth Cloud`});let i,d;if(void 0!==s.deviceData){const e=s.deviceData||{};console.log("üîç [v13245] dd.battery:",e.battery),console.log("üîç [v13245] dd.battery?.cells:",e.battery?.cells),i={pvTotalPower:e.pv?.totalPower||0,pv1Power:e.pv?.pv1Power||0,pv2Power:e.pv?.pv2Power||0,pv1Voltage:e.pv?.pv1Voltage||0,pv2Voltage:e.pv?.pv2Voltage||0,gridValue:e.grid?.power||0,gridVoltageValue:e.grid?.inputVoltage||0,batteryPercent:e.battery?.soc||0,batteryValue:e.battery?.power||0,batteryVoltage:e.battery?.voltage||0,batteryCurrent:e.battery?.current||0,batteryStatus:e.battery?.status||"Idle",deviceTempValue:e.temperature||e.system?.temperature||0,essentialValue:e.acOutput?.power||0,loadValue:e.load?.homePower||e.load?.power||0,inverterAcOutPower:e.acOutput?.power||0,model:e.model||s.deviceData?.model||null},d=e.batteryCells||e.battery?.cells||s.batteryCells,console.log("üìä [v13245] Using Cloud format (Worker v3.9)",i),console.log("üîã [v13245] batteryCells from API:",d)}else{if(!s.data)return;i={pvTotalPower:s.data.totalPvPower||0,pv1Power:s.data.pv1Power||0,pv2Power:s.data.pv2Power||0,pv1Voltage:s.data.pv1Voltage||0,pv2Voltage:s.data.pv2Voltage||0,gridValue:s.data.gridPowerFlow||0,gridVoltageValue:s.data.acInputVoltage||0,batteryPercent:s.data.batterySoc||0,batteryValue:s.data.batteryPower||0,batteryVoltage:s.data.batteryVoltage||0,batteryCurrent:s.data.batteryCurrent||0,batteryStatus:s.data.batteryStatus||"Idle",deviceTempValue:s.data.temperature||0,essentialValue:s.data.acOutputPower||0,loadValue:s.data.homeLoad||0,inverterAcOutPower:s.data.acOutputPower||0},d=s.cells,console.log("üìä Using Legacy format",i)}latestRealtimeData=i,ve(i),i.model&&ge(i.model),console.log("üîã CellsData received:",d?"YES":"NO"),console.log("üîã CellsData structure:",d),d&&d.cells||(console.log("üîã No cells in current API response, fetching from lightearth-proxy..."),fe(e));let c=[],g=0,m=0,u=0;if(d){if(d.cells&&Array.isArray(d.cells)){console.log("‚úÖ Processing Worker v3.9 format (cells array of objects)"),console.log("üîã Raw cellsData.cells:",JSON.stringify(d.cells));[...d.cells].sort((e,t)=>e.cell-t.cell).forEach((e,t)=>{const a=e.voltage;c.push(a),console.log(`üîã Cell ${e.cell}: ${a}V`)}),g=d.max||0,m=d.min||0,u=d.avg||0,console.log("üîã Final cellVoltages array:",c)}else if(d.cells&&"object"==typeof d.cells&&!Array.isArray(d.cells)){console.log("‚úÖ Processing Worker v3.7 format (cells object)"),console.log("üîã Raw cellsData.cells:",JSON.stringify(d.cells));const e=Object.keys(d.cells).sort((e,t)=>parseInt(e.replace(/\D/g,""))-parseInt(t.replace(/\D/g,"")));console.log("üîã Sorted cellKeys:",e),e.forEach((e,t)=>{const a=d.cells[e];c.push(a),console.log(`üîã Cell ${t+1} (${e}): ${a}V`)}),g=d.max||0,m=d.min||0,u=d.avg||0,console.log("üîã Final cellVoltages array:",c)}else if(d.cellVoltages){console.log("‚úÖ Processing Legacy format (cellVoltages array)");const e=d.cellVoltages;if(Array.isArray(e))c=e;else if("object"==typeof e){Object.keys(e).sort((e,t)=>parseInt(e.replace(/\D/g,""))-parseInt(t.replace(/\D/g,""))).forEach(t=>{c.push(e[t])})}g=d.maximumVoltage||0,m=d.minimumVoltage||0,u=d.averageVoltage||0}if(c.length>0){const e=c.filter(e=>e>0),t={cells:c,maximumVoltage:g||Math.max(...e,0),minimumVoltage:m||Math.min(...e.filter(e=>e>0),0),averageVoltage:u||(e.length>0?e.reduce((e,t)=>e+t,0)/e.length:0),numberOfCells:c.length};we(t),console.log(`üìä Cell voltages updated: ${c.length} cells`,t)}}return void _("connected","http")}catch(e){console.error(`‚ùå Network error for ${o.name}:`,e.message),markApiFailed(l),n=e;continue}}console.error("‚ùå All APIs failed! Last error:",n?.message),_("disconnected","http")}F&&F.addEventListener("change",function(){const e=this.value;if(e){const t=document.getElementById("dateInput");t&&(t.value=e);const a=document.getElementById("compactDateDisplay");if(a){const t=new Date(e),n=String(t.getDate()).padStart(2,"0"),o=String(t.getMonth()+1).padStart(2,"0"),l=t.getFullYear();a.textContent=`${n}/${o}/${l}`,K(`${n}/${o}/${l}`)}window.skipDeviceNotification=!0,q()}}),console.log("üåê [Cloudflare Mode] SignalR disabled - using HTTP polling (5s interval)"),_("connected","http"),o&&q();const z=new Map,G=3e5;async function Y(e){const t=e.toUpperCase();console.log(`üîß [Device Request] Requesting device: ${t} (Telegram approval flow v4.2)`);try{const e=await fetch(`${p}/request-device`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId:t,source:"LightEarth Dashboard",userInfo:"Web User"})}),a=await e.json();return console.log("üì© [Request Device] API Response:",a),"already_exists"===a.status?(console.log(`‚úÖ [Request Device] ${t} already exists in HA`),function(e,t,a){if(window.skipDeviceNotification)return void(window.skipDeviceNotification=!1);const n=document.createElement("div");n.className="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50 px-4 py-3 rounded-lg shadow-lg text-white text-sm font-medium transition-all duration-300",a?(n.classList.add("bg-blue-500"),n.innerHTML=`<span class="mr-2">‚ÑπÔ∏è</span> Thi·∫øt b·ªã ${e} ƒë√£ c√≥ trong h·ªá th·ªëng`):(n.classList.add("bg-green-500"),n.innerHTML=`<span class="mr-2">‚úÖ</span> ƒê√£ ƒëƒÉng k√Ω ${e} - T·∫°o ${t} sensors`);document.body.appendChild(n),setTimeout(()=>{n.style.opacity="1",n.style.transform="translateX(-50%) translateY(0)"},10),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateX(-50%) translateY(20px)",setTimeout(()=>n.remove(),300)},4e3)}(t,51,!0),{success:!0,message:"Device already exists",alreadyExists:!0}):"pending_approval"===a.status||"already_pending"===a.status?(console.log(`‚è≥ [Request Device] ${t} pending approval - Telegram sent: ${a.telegramSent}`),function(e){const t=document.getElementById("pending-approval-modal");t&&t.remove();const a=document.createElement("div");a.id="pending-approval-modal",a.className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm";let n=300,o=null;a.innerHTML=`\n            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 sm:p-8 max-w-md mx-4 shadow-2xl border border-slate-600">\n                \x3c!-- Header - Waiting State --\x3e\n                <div id="pending-waiting-state" class="text-center mb-6">\n                    <div class="w-20 h-20 mx-auto mb-4 relative">\n                        <div class="absolute inset-0 rounded-full border-4 border-amber-400/30"></div>\n                        <div id="countdown-circle" class="absolute inset-0 rounded-full border-4 border-amber-400" \n                             style="border-top-color: transparent; animation: spin 1.5s linear infinite;"></div>\n                        <div class="absolute inset-0 flex items-center justify-center">\n                            <span class="text-3xl">‚è≥</span>\n                        </div>\n                    </div>\n                    <h2 class="text-xl font-bold text-white mb-1">ƒêang Ch·ªù Duy·ªát</h2>\n                    <p class="text-slate-400 text-sm">Y√™u c·∫ßu ƒë√£ g·ª≠i ƒë·∫øn admin</p>\n                </div>\n                \n                \x3c!-- Header - Approved State (Hidden initially) --\x3e\n                <div id="pending-approved-state" class="text-center mb-6 hidden">\n                    <div class="w-20 h-20 mx-auto mb-4 relative">\n                        <div class="absolute inset-0 rounded-full bg-emerald-500/20 flex items-center justify-center" style="animation: pulse 1s ease-out;">\n                            <span class="text-5xl">‚úÖ</span>\n                        </div>\n                    </div>\n                    <h2 class="text-xl font-bold text-emerald-400 mb-1">ƒê√£ ƒê∆∞·ª£c Duy·ªát!</h2>\n                    <p class="text-slate-400 text-sm">Thi·∫øt b·ªã ƒë√£ ƒë∆∞·ª£c th√™m v√†o h·ªá th·ªëng</p>\n                    <p id="approved-by-text" class="text-emerald-400 text-sm mt-1"></p>\n                </div>\n                \n                \x3c!-- Header - Rejected State (Hidden initially) --\x3e\n                <div id="pending-rejected-state" class="text-center mb-6 hidden">\n                    <div class="w-20 h-20 mx-auto mb-4 relative">\n                        <div class="absolute inset-0 rounded-full bg-red-500/20 flex items-center justify-center">\n                            <span class="text-5xl">‚ùå</span>\n                        </div>\n                    </div>\n                    <h2 class="text-xl font-bold text-red-400 mb-1">ƒê√£ B·ªã T·ª´ Ch·ªëi</h2>\n                    <p class="text-slate-400 text-sm">Y√™u c·∫ßu kh√¥ng ƒë∆∞·ª£c ch·∫•p nh·∫≠n</p>\n                    <p id="rejected-by-text" class="text-red-400 text-sm mt-1"></p>\n                </div>\n                \n                \x3c!-- Device Info --\x3e\n                <div class="bg-slate-700/50 rounded-xl p-4 mb-4">\n                    <div class="flex items-center justify-between">\n                        <span class="text-slate-400">Device ID:</span>\n                        <span class="font-mono font-bold text-amber-400">${e}</span>\n                    </div>\n                </div>\n                \n                \x3c!-- Countdown (shown when waiting) --\x3e\n                <div id="countdown-section" class="text-center mb-6">\n                    <p class="text-slate-400 text-sm mb-2">Th·ªùi gian ch·ªù d·ª± ki·∫øn:</p>\n                    <div id="countdown-display" class="text-4xl font-bold text-emerald-400">\n                        05:00\n                    </div>\n                    <p class="text-slate-500 text-xs mt-2">T·ª± ƒë·ªông ki·ªÉm tra m·ªói 5 gi√¢y...</p>\n                </div>\n                \n                \x3c!-- Auto-reload message (shown when approved/rejected) --\x3e\n                <div id="auto-reload-section" class="text-center mb-6 hidden">\n                    <p class="text-slate-400 text-sm">Trang s·∫Ω t·ª± ƒë·ªông reload sau <span id="reload-countdown" class="text-emerald-400 font-bold">3</span> gi√¢y...</p>\n                </div>\n                \n                \x3c!-- Zalo Group CTA --\x3e\n                <div id="zalo-cta" class="bg-gradient-to-r from-blue-600 to-blue-500 rounded-xl p-4 mb-4">\n                    <p class="text-white text-sm mb-3 text-center">\n                        üîî <strong>Tham gia nh√≥m Zalo</strong> ƒë·ªÉ ƒë∆∞·ª£c c·∫≠p nh·∫≠t nhanh!\n                    </p>\n                    <a href="https://zalo.me/g/kmzrgh433" target="_blank" rel="noopener noreferrer"\n                       class="flex items-center justify-center gap-2 bg-white text-blue-600 font-bold py-3 px-4 rounded-lg hover:bg-blue-50 transition-colors">\n                        <img src="/zalo-logo.png" alt="Zalo" class="w-6 h-6" onerror="this.style.display='none'">\n                        <span>Tham gia Zalo LightEarth VN</span>\n                    </a>\n                </div>\n                \n                \x3c!-- Actions --\x3e\n                <div id="action-buttons" class="flex gap-3">\n                    <button id="cancel-pending-btn" \n                            class="flex-1 py-3 px-4 rounded-lg bg-slate-700 text-slate-300 font-medium hover:bg-slate-600 transition-colors">\n                        H·ªßy\n                    </button>\n                    <button id="reload-btn" \n                            class="flex-1 py-3 px-4 rounded-lg bg-emerald-600 text-white font-medium hover:bg-emerald-500 transition-colors">\n                        <i class="fas fa-redo mr-2"></i>Reload\n                    </button>\n                </div>\n            </div>\n            \n            <style>\n                @keyframes spin {\n                    0% { transform: rotate(0deg); }\n                    100% { transform: rotate(360deg); }\n                }\n                @keyframes pulse {\n                    0% { transform: scale(0.8); opacity: 0; }\n                    50% { transform: scale(1.1); }\n                    100% { transform: scale(1); opacity: 1; }\n                }\n            </style>\n        `,document.body.appendChild(a);const l=document.getElementById("countdown-display"),r=document.getElementById("pending-waiting-state"),s=document.getElementById("pending-approved-state"),i=document.getElementById("pending-rejected-state"),d=document.getElementById("countdown-section"),c=document.getElementById("auto-reload-section"),g=document.getElementById("zalo-cta"),m=document.getElementById("action-buttons");async function u(){try{const t=await fetch(`${p}/check/${e}`),a=await t.json();return console.log("[Auto Check] Status:",a),a.inIntegration||a.inLumentreeIntegration||a.approvalInfo&&"approved"===a.approvalInfo.status?(v(),h(a.approvalInfo?.approvedBy||a.approvedBy||"Admin"),!0):!!("rejected"===a.pendingStatus||a.approvalInfo&&"rejected"===a.approvalInfo.status)&&(v(),y(a.approvalInfo?.rejectedBy||a.rejectedBy||"Admin"),!0)}catch(e){return console.error("[Auto Check] Error:",e),!1}}function h(e){r.classList.add("hidden"),i.classList.add("hidden"),s.classList.remove("hidden"),document.getElementById("approved-by-text").textContent=`Approved by: ${e}`,d.classList.add("hidden"),c.classList.remove("hidden"),g.classList.add("hidden"),m.classList.add("hidden");let t=3;const a=document.getElementById("reload-countdown"),n=setInterval(()=>{t--,a.textContent=t,t<=0&&(clearInterval(n),window.location.reload())},1e3)}function y(e){r.classList.add("hidden"),s.classList.add("hidden"),i.classList.remove("hidden"),document.getElementById("rejected-by-text").textContent=`Rejected by: ${e}`,d.classList.add("hidden"),c.classList.remove("hidden"),c.querySelector("p").innerHTML='Trang s·∫Ω t·ª± ƒë·ªông reload sau <span id="reload-countdown" class="text-red-400 font-bold">5</span> gi√¢y...',g.classList.add("hidden"),m.classList.add("hidden");let t=5;const a=document.getElementById("reload-countdown"),n=setInterval(()=>{t--,a.textContent=t,t<=0&&(clearInterval(n),window.location.reload())},1e3)}function v(){o&&(clearInterval(o),o=null),f&&clearInterval(f)}const f=setInterval(()=>{if(n--,n<=0)clearInterval(f),l.textContent="00:00",l.classList.remove("text-emerald-400"),l.classList.add("text-amber-400");else{const e=Math.floor(n/60),t=n%60;l.textContent=`${String(e).padStart(2,"0")}:${String(t).padStart(2,"0")}`}},1e3);u(),o=setInterval(u,5e3),document.getElementById("cancel-pending-btn").addEventListener("click",()=>{v(),a.remove()}),document.getElementById("reload-btn").addEventListener("click",()=>{v(),window.location.reload()})}(t),{success:!0,status:"pending_approval",message:a.message,waitForApproval:!0}):!a.success&&a.error?(console.error("‚ùå [Request Device] Failed:",a.error),function(e){const t=document.createElement("div");t.className="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50 px-4 py-3 rounded-lg shadow-lg bg-red-500 text-white text-sm font-medium transition-all duration-300",t.innerHTML=`<span class="mr-2">‚ùå</span> ${e}`,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="1",t.style.transform="translateX(-50%) translateY(0)"},10),setTimeout(()=>{t.style.opacity="0",t.style.transform="translateX(-50%) translateY(20px)",setTimeout(()=>t.remove(),300)},5e3)}(`Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu ${t}: ${a.error}`),{success:!1,message:a.error}):{success:!0,message:a.message||"Request submitted"}}catch(e){return console.error("‚ùå [Request Device] Error:",e.message),{success:!1,message:e.message}}}function K(e){const t=document.createElement("div");t.className="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50 px-4 py-3 rounded-lg shadow-lg text-white text-sm font-medium transition-all duration-300 bg-teal-500",t.innerHTML=`<span class="mr-2">üìÖ</span> ƒêang xem ng√†y ${e}`,t.style.opacity="0",t.style.transform="translateX(-50%) translateY(20px)",document.body.appendChild(t),setTimeout(()=>{t.style.opacity="1",t.style.transform="translateX(-50%) translateY(0)"},10),setTimeout(()=>{t.style.opacity="0",t.style.transform="translateX(-50%) translateY(20px)",setTimeout(()=>t.remove(),300)},2e3)}function q(){const e=document.getElementById("deviceId")?.value?.trim(),t=document.getElementById("dateInput")?.value;if(!e)return void We("Vui l√≤ng nh·∫≠p Device ID");if(!function(e){return/^[HP]\d{9}$/i.test(e)}(e))return void We("‚ùå Device ID kh√¥ng h·ª£p l·ªá!\n\nƒê·ªãnh d·∫°ng ƒë√∫ng: H ho·∫∑c P + 9 s·ªë\nV√≠ d·ª•: H250325151 ho·∫∑c P250801055");const a=new URL(window.location);a.searchParams.set("deviceId",e),window.history.pushState({},"",a),document.title=`Solar Monitor - ${e}`,U(e),Ne(!0),function(){const e=document.getElementById("errorMessage");e&&e.classList.add("hidden")}(),k=!1,E=!1,I={},console.log("üîÑ Reset cell data state for device:",e),async function(e,t){console.log(`üöÄ Loading data for device: ${e}, date: ${t||"today"}`);try{const t=await async function(e){const t=e.toUpperCase(),a=z.get(t);if(a&&Date.now()-a.timestamp<G)return console.log(`üì¶ [Device Check] Cache hit for ${t}: exists=${a.exists}`),a;try{const e=await fetch(`${p}/check/${t}`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const a=await e.json(),n=a.inLumentreeIntegration||!1,o=a.entityCount?.integrationCount||a.entityCount?.totalCount||0,l={exists:n,entityCount:o,inLumentreeIntegration:n,inMqttDiscovery:a.inMqttDiscovery||!1,timestamp:Date.now()};return z.set(t,l),console.log(`üîç [Device Check] ${t}: inLumentree=${n}, entities=${o}`),l}catch(e){return console.warn(`‚ö†Ô∏è [Device Check] Failed for ${t}:`,e.message),{exists:!0,entityCount:-1,error:e.message}}}(e);if(t.exists||t.error)t.exists&&console.log(`‚úÖ [Device OK] ${e} already in Lumentree Integration (${t.entityCount} entities)`);else{console.log(`üÜï [New Device] ${e} not found in Lumentree Integration - requesting approval...`);const t=await Y(e);if(t.waitForApproval)return console.log(`‚è≥ [Pending] ${e} waiting for admin approval - stopping data load`),void Ne(!1);t.alreadyExists&&console.log(`‚úÖ [Already Exists] ${e} approved - continuing to load data`),t.success||(console.warn(`‚ö†Ô∏è Request failed: ${t.message}`),function(e,t){const a=document.createElement("div");a.className="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50 px-4 py-3 rounded-lg shadow-lg bg-yellow-500 text-white text-sm font-medium max-w-sm text-center",a.innerHTML=`\n            <div class="flex flex-col gap-1">\n                <span>‚ö†Ô∏è Kh√¥ng th·ªÉ ƒëƒÉng k√Ω t·ª± ƒë·ªông ${e}</span>\n                <span class="text-xs opacity-80">${t||"Vui l√≤ng th√™m th·ªß c√¥ng trong Home Assistant"}</span>\n            </div>\n        `,document.body.appendChild(a),setTimeout(()=>{a.style.opacity="0",setTimeout(()=>a.remove(),300)},6e3)}(e,t.message))}}catch(e){console.warn("‚ö†Ô∏è Device check failed, continuing anyway:",e.message)}Ae("deviceInfo"),Ae("summaryStats"),Ae("chart-section"),Ae("realTimeFlow"),Ae("batteryCellSection"),ye({deviceId:e,deviceType:"Lumentree Inverter",onlineStatus:1,remarkName:""}),function(e,t){const a=document.getElementById("heroSection"),n=document.getElementById("compactSearch"),o=document.getElementById("deviceIdDisplay"),l=document.getElementById("dateDisplay"),r=document.getElementById("compactDateDisplay"),s=document.getElementById("compactDateInput");a&&a.classList.add("hidden");n&&n.classList.remove("hidden");o&&(o.textContent=e);if(l){const e=new Date(t);l.textContent=e.toLocaleDateString("vi-VN")}if(r&&t){const e=new Date(t),a=String(e.getDate()).padStart(2,"0"),n=String(e.getMonth()+1).padStart(2,"0"),o=e.getFullYear();r.textContent=`${a}/${n}/${o}`}s&&t&&(s.value=t)}(e,t),Ne(!1);const a=x.deviceId===e&&x.data;a?(console.log("üì¶ Using cached summary data for instant display:",e),X(x.data)):(Me("pv-total","ƒêang t·∫£i..."),Me("bat-charge","ƒêang t·∫£i..."),Me("bat-discharge","ƒêang t·∫£i..."),Me("load-total","ƒêang t·∫£i..."),Me("grid-total","ƒêang t·∫£i..."),Me("essential-total","ƒêang t·∫£i..."));console.log("üîÑ F5 detected: Clearing chart cache to force fresh fetch"),v={data:null,deviceId:null,date:null,timestamp:0},console.log("üîÑ F5/Load: Always fetching fresh daily-energy for",e),k||be();const n=t||document.getElementById("dateInput")?.value||(new Date).toISOString().split("T")[0],o=v.data&&v.deviceId===e&&v.date===n&&Date.now()-v.timestamp<f;o?(console.log("üì¶ Using cached chart data for instant display"),"LightEarthCloud"===v.data.dataSource?re(v.data):se(v.data)):console.log("üìä Chart disabled - showing peak stats only");console.log("üö¶ Starting staggered API calls to prevent tunnel flooding..."),J(e),setTimeout(()=>{console.log("üîã [Staggered] Fetching SOC data..."),ue().catch(e=>console.error("‚ùå SOC fetch error:",e))},500),setTimeout(()=>{console.log("üå°Ô∏è [Staggered] Fetching temperature data..."),async function(e,t){const a=t||document.getElementById("dateInput")?.value||(new Date).toISOString().split("T")[0],n=Date.now();if(temperatureCache.deviceId===e&&temperatureCache.date===a&&temperatureCache.data&&n-temperatureCache.timestamp<ie){const e=Math.round((n-temperatureCache.timestamp)/1e3);return console.log(`üå°Ô∏è Using cached temperature data (age: ${e}s, TTL: 5min)`),void de(temperatureCache.data)}console.log("üå°Ô∏è Fetching fresh temperature data...");try{const t=await y(()=>h.cloudTemperature(e,a)),o=await t.json();console.log("üå°Ô∏è Temperature min/max data received:",o),o.success&&(temperatureCache={deviceId:e,date:a,data:o,timestamp:n},console.log("üíæ Temperature data cached (TTL: 5 minutes)")),de(o)}catch(e){if(console.warn("üå°Ô∏è Temperature API unavailable:",e.message),!temperatureCache.data){const e=document.getElementById("tempMinMaxBadge");e&&e.classList.add("hidden")}}}(e,n)},1e3),setTimeout(()=>{!function(e){if(!e)return;const t=`deviceInfo_${e}`,a=localStorage.getItem(t);if(a)try{const t=JSON.parse(a),n=Date.now()-t.timestamp;if(n<ce)return console.log(`üì¶ Using cached device info for ${e} (age: ${Math.round(n/6e4)} min)`),void ge(t.model);console.log(`üì¶ Device info cache expired for ${e}, fetching fresh data`)}catch(e){console.warn("üì¶ Invalid cache data, fetching fresh")}console.log("üì¶ Fetching device info..."),y(()=>h.cloudDeviceInfo(e)).then(e=>e.json()).then(a=>{if(console.log("üì¶ Device info received:",a),a.success){let n=null;if(a.friendly_name){const e=a.friendly_name,t=e.match(/^(SUNT-[\d.]+kW-[A-Z]+)/i);if(t)n=t[1];else{const t=["PV Power","Battery","Grid","Load","SOC","Temperature"];for(const a of t)if(e.includes(a)){n=e.split(a)[0].trim();break}}}if(!n&&a.model&&(n=a.model),n)try{localStorage.setItem(t,JSON.stringify({model:n,timestamp:Date.now(),raw:a})),console.log(`üíæ Device info cached for ${e}: ${n}`)}catch(e){console.warn("üì¶ Could not cache device info:",e.message)}ge(n)}}).catch(t=>{if(console.warn("üì¶ Device info API unavailable (all proxies failed):",t.message),a)try{const t=JSON.parse(a);console.log(`üì¶ Using expired cache as fallback for ${e}`),ge(t.model)}catch(e){}})}(e)},1500),setTimeout(()=>{"function"==typeof window.loadSolarProjectSummary&&(console.log("üìä [Staggered] Loading solar project summary..."),window.loadSolarProjectSummary(e))},2e3),setTimeout(()=>{console.log("üìä [Staggered] Fetching peak stats data..."),async function(e,t,a=!1){console.log("üöÄüöÄüöÄ fetchDayDataInBackground CALLED:",{deviceId:e,date:t,forceRefresh:a});const n=t||document.getElementById("dateInput")?.value||(new Date).toISOString().split("T")[0],o=Date.now();console.log("üìÖ Query date:",n),v.deviceId&&v.deviceId!==e&&(console.log(`üîÑ Device changed from ${v.deviceId} to ${e}, clearing chart cache`),v={data:null,deviceId:null,date:null,timestamp:0});x.deviceId&&x.deviceId!==e&&(console.log("üîÑ Clearing summary cache for new device"),x={deviceId:null,data:null,timestamp:0});let l=x.deviceId===e&&x.data;if(l)console.log("üì¶ [Priority 1] Using cached summary data, skipping Railway API");else try{console.log("üì° [Priority 1] Trying daily-energy API (applike098)...");const t=`${DAILY_ENERGY_API}/api/realtime/daily-energy/${e}`,a=await fetch(t);if(a.ok){const t=await a.json(),n=t.today||t.summary;if(t.success&&n){const t={pvDay:void 0!==n.pv?n.pv:void 0!==n.pv_day?n.pv_day:0,chargeDay:void 0!==n.charge?n.charge:void 0!==n.charge_day?n.charge_day:0,dischargeDay:void 0!==n.discharge?n.discharge:void 0!==n.discharge_day?n.discharge_day:0,loadDay:void 0!==n.load?n.load:void 0!==n.total_load_day?n.total_load_day:n.load_day||0,gridDay:void 0!==n.gridIn?n.gridIn:void 0!==n.grid_day?n.grid_day:0,essentialDay:void 0!==n.essential?n.essential:void 0!==n.essential_day?n.essential_day:0};x={deviceId:e,data:t,timestamp:Date.now()},w(),X(t),console.log("‚úÖ [Priority 1] Railway API SUCCESS:",summary),l=!0}}}catch(e){console.warn("‚ö†Ô∏è [Priority 1] Railway API failed:",e.message)}let r=!1;if(!a&&v.data&&v.deviceId===e&&v.date===n&&o-v.timestamp<f){const e=Math.round((o-v.timestamp)/1e3);return console.log(`üì¶ Using cached chart data (age: ${e}s)`),void("LightEarthCloud"===v.data.dataSource?re(v.data):se(v.data))}a&&console.log("üîÑ Force refresh: Skipping cache, fetching fresh data...");try{const t=Date.now(),a=function(e,t){return`${getCurrentWorkerTSP()}/api/realtime/power-history/${e}?date=${t}`}(e,n)+`&_t=${t}`;console.log("üìäüìäüìä [POWER CHART] Fetching from Worker API:",a);const l=await fetch(a,{method:"GET",cache:"no-store",headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache"}});if(console.log("üìä Railway response status:",l.status,l.ok),l.ok){const t=await l.json();if(console.log("üìä Railway API response:",t),t.success&&t.timeline&&t.timeline.length>0)return console.log(`‚úÖ Railway API SUCCESS: ${t.timeline.length} data points`),v={data:{...t,dataSource:"PowerHistoryCollector"},deviceId:e,date:n,timestamp:o},console.log("üíæ Chart data cached (TTL: 30 minutes)"),function(){try{v.data&&(localStorage.setItem(b.lightearthData,JSON.stringify(v)),console.log(`üíæ Chart cache saved to localStorage (device: ${v.deviceId})`))}catch(e){console.warn("Failed to save cache to localStorage:",e)}}(),re(t),void(r=!0);console.warn("‚ö†Ô∏è Railway API returned no data - collector may still be gathering data")}else console.warn(`‚ö†Ô∏è [Priority 1] Railway API failed: HTTP ${l.status}`)}catch(e){console.warn("‚ö†Ô∏è Railway API error:",e.message)}r||console.log("‚ÑπÔ∏è No chart data yet - PowerHistoryCollector is gathering data every 5 minutes");try{const t=h.cloudPowerPeak(e,n);console.log("üéØ [Power Peak] Fetching accurate peaks from:",t);const a=await fetch(t,{cache:"no-store",headers:{"Cache-Control":"no-cache"}});if(a.ok){const e=await a.json();e.success&&e.peaks&&(!function(e){if(!e)return;const t=(e,t)=>{const a=document.getElementById(e);a&&(a.textContent=t)},a=e=>e&&0!==e?`${Math.round(e)} W`:"--";e.pv&&(t("chart-pv-peak",a(e.pv.max)),t("chart-pv-time",e.pv.time||"--:--"));e.charge&&(t("chart-charge-peak",a(e.charge.max)),t("chart-charge-time",e.charge.time||"--:--"));e.discharge&&(t("chart-discharge-peak",a(e.discharge.max)),t("chart-discharge-time",e.discharge.time||"--:--"));e.load&&(t("chart-load-peak",a(e.load.max)),t("chart-load-time",e.load.time||"--:--"));e.grid&&(t("chart-grid-peak",a(e.grid.max)),t("chart-grid-time",e.grid.time||"--:--"));console.log("üìä Peak stats updated from Worker API:",{pv:`${e.pv?.max||0}W @ ${e.pv?.time||"--:--"}`,charge:`${e.charge?.max||0}W @ ${e.charge?.time||"--:--"}`,discharge:`${e.discharge?.max||0}W @ ${e.discharge?.time||"--:--"}`,load:`${e.load?.max||0}W @ ${e.load?.time||"--:--"}`,grid:`${e.grid?.max||0}W @ ${e.grid?.time||"--:--"}`})}(e.peaks),console.log(`‚úÖ [Power Peak] Accurate peaks updated (scanned ${e.dataPoints} raw data points)`))}}catch(e){console.warn("‚ö†Ô∏è [Power Peak] API error:",e.message)}}(e,n,!0).catch(e=>console.warn("Day data error:",e))},2500),window.dailyEnergyRefreshInterval&&clearInterval(window.dailyEnergyRefreshInterval);window.dailyEnergyRefreshInterval=setInterval(()=>{console.log("üîÑ [Auto-refresh] Fetching daily-energy data (5 min interval)..."),J(e)},3e5),console.log("‚úÖ [Auto-refresh] Daily-energy interval set: every 5 minutes")}(e,t)}function X(e){e&&(console.log("üìä [applySummaryData] Updating UI with:",e),Me("pv-total",(e.pvDay||0).toFixed(1)+" kWh"),Me("bat-charge",(e.chargeDay||0).toFixed(1)+" kWh"),Me("bat-discharge",(e.dischargeDay||0).toFixed(1)+" kWh"),Me("load-total",(e.loadDay||0).toFixed(1)+" kWh"),Me("grid-total",(e.gridDay||0).toFixed(1)+" kWh"),Me("essential-total",(e.essentialDay||0).toFixed(1)+" kWh"),console.log("‚úÖ [applySummaryData] UI updated - discharge:",(e.dischargeDay||0).toFixed(1),"kWh"))}async function J(e){try{const t=`${DAILY_ENERGY_API}/api/realtime/daily-energy/${e}`;console.log("‚ö° [Daily Energy] Fetching from:",t);const a=await fetch(t);if(!a.ok)throw new Error(`HTTP ${a.status}`);const n=await a.json();console.log("üì• [Daily Energy] Response:",n);const o=n.today||n.summary;if(n.success&&o){const t={pvDay:void 0!==o.pv?o.pv:void 0!==o.pv_day?o.pv_day:0,chargeDay:void 0!==o.charge?o.charge:void 0!==o.charge_day?o.charge_day:0,dischargeDay:void 0!==o.discharge?o.discharge:void 0!==o.discharge_day?o.discharge_day:0,loadDay:void 0!==o.load?o.load:void 0!==o.total_load_day?o.total_load_day:o.load_day||0,gridDay:void 0!==o.gridIn?o.gridIn:void 0!==o.grid_day?o.grid_day:0,essentialDay:void 0!==o.essential?o.essential:void 0!==o.essential_day?o.essential_day:0};x={deviceId:e,data:t,timestamp:Date.now()},w(),X(t),console.log("‚úÖ [Daily Energy] Updated UI for",e,":",t)}else console.warn("‚ö†Ô∏è [Daily Energy] No data in response for",e)}catch(t){console.warn("‚ö†Ô∏è [Daily Energy] Fetch failed for",e,":",t.message),x.data&&x.deviceId===e||(Me("pv-total","-- kWh"),Me("bat-charge","-- kWh"),Me("bat-discharge","-- kWh"),Me("load-total","-- kWh"),Me("grid-total","-- kWh"),Me("essential-total","-- kWh"))}}function Z(e){const t=document.getElementById("temp-big-value"),a=document.getElementById("temp-max"),n=document.getElementById("temp-min"),o=document.getElementById("temp-max-time"),l=document.getElementById("temp-min-time");e&&void 0!==e.current?(t&&(t.textContent=`${e.current.toFixed(1)}¬∞C`),a&&(a.textContent=`${e.max.toFixed(1)}¬∞C`),n&&(n.textContent=`${e.min.toFixed(1)}¬∞C`),o&&(o.textContent=e.maxTime?`@ ${e.maxTime}`:""),l&&(l.textContent=e.minTime?`@ ${e.minTime}`:"")):(t&&(t.textContent="--¬∞C"),a&&(a.textContent="--¬∞C"),n&&(n.textContent="--¬∞C"),o&&(o.textContent=""),l&&(l.textContent=""))}window.togglePowerDataset=function(e){if(!powerTimelineChart)return;const t=powerTimelineChart.getDatasetMeta(e);t.hidden=!t.hidden,powerTimelineChart.update();const a=document.querySelectorAll("#powerChartLegend .power-legend-btn");a[e]&&(a[e].classList.toggle("opacity-40",t.hidden),a[e].classList.toggle("active",!t.hidden))},window.togglePowerChart2Dataset=function(e){if(!powerStackedChart)return;const t=powerStackedChart.getDatasetMeta(e);t.hidden=!t.hidden,powerStackedChart.update();const a=document.querySelectorAll("#powerChart2Legend .power-legend-btn");a[e]&&(a[e].classList.toggle("opacity-40",t.hidden),a[e].classList.toggle("active",!t.hidden))},window.switchPowerChart=function(e){const t=[document.getElementById("chart1Container"),document.getElementById("chart2Container"),document.getElementById("chart3Container"),document.getElementById("chart4Container")],a=[document.getElementById("chart1Btn"),document.getElementById("chart2Btn"),document.getElementById("chart3Btn"),document.getElementById("chart4Btn")];if(t[0]){if(activeChartNumber=e,navigator.vibrate&&navigator.vibrate(10),t.forEach((t,a)=>{t&&t.classList.toggle("hidden",a!==e-1)}),a.forEach((t,a)=>{t&&(a===e-1?(t.classList.add("bg-indigo-500","text-white","shadow"),t.classList.remove("text-slate-600","dark:text-slate-300")):(t.classList.remove("bg-indigo-500","text-white","shadow"),t.classList.add("text-slate-600","dark:text-slate-300")))}),cachedChartData&&cachedChartData.length>0)switch(e){case 2:ee(cachedChartData);break;case 3:ae(cachedChartData);break;case 4:oe(cachedChartData)}console.log(`üìä Switched to Chart ${e}`)}},window.refreshAllDataForDate=async function(e){const t=new URLSearchParams(window.location.search).get("deviceId")||"P250801055",a=e||(new Date).toISOString().split("T")[0];console.log(`üîÑ Refreshing ALL data for date: ${a}`);const n=document.getElementById("powerChartLoading");n&&n.classList.remove("hidden");try{const e=`https://temperature-soc-power.applike098.workers.dev/api/solar/dashboard/${t}`,n=`https://lightearth.applike098.workers.dev/api/realtime/daily-energy/${t}`,o=`https://temperature-soc-power.applike098.workers.dev/api/realtime/soc-history/${t}?date=${a}`,l=`https://temperature-soc-power.minhlongt358.workers.dev/api/cloud/temperature/${t}/${a}`,r=`https://temperature-soc-power.applike098.workers.dev/api/realtime/power-history/${t}?date=${a}`,[s,i,d,c,g]=await Promise.allSettled([fetch(e),fetch(n),fetch(o),fetch(l),fetch(r)]);if(console.log("‚úÖ All API requests completed"),"fulfilled"===g.status&&g.value.ok){const e=await g.value.json();console.log("üìä Power History response:",e);const t=e.timeline||e.data&&e.data.timeline||[];if(t.length>0){switch(cachedChartData=t,le(t,a),activeChartNumber){case 1:break;case 2:ee(t);break;case 3:ae(t);break;case 4:oe(t)}console.log("‚úÖ Power charts updated with",t.length,"data points")}else console.warn("‚ö†Ô∏è No timeline data in power history response")}if("fulfilled"===d.status&&d.value.ok){const e=await d.value.json();e&&e.data&&(pe(e.data),console.log("‚úÖ SOC chart updated"))}if("fulfilled"===c.status&&c.value.ok){const e=await c.value.json();e&&e.data&&(cachedTempData=e.data,"function"==typeof renderTemperatureChart&&"temp"===activeSocTempTab&&renderTemperatureChart(e.data),console.log("‚úÖ Temperature data cached"))}const m=document.getElementById("energy-chart-date");if(m){const e=new Date(a);m.textContent=e.toLocaleDateString("vi-VN",{weekday:"short",day:"numeric",month:"numeric",year:"numeric"})}navigator.vibrate&&navigator.vibrate(50)}catch(e){console.error("‚ùå Error refreshing data:",e)}finally{n&&n.classList.add("hidden")}},window.switchSocTempChart=function(e){const t=document.getElementById("socContainer"),a=document.getElementById("tempContainer"),n=document.getElementById("socChartBtn"),o=document.getElementById("tempChartBtn"),l=document.getElementById("socTempTitleText"),r=document.getElementById("socTempIcon");if(t&&a){if(navigator.vibrate&&navigator.vibrate(10),activeSocTempTab=e,"soc"===e)t.classList.remove("hidden"),a.classList.add("hidden"),n.classList.add("bg-teal-500","text-white","shadow"),n.classList.remove("text-slate-600","dark:text-slate-300"),o.classList.remove("bg-teal-500","text-white","shadow"),o.classList.add("text-slate-600","dark:text-slate-300"),l&&(l.textContent="Ph·∫ßn TrƒÉm Pin (SOC)"),r&&(r.setAttribute("data-lucide","battery-full"),r.classList.remove("text-orange-500"),r.classList.add("text-teal-500")),socData&&socData.length>0&&setTimeout(()=>pe(),100);else{t.classList.add("hidden"),a.classList.remove("hidden"),o.classList.add("bg-teal-500","text-white","shadow"),o.classList.remove("text-slate-600","dark:text-slate-300"),n.classList.remove("bg-teal-500","text-white","shadow"),n.classList.add("text-slate-600","dark:text-slate-300"),l&&(l.textContent="Bi·ªÉu ƒê·ªì Nhi·ªát ƒê·ªô Bi·∫øn T·∫ßn"),r&&(r.setAttribute("data-lucide","thermometer"),r.classList.remove("text-teal-500"),r.classList.add("text-orange-500")),"undefined"!=typeof lucide&&lucide.createIcons();const e=localStorage.getItem("selectedDevice")||localStorage.getItem("lastDeviceId"),s=document.getElementById("dateInput")?.value||(new Date).toISOString().split("T")[0];e&&async function(e,t){const a=document.getElementById("tempChartLoading");a&&a.classList.remove("hidden");try{const a=`https://temperature-soc-power.applike098.workers.dev/api/cloud/temperature/${e}/${t}`;console.log("üå°Ô∏è Fetching temperature timeline:",a);const n=await fetch(a);if(!n.ok)throw new Error(`HTTP ${n.status}`);const o=await n.json();console.log("üå°Ô∏è Temperature data received:",o),o.success&&o.timeline&&o.timeline.length>0?(cachedTempData=o,Z(o),function(e){const t=document.getElementById("tempChart");if(!t)return void console.warn("‚ö†Ô∏è tempChart canvas not found");const a=[],n=[];e.forEach(e=>{const t=e.t||e.time||"";a.push(t),n.push(e.temp||0)}),tempChartInstance&&tempChartInstance.destroy();const o=t.getContext("2d"),l=o.createLinearGradient(0,0,0,200);l.addColorStop(0,"rgba(249, 115, 22, 0.6)"),l.addColorStop(.5,"rgba(249, 115, 22, 0.3)"),l.addColorStop(1,"rgba(249, 115, 22, 0.05)"),tempChartInstance=new Chart(o,{type:"line",data:{labels:a,datasets:[{label:"Nhi·ªát ƒê·ªô",data:n,borderColor:"#f97316",backgroundColor:l,borderWidth:2.5,fill:!0,tension:.4,pointRadius:0,pointHoverRadius:12,pointHoverBackgroundColor:"#f97316",pointHoverBorderColor:"#fff",pointHoverBorderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},onHover:(e,t)=>{t.length&&triggerHaptic()},plugins:{legend:{display:!1},tooltip:{position:"topRight",backgroundColor:"rgba(15, 23, 42, 0.95)",titleColor:"#f8fafc",bodyColor:"#fb923c",titleFont:{size:11},bodyFont:{size:16,weight:"bold"},padding:12,cornerRadius:8,displayColors:!1,callbacks:{title:e=>`‚è∞ ${e[0].label}`,label:e=>`üå°Ô∏è ${e.parsed.y.toFixed(1)}¬∞C`}}},scales:{y:{beginAtZero:!1,suggestedMin:Math.min(...n)-5,suggestedMax:Math.max(...n)+5,grid:{color:"rgba(148, 163, 184, 0.1)",drawBorder:!1},ticks:{callback:e=>`${e}¬∞C`,font:{size:10},color:"rgba(148, 163, 184, 0.7)",maxTicksLimit:6}},x:{grid:{display:!1},ticks:{font:{size:9},color:"rgba(148, 163, 184, 0.7)",maxRotation:0,autoSkip:!0,maxTicksLimit:12}}}}}),console.log("‚úÖ Temperature Chart created with",e.length,"data points")}(o.timeline)):(console.warn("‚ö†Ô∏è No temperature data available"),Z(null))}catch(e){console.error("‚ùå Temperature fetch error:",e),Z(null)}finally{a&&a.classList.add("hidden")}}(e,s)}console.log(`üå°Ô∏è Switched to ${"soc"===e?"SOC":"Temperature"} chart`)}};let Q=null;async function ee(e){const t=document.getElementById("gridSourceChart");if(!t)return;const a=t.getContext("2d"),n=[];for(let e=0;e<24;e++)for(let t=0;t<60;t+=5)n.push(`${String(e).padStart(2,"0")}:${String(t).padStart(2,"0")}`);const o=new Array(288).fill(0),l=new Array(288).fill(0),r=new Array(288).fill(0);e.forEach(e=>{const t=e.t||e.time;if(!t)return;const[a,n]=t.split(":").map(Number),s=12*a+Math.floor(n/5);if(s>=0&&s<288){const t=e.grid??e.gridPower??0;o[s]=Math.max(0,t),l[s]=e.load??e.loadPower??0,r[s]=Math.abs(Math.min(0,t))}});const s=window.CURRENT_DEVICE_ID||new URLSearchParams(window.location.search).get("id")||"P250801055";try{const e=`https://temperature-soc-power.applike098.workers.dev/api/realtime/daily-energy/${s}`,t=await fetch(e);if(t.ok){const e=await t.json(),a=e.summary||e.today||{},n=document.getElementById("gridPurchaseTotal"),o=document.getElementById("essentialBackupTotal"),l=document.getElementById("loadConsumptionTotal"),r=a.grid??a.grid_in??0,s=a.essential??0,i=a.load??a.totalLoad??0;n&&(n.textContent=`${r.toFixed(1)} KWh`),o&&(o.textContent=`${s.toFixed(1)} KWh`),l&&(l.textContent=`${i.toFixed(1)} KWh`),console.log("‚úÖ Grid Source totals updated from daily-energy API:",{gridKwh:r,essentialKwh:s,loadKwh:i})}}catch(e){console.warn("‚ö†Ô∏è Failed to fetch daily-energy for grid source totals:",e)}Q&&Q.destroy();const i=a.createLinearGradient(0,0,0,280);i.addColorStop(0,"rgba(59, 130, 246, 0.6)"),i.addColorStop(1,"rgba(59, 130, 246, 0.1)");const d=a.createLinearGradient(0,0,0,280);d.addColorStop(0,"rgba(34, 197, 94, 0.5)"),d.addColorStop(1,"rgba(34, 197, 94, 0.05)");const c=a.createLinearGradient(0,0,0,280);c.addColorStop(0,"rgba(245, 158, 11, 0.5)"),c.addColorStop(1,"rgba(245, 158, 11, 0.05)"),Q=new Chart(a,{type:"line",data:{labels:n,datasets:[{label:"T·∫£i h√≤a l∆∞·ªõi",data:r,borderColor:"#3b82f6",backgroundColor:i,fill:!0,tension:.3,pointRadius:0,pointHoverRadius:12,borderWidth:2,order:3},{label:"C√¥ng su·∫•t c·ªïng load",data:l,borderColor:"#22c55e",backgroundColor:d,fill:!0,tension:.3,pointRadius:0,pointHoverRadius:12,borderWidth:1.5,order:2},{label:"CS mua t·ª´ l∆∞·ªõi",data:o,borderColor:"#f59e0b",backgroundColor:c,fill:!0,tension:.3,pointRadius:0,pointHoverRadius:12,borderWidth:1.5,order:1}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},onHover:(e,t)=>{t.length&&triggerHaptic()},plugins:{legend:{display:!1},tooltip:{position:"topRight",backgroundColor:"rgba(15, 23, 42, 0.95)",titleColor:"#f8fafc",bodyColor:"#e2e8f0",padding:12,cornerRadius:10,displayColors:!0,boxWidth:10,titleFont:{size:12,weight:"bold"},bodyFont:{size:11}}},scales:{y:{beginAtZero:!0,grid:{color:"rgba(148, 163, 184, 0.15)",drawBorder:!1},ticks:{callback:e=>e>=1e3?(e/1e3).toFixed(1)+"K":e,font:{size:10},color:"rgba(148, 163, 184, 0.8)"}},x:{grid:{display:!1},ticks:{maxTicksLimit:7,font:{size:10},color:"rgba(148, 163, 184, 0.8)",callback:function(e,t){const a=this.getLabelForValue(e);return a.endsWith(":00")?a:""}}}}}}),console.log("‚úÖ Grid Source Chart rendered with gradients")}let te=null;async function ae(e){const t=document.getElementById("pvTodayChart");if(!t)return;const a=t.getContext("2d"),n=[];for(let e=0;e<24;e++)for(let t=0;t<60;t+=5)n.push(`${String(e).padStart(2,"0")}:${String(t).padStart(2,"0")}`);const o=new Array(288).fill(0);e.forEach(e=>{const t=e.t||e.time;if(!t)return;const[a,n]=t.split(":").map(Number),l=12*a+Math.floor(n/5);if(l>=0&&l<288){const t=e.pv??e.pvPower??0;o[l]=t}});const l=window.CURRENT_DEVICE_ID||new URLSearchParams(window.location.search).get("id")||"P250801055",r=document.getElementById("pvTodayTotal");try{const e=`https://temperature-soc-power.applike098.workers.dev/api/realtime/daily-energy/${l}`,t=await fetch(e);if(t.ok){const e=await t.json(),a=(e.summary||e.today||{}).pv??0;r&&(r.textContent=`${a.toFixed(1)} KWh`),console.log("‚úÖ PV total updated from daily-energy API:",a)}}catch(e){console.warn("‚ö†Ô∏è Failed to fetch daily-energy for PV total:",e);let t=0;o.forEach(e=>t+=e/12),r&&(r.textContent=`${(t/1e3).toFixed(1)} KWh`)}te&&te.destroy();const s=a.createLinearGradient(0,0,0,280);s.addColorStop(0,"rgba(251, 191, 36, 0.6)"),s.addColorStop(1,"rgba(251, 191, 36, 0.1)"),te=new Chart(a,{type:"line",data:{labels:n,datasets:[{label:"PV Power",data:o,borderColor:"#fbbf24",backgroundColor:s,fill:!0,tension:.4,pointRadius:0,pointHoverRadius:12,borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},onHover:(e,t)=>{t.length&&triggerHaptic()},plugins:{legend:{display:!1},tooltip:{position:"topRight",backgroundColor:"rgba(15, 23, 42, 0.95)",titleColor:"#f8fafc",bodyColor:"#fbbf24",padding:12,cornerRadius:10,displayColors:!1,titleFont:{size:12,weight:"bold"},bodyFont:{size:14,weight:"bold"},callbacks:{label:e=>`‚òÄÔ∏è ${e.parsed.y} W`}}},scales:{y:{beginAtZero:!0,grid:{color:"rgba(148, 163, 184, 0.15)",drawBorder:!1},ticks:{callback:e=>e>=1e3?(e/1e3).toFixed(1)+"K":e,font:{size:10},color:"rgba(148, 163, 184, 0.8)"}},x:{grid:{display:!1},ticks:{maxTicksLimit:7,font:{size:10},color:"rgba(148, 163, 184, 0.8)",callback:function(e,t){const a=this.getLabelForValue(e);return a.endsWith(":00")?a:""}}}}}}),console.log("‚úÖ PV Today Chart rendered")}let ne=null;async function oe(e){const t=document.getElementById("batteryFlowChart");if(!t)return;const a=t.getContext("2d"),n=[...e].filter(e=>e.t||e.time).sort((e,t)=>{const a=e.t||e.time,n=t.t||t.time;return a.localeCompare(n)}),o=[],l=[];let r=null;if(n.forEach(e=>{const t=e.t||e.time,a=e.bat??e.batteryPower??0;null!==r&&a===r||(o.push(t),l.push(a),r=a)}),0===o.length)for(let e=0;e<24;e+=4)o.push(`${String(e).padStart(2,"0")}:00`),l.push(0);console.log(`üìä Battery chart compressed: ${n.length} points ‚Üí ${o.length} unique values`);const s=window.CURRENT_DEVICE_ID||new URLSearchParams(window.location.search).get("id")||"P250801055";try{const e=`https://temperature-soc-power.applike098.workers.dev/api/realtime/daily-energy/${s}`,t=await fetch(e);if(t.ok){const e=await t.json(),a=e.summary||e.today||{},n=document.getElementById("chargeTotal"),o=document.getElementById("dischargeTotal"),l=a.charge??a.charge_day??0,r=a.discharge??a.discharge_day??0;n&&(n.textContent=`${l.toFixed(1)} KWh`),o&&(o.textContent=`${r.toFixed(1)} KWh`),console.log("‚úÖ Battery totals updated from daily-energy API:",{charge:l,discharge:r})}}catch(e){console.warn("‚ö†Ô∏è Failed to fetch daily-energy for battery totals:",e);let t=0,a=0;l.forEach(e=>{e>0?t+=e/6:a+=Math.abs(e)/6});const n=document.getElementById("chargeTotal"),o=document.getElementById("dischargeTotal");n&&(n.textContent=`${(t/1e3).toFixed(1)} KWh`),o&&(o.textContent=`${(a/1e3).toFixed(1)} KWh`)}ne&&ne.destroy();const i=a.createLinearGradient(0,0,0,280);i.addColorStop(0,"rgba(244, 114, 182, 0.6)"),i.addColorStop(.5,"rgba(244, 114, 182, 0.3)"),i.addColorStop(1,"rgba(244, 114, 182, 0.1)"),ne=new Chart(a,{type:"line",data:{labels:o,datasets:[{label:"Battery Flow",data:l,borderColor:"#f472b6",backgroundColor:i,fill:"origin",tension:.3,pointRadius:0,pointHoverRadius:12,borderWidth:1.5}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},onHover:(e,t)=>{t.length&&triggerHaptic()},plugins:{legend:{display:!1},tooltip:{position:"topRight",backgroundColor:"rgba(15, 23, 42, 0.95)",titleColor:"#f8fafc",padding:12,cornerRadius:10,displayColors:!1,titleFont:{size:12,weight:"bold"},bodyFont:{size:14,weight:"bold"},callbacks:{label:e=>{const t=e.parsed.y;return t>0?`‚ö° S·∫°c: ${t} W`:t<0?`üîã X·∫£: ${Math.abs(t)} W`:"üîã 0 W"},labelTextColor:e=>{const t=e.parsed.y;return t>0?"#22c55e":t<0?"#ef4444":"#e2e8f0"}}}},scales:{y:{grid:{color:e=>0===e.tick.value?"rgba(148, 163, 184, 0.5)":"rgba(148, 163, 184, 0.15)",drawBorder:!1},ticks:{callback:e=>e>=1e3||e<=-1e3?(e/1e3).toFixed(1)+"K":e,font:{size:10},color:"rgba(148, 163, 184, 0.8)"}},x:{grid:{display:!1},ticks:{maxTicksLimit:7,font:{size:10},color:"rgba(148, 163, 184, 0.8)",callback:function(e,t){const a=this.getLabelForValue(e);return a.endsWith(":00")?a:""}}}}}}),console.log("‚úÖ Battery Flow Chart rendered")}function le(e,t){const a=document.getElementById("powerTimelineChart"),n=document.getElementById("powerChartLoading");if(!a)return void console.warn("‚ö†Ô∏è powerTimelineChart canvas not found");n&&n.classList.add("hidden");const o=[];for(let e=0;e<24;e++)for(let t=0;t<60;t+=5)o.push(`${String(e).padStart(2,"0")}:${String(t).padStart(2,"0")}`);const l=new Array(288).fill(0),r=new Array(288).fill(0),s=new Array(288).fill(0),i=new Array(288).fill(0),d=new Array(288).fill(0),c=new Array(288).fill(0);let g=0,m=0,u=0,p=0,h=0,y=0;e.forEach(e=>{const t=e.t||e.time||"";let a,n;if(t.includes("T")){const e=new Date(t);a=e.getHours(),n=e.getMinutes()}else{if(!t.includes(":"))return;{const e=t.split(":");a=parseInt(e[0],10),n=parseInt(e[1],10)}}const o=12*a+Math.floor(n/5);if(o<0||o>=288)return;const v=e.pvPower??e.pv??0,f=e.loadPower??e.load??0,b=e.gridPower??e.grid??0,w=e.batteryPower??e.bat??e.battery??0,x=e.backupPower??e.backup??e.essential??0;l[o]=v,r[o]=f,s[o]=b,i[o]=w>0?w:0,d[o]=w<0?Math.abs(w):0,c[o]=x,g+=v*(5/60)/1e3,m+=f*(5/60)/1e3,u+=b*(5/60)/1e3,w>0?p+=w*(5/60)/1e3:h+=Math.abs(w)*(5/60)/1e3,y+=x*(5/60)/1e3}),console.log(`üìà Power chart: 288 slots (24h), Data points: ${e.length}, PV: ${g.toFixed(1)} kWh`),powerTimelineChart&&powerTimelineChart.destroy();const v=a.getContext("2d"),f=(e,t)=>{const a=v.createLinearGradient(0,0,0,450);return a.addColorStop(0,e),a.addColorStop(1,t),a};powerTimelineChart=new Chart(v,{type:"line",data:{labels:o,datasets:[{label:"PV",data:l,borderColor:"#f59e0b",backgroundColor:f("rgba(245, 158, 11, 0.25)","rgba(245, 158, 11, 0.02)"),borderWidth:2,fill:!0,tension:.3,pointRadius:0,pointHoverRadius:12,pointHoverBorderWidth:3,pointHoverBackgroundColor:"#f59e0b",pointHoverBorderColor:"#fff",spanGaps:!1},{label:"T·∫£i",data:r,borderColor:"#3b82f6",backgroundColor:f("rgba(59, 130, 246, 0.25)","rgba(59, 130, 246, 0.02)"),borderWidth:2,fill:!0,tension:.3,pointRadius:0,pointHoverRadius:12,pointHoverBorderWidth:3,pointHoverBackgroundColor:"#3b82f6",pointHoverBorderColor:"#fff",spanGaps:!1},{label:"EVN",data:s,borderColor:"#a855f7",backgroundColor:f("rgba(168, 85, 247, 0.25)","rgba(168, 85, 247, 0.02)"),borderWidth:2,fill:!0,tension:.3,pointRadius:0,pointHoverRadius:12,pointHoverBorderWidth:3,pointHoverBackgroundColor:"#a855f7",pointHoverBorderColor:"#fff",spanGaps:!1},{label:"N·∫°p Pin",data:i,borderColor:"#22c55e",backgroundColor:f("rgba(34, 197, 94, 0.25)","rgba(34, 197, 94, 0.02)"),borderWidth:2,fill:!0,tension:.3,pointRadius:0,pointHoverRadius:12,pointHoverBorderWidth:3,pointHoverBackgroundColor:"#22c55e",pointHoverBorderColor:"#fff",spanGaps:!1},{label:"X·∫£ Pin",data:d,borderColor:"#ef4444",backgroundColor:f("rgba(239, 68, 68, 0.25)","rgba(239, 68, 68, 0.02)"),borderWidth:2,fill:!0,tension:.3,pointRadius:0,pointHoverRadius:12,pointHoverBorderWidth:3,pointHoverBackgroundColor:"#ef4444",pointHoverBorderColor:"#fff",spanGaps:!1},{label:"D·ª± Ph√≤ng",data:c,borderColor:"#06b6d4",backgroundColor:f("rgba(6, 182, 212, 0.25)","rgba(6, 182, 212, 0.02)"),borderWidth:2,fill:!0,tension:.3,pointRadius:0,pointHoverRadius:12,pointHoverBorderWidth:3,pointHoverBackgroundColor:"#06b6d4",pointHoverBorderColor:"#fff",spanGaps:!1}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"nearest",intersect:!1,axis:"x"},hover:{mode:"nearest",intersect:!1},onHover:(e,t)=>{t.length&&triggerHaptic()},plugins:{legend:{display:!1},tooltip:{position:"topRight",backgroundColor:"rgba(15, 23, 42, 0.95)",titleColor:"#f8fafc",bodyColor:"#e2e8f0",padding:12,cornerRadius:8,displayColors:!0,callbacks:{title:e=>`‚è∞ ${e[0].label}`,label:e=>{const t=e.parsed.y;return null===t?null:`${["‚òÄÔ∏è","üè†","üîå","üîã+","üîã-","üõ°Ô∏è"][e.datasetIndex]} ${e.dataset.label}: ${Math.round(t)} W`},filter:e=>null!==e.parsed.y&&e.parsed.y>0}}},scales:{y:{beginAtZero:!0,grid:{color:"rgba(148, 163, 184, 0.1)",drawBorder:!1},ticks:{callback:e=>e>=1e3?(e/1e3).toFixed(1)+"kW":e+"W",font:{size:10},color:"rgba(148, 163, 184, 0.7)",maxTicksLimit:8}},x:{grid:{display:!1},ticks:{font:{size:9},color:"rgba(148, 163, 184, 0.7)",maxRotation:0,autoSkip:!0,maxTicksLimit:12,callback:function(e,t){const a=this.getLabelForValue(e);return a&&a.endsWith(":00")&&parseInt(a.split(":")[0])%2==0?a.split(":")[0]+"h":""}}}}}}),console.log("‚úÖ Power Timeline Chart created (6 datasets, 24h timeline)")}function re(e){if(!e||!e.timeline||0===e.timeline.length)return void console.warn("‚ö†Ô∏è No Cloud data to update chart");const t=e.timeline;console.log(`üìä Converting Cloud data to chart format: ${t.length} data points`);const a=new Date,n=a.getHours(),o=a.getMinutes(),l=12*n+Math.floor(o/5),r=e.date||document.getElementById("dateInput")?.value,s=a.toISOString().split("T")[0],i=r===s,d=i?l:287;console.log(`üìä Today: ${s}, Query: ${r}, isToday: ${i}, maxAllowedSlot: ${d}`);const c=new Array(288).fill(null),g=new Array(288).fill(null),m=new Array(288).fill(null),u=new Array(288).fill(null);let p=-1;if(t.forEach((e,t)=>{let a,n;const o=e.t||e.time;if(o&&o.includes(":")&&o.length<=5){const e=o.split(":");a=parseInt(e[0],10),n=parseInt(e[1],10)}else if(o&&o.includes("T")){const e=new Date(o);a=e.getHours(),n=e.getMinutes()}else a=Math.floor(t/12),n=t%12*5;const l=12*a+Math.floor(n/5);if(l>=0&&l<288&&l<=d){c[l]=e.pvPower??e.pv??0,g[l]=e.batteryPower??e.bat??e.battery??0,m[l]=e.loadPower??e.load??0,u[l]=e.gridPower??e.grid??0;const t=e.pvPower??e.pv??0,a=e.batteryPower??e.bat??e.battery??0,n=e.loadPower??e.load??0,o=e.gridPower??e.grid??0;(t>0||0!==a||n>0||o>0)&&l>p&&(p=l)}}),-1===p&&(p=Math.min(t.length-1,d)),console.log(`üìä Last data slot: ${p} (${Math.floor(p/12)}:${String(p%12*5).padStart(2,"0")})`),i)for(let e=p+1;e<288;e++)c[e]=null,g[e]=null,m[e]=null,u[e]=null;const h=c.filter(e=>null!==e).length;console.log(`üìä Cloud data converted: ${t.length} points -> ${h} chart slots`),console.log("üìä Sample data - PV max:",Math.max(...c.filter(e=>null!==e&&e>0),0),"Load max:",Math.max(...m.filter(e=>null!==e&&e>0),0));switch(function(e){if(!e||0===e.length)return;let t=0,a="--:--",n=0,o="--:--",l=0,r="--:--",s=0,i="--:--",d=0,c="--:--";const g=e=>{if(e.t)return e.t;if(!e.time)return"--:--";if(e.time.includes(":")&&e.time.length<=5)return e.time;const t=new Date(e.time);return`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`};e.forEach(e=>{const m=g(e),u=e.pvPower??e.pv??0,p=e.batteryPower??e.bat??e.battery??0,h=e.loadPower??e.load??0,y=e.gridPower??e.grid??0;u>t&&(t=u,a=m),p>0&&p>n&&(n=p,o=m),p<0&&Math.abs(p)>l&&(l=Math.abs(p),r=m),h>s&&(s=h,i=m),y>d&&(d=y,c=m)});const m=(e,t)=>{const a=document.getElementById(e);a&&(a.textContent=t)};m("chart-pv-peak",t>0?`${Math.round(t)} W`:"--"),m("chart-pv-time",a),m("chart-charge-peak",n>0?`${Math.round(n)} W`:"--"),m("chart-charge-time",o),m("chart-discharge-peak",l>0?`${Math.round(l)} W`:"--"),m("chart-discharge-time",r),m("chart-load-peak",s>0?`${Math.round(s)} W`:"--"),m("chart-load-time",i),m("chart-grid-peak",d>0?`${Math.round(d)} W`:"--"),m("chart-grid-time",c),console.log("üìä Peak stats updated from LightEarth Cloud:",{pv:`${t}W @ ${a}`,charge:`${n}W @ ${o}`,discharge:`${l}W @ ${r}`,load:`${s}W @ ${i}`,grid:`${d}W @ ${c}`})}(t.filter((e,t)=>{let a;const n=e.t||e.time;if(n&&n.includes(":")&&n.length<=5){const e=n.split(":");a=12*parseInt(e[0],10)+Math.floor(parseInt(e[1],10)/5)}else a=t;return a<=d})),cachedChartData=t,console.log("üíæ Timeline data cached for all charts:",t.length,"points"),le(t,e.date),activeChartNumber){case 2:ee(t);break;case 3:ae(t);break;case 4:oe(t)}}function se(e){const{batData:t,pvData:a,otherData:n}=e,o=(t.data?.bats?.[0]?.tableValue||0)/10,l=(t.data?.bats?.[1]?.tableValue||0)/10,r=(a.data?.pv?.tableValue||0)/10,s=(n.data?.homeload?.tableValue||0)/10,i=(n.data?.grid?.tableValue||0)/10,d=(n.data?.essentialLoad?.tableValue||0)/10;Me("pv-total",r.toFixed(1)+" kWh"),Me("load-total",s.toFixed(1)+" kWh"),Me("grid-total",i.toFixed(1)+" kWh"),Me("essential-total",d.toFixed(1)+" kWh"),Me("bat-charge",o.toFixed(1)+" kWh"),Me("bat-discharge",l.toFixed(1)+" kWh"),console.log("‚úÖ Summary stats updated from Lightearth:",{pv:r,load:s,grid:i,essential:d,batCharge:o,batDischarge:l});const c=new Date,g=12*c.getHours()+Math.floor(c.getMinutes()/5),m=document.getElementById("dateInput")?.value,u=m===c.toISOString().split("T")[0],p=u?g:287;console.log(`üìä Lightearth data: isToday=${u}, maxAllowedSlot=${p}`);let h=a.data?.pv?.tableValueInfo||[],y=t.data?.tableValueInfo||[],v=n.data?.homeload?.tableValueInfo||[],f=n.data?.grid?.tableValueInfo||[],b=n.data?.essentialLoad?.tableValueInfo||[];u&&h.length>0&&(h=h.map((e,t)=>t<=p?e:null),y=y.map((e,t)=>t<=p?e:null),v=v.map((e,t)=>t<=p?e:null),f=f.map((e,t)=>t<=p?e:null),b=b.map((e,t)=>t<=p?e:null),console.log(`üìä Truncated Lightearth data to slot ${p}`));const w={pv:{tableValueInfo:h},bat:{tableValueInfo:y},load:{tableValueInfo:v},grid:{tableValueInfo:f},essentialLoad:{tableValueInfo:b}};console.log("üìä Updating combined energy chart with Lightearth data"),xe(w),console.log("üìä Day data loaded - Realtime display will show empty until system data arrives")}const ie=3e5;function de(e){const t=document.getElementById("tempMinMaxBadge"),a=document.getElementById("temp-min-value"),n=document.getElementById("temp-max-value");t&&e&&e.success&&null!==e.min&&null!==e.max?(a.textContent=`${e.min}¬∞C`,n.textContent=`${e.max}¬∞C`,e.minTime&&(a.title=`Th·∫•p nh·∫•t l√∫c ${e.minTime}`),e.maxTime&&(n.title=`Cao nh·∫•t l√∫c ${e.maxTime}`),t.classList.remove("hidden"),t.classList.add("flex"),console.log(`‚úÖ Temperature: ${e.min}¬∞C (${e.minTime}) - ${e.max}¬∞C (${e.maxTime})`),null!==e.current&&void 0!==e.current&&(Me("device-temp",`${e.current}¬∞C`),Me("device-temp-info",`${e.current}¬∞C`))):(console.warn("‚ö†Ô∏è Temperature data not available or invalid"),t&&t.classList.add("hidden"))}const ce=864e5;function ge(e){if(!e)return;const t=document.getElementById("device-type"),a=document.getElementById("inverter-type"),n=document.getElementById("inverter-type-basic");t&&(t.textContent=e),a&&(a.textContent=e),n&&(n.textContent=e),console.log(`‚úÖ Device type updated: ${e}`)}const me=3e5;async function ue(){console.log("üîã fetchSOCData() called");const e=document.getElementById("deviceId")?.value?.trim(),t=new URLSearchParams(window.location.search).get("deviceId"),a=e||t;if(!a)return void console.error("‚ùå SOC fetch ABORTED: No deviceId");const n=document.getElementById("dateInput")?.value,o=n||(new Date).toISOString().split("T")[0],l=Date.now();if(socCache.deviceId===a&&socCache.date===o&&socCache.data&&l-socCache.timestamp<me){const e=Math.round((l-socCache.timestamp)/1e3);return console.log(`üîã Using cached SOC data (age: ${e}s, TTL: 5min, points: ${socCache.data.timeline?.length||0})`),void(socCache.data.timeline&&socCache.data.timeline.length>0&&(socData=socCache.data.timeline,pe(),updateLastFetchTime(),he()))}const r=function(e,t){return`${getCurrentWorkerTSP()}/api/realtime/soc-history/${e}?date=${t}`}(a,o)+`&_t=${l}`;let s=null;console.log("üîã Fetching fresh SOC data from:",r);try{const e=await fetch(r,{method:"GET",cache:"no-store",headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache"}});e.ok?(s=await e.json(),s.success&&s.timeline&&s.timeline.length>0?(console.log(`‚úÖ SOC API success: ${s.timeline.length} points`),socCache={deviceId:a,date:o,data:s,timestamp:l},console.log("üíæ SOC data cached (TTL: 5 minutes)")):s.error?(console.warn(`‚ö†Ô∏è SOC API error: ${s.error}`),s=null):(console.warn(`‚ö†Ô∏è SOC API: no data for ${a}`),s=null)):console.warn(`‚ö†Ô∏è SOC API HTTP error: ${e.status}`)}catch(e){console.warn(`‚ö†Ô∏è SOC API failed: ${e.message}`)}s&&s.timeline&&Array.isArray(s.timeline)&&s.timeline.length>0?(socData=s.timeline,socApiStats={min:s.min,max:s.max,minTime:s.minTime,maxTime:s.maxTime},pe(),function(){const e=document.getElementById("soc-last-update");if(e){const t=(new Date).toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit",second:"2-digit"});e.textContent=`C·∫≠p nh·∫≠t: ${t}`}}("LightEarth Cloud"),he(),console.log(`‚úÖ [SOC] Chart rendered with ${socData.length} points, API min=${s.min}%, max=${s.max}%`)):(console.warn(`‚ö†Ô∏è [SOC] No data available for ${a} on ${o}`),socData=[],socApiStats={min:null,max:null,minTime:null,maxTime:null},function(){if(!document.getElementById("socChart"))return;socChartInstance&&(socChartInstance.destroy(),socChartInstance=null);const e=document.getElementById("soc-big-value"),t=document.getElementById("soc-max"),a=document.getElementById("soc-min");e&&(e.textContent="--%");t&&(t.textContent="--%");a&&(a.textContent="--%")}())}function pe(){console.log("üé®üé®üé® renderSOCChart CALLED, socData length:",socData.length);const e=document.getElementById("socChart");if(!e)return void console.error("‚ùå [SOC] Canvas element not found!");if(0===socData.length)return void console.warn("‚ö†Ô∏è [SOC] No data to render");const t=e.getBoundingClientRect();if(console.log("üìê [SOC] Canvas rect:",t.width,"x",t.height),0===t.width||0===t.height)return console.warn("‚ö†Ô∏è [SOC] Canvas not visible, retrying in 200ms..."),void setTimeout(()=>pe(),200);socChartInstance&&(console.log("üóëÔ∏è [SOC] Destroying existing chart instance"),socChartInstance.destroy(),socChartInstance=null);const a=socData.map(e=>{if(e.t)return e.t;if(e.time){return new Date(e.time).toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"})}return""}),n=socData.map(e=>void 0!==e.soc?e.soc:void 0!==e.value?e.value:0);let o,l;if(null!==socApiStats.min&&null!==socApiStats.max)o=socApiStats.max,l=socApiStats.min,console.log(`üìä [SOC] Using API stats: min=${l}%, max=${o}%`);else{const e=n.filter(e=>null!=e&&e>1);o=e.length>0?Math.max(...e):0,l=e.length>0?Math.min(...e):0,console.log(`üìä [SOC] Using local stats (filtered >1%): min=${l}%, max=${o}%`)}const r=n[n.length-1]||0,s=(socData[socData.length-1],document.getElementById("soc-big-value")),i=document.getElementById("soc-max"),d=document.getElementById("soc-min");s&&(s.textContent=`${r}%`),i&&(i.textContent=`${o}%`),d&&(d.textContent=`${l}%`);const c=e.getContext("2d").createLinearGradient(0,0,0,200);c.addColorStop(0,"rgba(20, 184, 166, 0.4)"),c.addColorStop(1,"rgba(20, 184, 166, 0.02)"),socChartInstance=new Chart(e,{type:"line",data:{labels:a,datasets:[{label:"SOC (%)",data:n,borderColor:"rgb(20, 184, 166)",backgroundColor:c,borderWidth:2.5,fill:!0,tension:.3,pointRadius:0,pointHoverRadius:12,pointHoverBackgroundColor:"rgb(20, 184, 166)",pointHoverBorderColor:"#fff",pointHoverBorderWidth:3}]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,onHover:(e,t)=>{t.length&&(console.log("üîî SOC chart hover - triggering haptic"),triggerHaptic())},plugins:{legend:{display:!1},tooltip:{position:"topRight",enabled:!0,backgroundColor:"rgba(15, 23, 42, 0.95)",titleColor:"#14b8a6",bodyColor:"#f1f5f9",titleFont:{size:12,weight:"bold"},bodyFont:{size:16,weight:"bold"},padding:12,cornerRadius:10,displayColors:!1,mode:"nearest",intersect:!1,axis:"x",callbacks:{title:e=>`‚è∞ ${e[0].label}`,label:e=>`üîã ${e.parsed.y}%`}}},scales:{y:{min:0,max:100,grid:{color:"rgba(148, 163, 184, 0.1)",drawBorder:!1},ticks:{callback:e=>`${e}%`,font:{size:10},color:"rgba(148, 163, 184, 0.8)",stepSize:25}},x:{grid:{display:!1},ticks:{font:{size:9},color:"rgba(148, 163, 184, 0.7)",maxRotation:0,autoSkip:!0,maxTicksLimit:8}}},interaction:{mode:"nearest",intersect:!1,axis:"x"},hover:{mode:"nearest",intersect:!1,animationDuration:0},events:["mousemove","mouseout","click","touchstart","touchmove","touchend"]}}),console.log("‚úÖ SOC Chart rendered with built-in tooltip"),console.log("‚úÖ SOC Chart rendered with enhanced touch support"),e.addEventListener("touchmove",()=>triggerHaptic(),{passive:!0}),e.addEventListener("mousemove",()=>triggerHaptic())}function he(){socAutoReloadInterval&&clearInterval(socAutoReloadInterval),socAutoReloadInterval=setInterval(()=>{ue()},3e5),console.log("üîÑ SOC auto-reload started (every 5 minutes)")}function ye(e){let t=e.deviceId;e.remarkName&&e.remarkName.length>0&&(t+=" - "+e.remarkName),Me("device-id",t.substring(0,40)),Me("device-type",e.deviceType),Me("inverter-type",e.deviceType),Me("device-status",1===e.onlineStatus?"Online":"Offline");const a=document.getElementById("device-status");a&&(1===e.onlineStatus?a.className="text-green-600 dark:text-green-400 font-semibold":a.className="text-red-600 dark:text-red-400 font-semibold")}function ve(e){if(e.deviceNotFound)return void(deviceNotFoundShown||(Me("pv-power","N/A"),Ve("pv-desc",'<span class="text-red-400 text-xs">‚è≥ ƒêang k·∫øt n·ªëi thi·∫øt b·ªã...</span>'),Me("grid-power","N/A"),Me("grid-voltage","N/A"),Me("battery-percent-icon","N/A"),Ve("battery-status-text",'<span class="text-red-400">Kh√¥ng t√¨m th·∫•y</span>'),Ve("battery-power",'<span class="text-red-400">--</span>'),Me("batteryVoltageDisplay","--"),Me("device-temp","N/A"),Me("device-temp-info","--"),Me("essential-power","N/A"),Me("load-power","N/A"),Me("acout-power","N/A"),console.error(`‚ùå Device not found: ${e.errorMessage}`),deviceNotFoundShown=!0));deviceNotFoundShown=!1;if(e.noRealtimeData||null===e.pvTotalPower&&null===e.gridValue)return void console.log("‚è≥ Realtime: No new data - keeping previous values, waiting for next fetch...");Me("pv-power",`${e.pvTotalPower}W`);const t=document.getElementById("sun-1"),a=document.getElementById("sun-2"),n=document.getElementById("sun-3"),o=e.pvTotalPower||0;o>=1?t?.classList.add("visible"):t?.classList.remove("visible"),o>2e3?a?.classList.add("visible"):a?.classList.remove("visible"),o>3e3?n?.classList.add("visible"):n?.classList.remove("visible"),e.pv2Power?Ve("pv-desc",`\n                <span class="font-black text-xs sm:text-sm">${e.pv1Power}W</span> \n                <span class="text-[10px] sm:text-[11px] opacity-70">${e.pv1Voltage}V</span> \n                <span class="opacity-50 mx-0.5">|</span> \n                <span class="font-black text-xs sm:text-sm">${e.pv2Power}W</span> \n                <span class="text-[10px] sm:text-[11px] opacity-70">${e.pv2Voltage}V</span>\n            `):Me("pv-desc",`${e.pv1Voltage}V`),Me("grid-power",`${e.gridValue}W`),Me("grid-voltage",`${e.gridVoltageValue}V`);const l=document.getElementById("evn-spark"),r=document.getElementById("evn-spark-basic");Math.abs(e.gridValue||0)>20?(l?.classList.add("active"),r?.classList.add("active")):(l?.classList.remove("active"),r?.classList.remove("active"));const s=e.batteryPercent||0;Me("battery-percent-icon",`${s}%`);const i=document.getElementById("battery-fill");if(i&&(i.style.width=`${s}%`,i.className=s<=20?"absolute left-0 top-0 bottom-0 bg-red-500 transition-all duration-500":s<=50?"absolute left-0 top-0 bottom-0 bg-yellow-500 transition-all duration-500":"absolute left-0 top-0 bottom-0 bg-emerald-500 transition-all duration-500"),"Discharging"===e.batteryStatus?Ve("battery-status-text",'<span class="text-orange-500">ƒêang x·∫£</span>'):"Charging"===e.batteryStatus?Ve("battery-status-text",'<span class="text-emerald-500">ƒêang s·∫°c</span>'):Ve("battery-status-text",'<span class="text-emerald-400">Ch·ªù</span>'),"Discharging"===e.batteryStatus?Ve("battery-power",`<span class="text-red-600 dark:text-red-400">-${Math.abs(e.batteryValue)}W</span>`):Ve("battery-power",`<span class="text-green-600 dark:text-green-400">+${Math.abs(e.batteryValue)}W</span>`),e.batteryVoltage){const t=`${e.batteryVoltage.toFixed(1)}V`;Me("batteryVoltageDisplay",t),Me("battery-voltage-pro",t),Me("battery-voltage-basic",t),Me("battery-voltage-3d",t)}const d=e.batteryCurrent||0,c=e.batteryValue||0;let g;g=c>0?`+${Math.abs(d).toFixed(1)}A`:c<0?`-${Math.abs(d).toFixed(1)}A`:`${Math.abs(d).toFixed(1)}A`,Me("battery-current-pro",g),Me("battery-current-basic",g),Me("battery-current-3d",g),Me("device-temp",`${e.deviceTempValue}¬∞C`),Me("device-temp-info",`${e.deviceTempValue}¬∞C`),Me("essential-power",`${e.essentialValue}W`),Me("load-power",`${e.loadValue}W`),void 0!==e.inverterAcOutPower&&Me("acout-power",`${e.inverterAcOutPower}W`),He("pv-flow",e.pvTotalPower>0),He("grid-flow",e.gridValue>0),He("battery-flow",0!==e.batteryValue),He("essential-flow",e.essentialValue>0),He("load-flow",e.loadValue>0),function(e){const t=(e,t,a=[1e3,2e3,3e3])=>{const n=[document.getElementById(e),document.getElementById(e+"-2"),document.getElementById(e+"-3")];let o=0;t>0&&(o=m?1:t>=a[2]?3:t>=a[1]?2:1),n.forEach((e,t)=>{e&&(e.style.display=t<o?"block":"none")})},a=(e,t)=>{const a=[document.getElementById(e),document.getElementById(e+"-2"),document.getElementById(e+"-3"),document.getElementById(e+"-4"),document.getElementById(e+"-5")];let n=0;t>0&&(n=m?1:t>=3e3?5:3),a.forEach((e,t)=>{e&&(e.style.display=t<n?"block":"none")})},n=e=>{[document.getElementById("battery-flow-dot"),document.getElementById("battery-flow-dot-2"),document.getElementById("battery-flow-dot-3")].forEach(t=>{t&&(t.classList.remove("charging","discharging"),e&&t.classList.add(e))})};a("pv-flow-dot",e.pvTotalPower),a("evn-flow-dot",e.gridValue>20?e.gridValue:0);const o=Math.abs(e.batteryValue);"Charging"===e.batteryStatus&&e.batteryValue>0?(t("battery-flow-dot",o),n("charging")):"Discharging"===e.batteryStatus&&o>0?(t("battery-flow-dot",o),n("discharging")):(t("battery-flow-dot",0),n(null));t("essential-flow-dot",e.essentialValue),t("load-flow-dot",e.loadValue)}(e),console.log("üîÑ Syncing views - Basic:",typeof window.autoSyncBasicView,"3D:",typeof window.autoSync3DHomeView),"function"==typeof window.autoSyncBasicView&&window.autoSyncBasicView(),"function"==typeof window.autoSync3DHomeView&&window.autoSync3DHomeView();const u=new Date;Me("lastUpdateTime",`C·∫≠p nh·∫≠t: ${`${String(u.getHours()).padStart(2,"0")}:${String(u.getMinutes()).padStart(2,"0")}:${String(u.getSeconds()).padStart(2,"0")}`}`)}async function fe(e){const t=Date.now();if(t-lastCellsFetch<5e3)console.log("üîã Cells fetch throttled, skipping...");else{lastCellsFetch=t;try{const t=`${LIGHTEARTH_PROXY_API}/api/realtime/device/${e}`;console.log("üîã Fetching cells from proxy:",t);const a=await fetch(t);if(!a.ok)throw new Error(`HTTP ${a.status}`);const n=await a.json(),o=n.deviceData?.battery?.cells;if(o&&o.cells){console.log("‚úÖ [Proxy] Got cells data:",o);const e=Object.keys(o.cells).sort((e,t)=>parseInt(e.replace(/\D/g,""))-parseInt(t.replace(/\D/g,""))),t=[];if(e.forEach(e=>{t.push(o.cells[e])}),t.length>0){const e=t.filter(e=>e>0);we({cells:t,maximumVoltage:o.max||Math.max(...e,0),minimumVoltage:o.min||Math.min(...e.filter(e=>e>0),0),averageVoltage:o.avg||(e.length>0?e.reduce((e,t)=>e+t,0)/e.length:0),numberOfCells:t.length}),console.log(`‚úÖ [Proxy] Cell voltages updated: ${t.length} cells`)}}else console.warn("‚ö†Ô∏è [Proxy] No cells data in response")}catch(e){console.warn("‚ö†Ô∏è [Proxy] Cells fetch failed:",e.message)}}}function be(){const e=document.getElementById("cellDayMax"),t=document.getElementById("cellAvg"),a=document.getElementById("cellMax"),n=document.getElementById("cellMin"),o=document.getElementById("cellDiffValue"),l=document.getElementById("cellCountBadge"),r=document.getElementById("cellUpdateTime");e&&(e.textContent="--"),t&&(t.textContent="--"),a&&(a.textContent="--"),n&&(n.textContent="--"),o&&(o.textContent="--",o.className="text-sm sm:text-lg font-black text-slate-500"),l&&(l.textContent="-- cell"),r&&(r.textContent="--:--:--"),previousValues.cellDayMax_value="0";const s=document.getElementById("cellGrid");s&&(s.innerHTML='\n                <div class="cell-placeholder bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 flex flex-col items-center justify-center gap-3 border-2 border-dashed border-slate-300 dark:border-slate-600">\n                    <div class="animate-pulse flex items-center gap-2">\n                        <svg class="w-5 h-5 text-teal-500 animate-spin" fill="none" viewBox="0 0 24 24">\n                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n                        </svg>\n                        <span class="text-slate-500 dark:text-slate-400 text-sm font-medium">ƒêang ch·ªù d·ªØ li·ªáu cell volt...</span>\n                    </div>\n                    <p class="text-xs text-slate-400 dark:text-slate-500 text-center">D·ªØ li·ªáu s·∫Ω hi·ªÉn th·ªã khi nh·∫≠n ƒë∆∞·ª£c t·ª´ h·ªá th·ªëng</p>\n                </div>\n            ');const i=document.getElementById("cellSectionContent"),d=document.getElementById("toggleIcon"),c=document.getElementById("toggleText");i&&!i.classList.contains("hidden")&&(i.classList.add("hidden"),d&&(d.style.transform="rotate(180deg)"),c&&(c.textContent="Hi·ªán")),console.log("Battery cell section initialized - waiting for real system data")}function we(e){if(!e||!e.cells)return;const t=e.cells,a=t.filter(e=>e>0);if(0===a.length)return console.log("No valid cell data - device may not support cell monitoring"),void function(){const e=document.getElementById("cellGrid");e&&(e.innerHTML='\n                <div class="cell-placeholder bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-xl p-6 flex flex-col items-center justify-center gap-3 border-2 border-dashed border-amber-300 dark:border-amber-700">\n                    <div class="flex items-center gap-2">\n                        <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>\n                        </svg>\n                        <span class="text-amber-600 dark:text-amber-400 text-sm font-medium">Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ gi√°m s√°t cell</span>\n                    </div>\n                    <p class="text-xs text-amber-500 dark:text-amber-500 text-center">Pin c·ªßa thi·∫øt b·ªã n√†y kh√¥ng c√≥ t√≠nh nƒÉng giao ti·∫øp cell voltage</p>\n                </div>\n            ');const t=document.getElementById("cellCountBadge");t&&(t.textContent="N/A");const a=document.getElementById("cellSectionContent"),n=document.getElementById("toggleIcon"),o=document.getElementById("toggleText");a&&!a.classList.contains("hidden")&&(a.classList.add("hidden"),n&&(n.style.transform="rotate(180deg)"),o&&(o.textContent="Hi·ªán"))}();E=!0,k=!0,console.log("Received real cell data from system:",a.length,"cells");const n=document.getElementById("cellSectionContent"),o=document.getElementById("toggleIcon"),l=document.getElementById("toggleText");n&&n.classList.contains("hidden")&&(n.classList.remove("hidden"),o&&(o.style.transform="rotate(0deg)"),l&&(l.textContent="·∫®n")),function(){const e=new Date,t=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}`,a=document.getElementById("cellUpdateTime");a&&(a.textContent=t)}();const r=a.reduce((e,t)=>e+t,0)/a.length,s=Math.max(...a),i=Math.min(...a),d=s-i,c=document.getElementById("cellCountBadge");if(c&&(c.textContent=`${a.length} cell`),Me("cellAvg",r.toFixed(3)+"V"),Me("cellMax",s.toFixed(3)+"V"),Me("cellMin",i.toFixed(3)+"V"),Me("cellDiffValue",d.toFixed(3)+"V"),e.maximumVoltage)Me("cellDayMax",e.maximumVoltage.toFixed(3)+"V");else{const e=parseFloat(previousValues.cellDayMax_value||"0");s>e&&(previousValues.cellDayMax_value=s.toString(),Me("cellDayMax",s.toFixed(3)+"V"))}const g=document.getElementById("cellDiffValue");g&&(g.className="text-sm sm:text-lg font-black",d>.05?g.classList.add("text-red-600","dark:text-red-400"):d>.02?g.classList.add("text-amber-600","dark:text-amber-400"):g.classList.add("text-green-600","dark:text-green-400"));const m=Date.now();C=m;let u=-1,p=-1;t.forEach((e,t)=>{e&&e>0&&(e===s&&(u=t),e===i&&(p=t))});const h=document.getElementById("cellGrid");if(h){let e='<div class="grid">';t.forEach((t,a)=>{const n=`cell_${a}`,o=I[n],l=void 0!==o&&o!==t;I[n]=t;if(0===t||null==t)e+=`\n                        <div class="cell-item cell-no-communication relative">\n                            <span class="cell-label">Cell ${a+1}</span>\n                            <span class="cell-voltage">N/A</span>\n                            <span class="text-[8px] text-red-400 block">M·∫•t k·∫øt n·ªëi</span>\n                        </div>\n                    `;else{const n=Math.abs(t-r);let o="cell-default";o=n<.02?"cell-good":n<.05?"cell-ok":"cell-warning";const s=l?"cell-blink":"",i=a===u,d=a===p,c=i?"cell-max-highlight":d?"cell-min-highlight":"";let g="";i?g='<span class="cell-badge cell-badge-max">‚ñ≤ MAX</span>':d&&(g='<span class="cell-badge cell-badge-min">‚ñº MIN</span>');const m=2.5;let h=(t-m)/(3.65-m)*100;h=Math.max(0,Math.min(100,h));let y="bar-premium";t<3?y="bar-critical":t<3.1?y="bar-low":t<3.2?y="bar-medium":t<3.35&&(y="bar-full"),e+=`\n                        <div class="cell-item ${o} ${s} ${c}">\n                            ${g}\n                            <span class="cell-label">Cell ${a+1}</span>\n                            <span class="cell-voltage">${t.toFixed(3)}V</span>\n                            <div class="cell-voltage-bar">\n                                <div class="cell-voltage-bar-fill ${y}" style="width: ${h.toFixed(1)}%"></div>\n                            </div>\n                        </div>\n                    `}}),e+="</div>";const n=a.length===t.length?'<span class="text-green-500">‚úì T·∫•t c·∫£ cell ƒëang giao ti·∫øp</span>':`<span class="text-amber-500">‚ö† ${t.length-a.length} cell m·∫•t k·∫øt n·ªëi</span>`;e+=`<div class="text-center mt-2 text-xs">${n}</div>`,h.innerHTML=e}}function xe(e){Ie(Le(),{pv:$e(e.pv.tableValueInfo),batCharge:Se(e.bat.tableValueInfo),batDischarge:Te(e.bat.tableValueInfo),load:$e(e.load.tableValueInfo),grid:$e(e.grid.tableValueInfo),essentialLoad:$e(e.essentialLoad.tableValueInfo)});const t=document.getElementById("energy-chart-date"),a=document.getElementById("dateInput");t&&a&&(t.textContent=a.value),console.log("üìä Peak stats updated (chart disabled)")}function Ie(e,t){const a=e=>{if(!e||0===e.length)return{peak:0,index:-1};let t=0,a=-1;for(let n=0;n<e.length;n++){const o=e[n];null!=o&&o>t&&(t=o,a=n)}return{peak:t,index:a}},n=t=>t<0||!e||t>=e.length?"--:--":e[t]||"--:--",o=e=>0===e?"0 W":`${Math.round(e)} W`,l=a(t.pv),r=a(t.batCharge),s=a(t.batDischarge),i=a(t.load),d=a(t.grid),c=a(t.essentialLoad),g=(e,t)=>{const a=document.getElementById(e);a&&(a.textContent=t)};g("chart-pv-peak",o(l.peak)),g("chart-pv-time",n(l.index)),g("chart-charge-peak",o(r.peak)),g("chart-charge-time",n(r.index)),g("chart-discharge-peak",o(s.peak)),g("chart-discharge-time",n(s.index)),g("chart-load-peak",o(i.peak)),g("chart-load-time",n(i.index)),g("chart-grid-peak",o(d.peak)),g("chart-grid-time",n(d.index)),g("chart-essential-peak",o(c.peak)),g("chart-essential-time",n(c.index)),console.log("üìä Peak stats updated:",{pv:`${o(l.peak)} @ ${n(l.index)}`,charge:`${o(r.peak)} @ ${n(r.index)}`,discharge:`${o(s.peak)} @ ${n(s.index)}`,load:`${o(i.peak)} @ ${n(i.index)}`,grid:`${o(d.peak)} @ ${n(d.index)}`,essential:`${o(c.peak)} @ ${n(c.index)}`})}function Ce(e){const t=document.getElementById("load-card-3d");if(!t)return;t.classList.remove("heat-level-0","heat-level-1","heat-level-2","heat-level-3","heat-level-4");let a=0;e>=4e3?a=4:e>=3e3?a=3:e>=2e3?a=2:e>=1e3&&(a=1),t.classList.add(`heat-level-${a}`);const n=document.getElementById("load-voltage-3d"),o=document.getElementById("load-label-3d"),l=n?.parentElement,r={0:{text:"text-amber-600 dark:text-amber-400",border:"border-amber-400/40 dark:border-amber-400/20",bg:"bg-amber-100/60 dark:bg-black/20"},1:{text:"text-amber-600 dark:text-amber-400",border:"border-amber-400/50 dark:border-amber-400/20",bg:"bg-amber-100/70 dark:bg-black/20"},2:{text:"text-orange-600 dark:text-orange-400",border:"border-orange-400/50 dark:border-orange-400/20",bg:"bg-orange-100/60 dark:bg-black/20"},3:{text:"text-orange-600 dark:text-orange-400",border:"border-orange-400/60 dark:border-orange-400/20",bg:"bg-orange-100/70 dark:bg-black/20"},4:{text:"text-red-600 dark:text-red-400",border:"border-red-400/60 dark:border-red-400/20",bg:"bg-red-100/70 dark:bg-black/20"}}[a];n&&(n.className=n.className.replace(/text-\w+-\d+/g,"").replace(/dark:text-\w+-\d+/g,"").trim()+" "+r.text),o&&(o.className=o.className.replace(/text-\w+-\d+/g,"").replace(/dark:text-\w+-\d+/g,"").trim()+" "+r.text),l&&(l.className=l.className.replace(/border-\w+-\d+\/\d+/g,"").replace(/dark:border-\w+-\d+\/\d+/g,"").replace(/bg-\w+-\d+\/\d+/g,"").trim()+" "+r.border+" "+r.bg)}function ke(e){const t=document.getElementById("essential-card-3d");if(!t)return;t.classList.remove("essential-level-0","essential-level-1","essential-level-2","essential-level-3","essential-level-4");let a=0;e>=4e3?a=4:e>=3e3?a=3:e>=2e3?a=2:e>=1e3&&(a=1),t.classList.add(`essential-level-${a}`)}function Ee(e,t){const a=document.getElementById("battery-card-3d");if(!a)return;["battery-charging-0","battery-charging-1","battery-charging-2","battery-charging-3","battery-discharging-0","battery-discharging-1","battery-discharging-2","battery-discharging-3","battery-idle"].forEach(e=>a.classList.remove(e));const n=Math.abs(e);let o=0;o=n>=3e3?3:n>=2e3?2:n>=1e3?1:0;let l="idle";if(t){const e=t.toLowerCase();e.includes("charg")&&!e.includes("discharg")?l="charging":e.includes("discharg")&&(l="discharging")}else 0!==e&&(l=e<0?"charging":"discharging");if("idle"===l||n<10)a.classList.add("battery-idle"),console.log(`üîã Battery Idle: ${e}W`);else{a.classList.add(`battery-${l}-${o}`);const e="charging"===l?"üîå":"‚ö°",t="charging"===l?"GREEN":"RED";console.log(`${e} Battery ${l}: ${n}W ‚Üí Level ${o} (${t})`)}}window.toggleDataset=function(e){if(!r)return;const t=r.getDatasetMeta(e);t.hidden=!t.hidden,r.update();const a=document.querySelectorAll("#chartLegendToggle .legend-btn");a[e]&&a[e].classList.toggle("active",!t.hidden)},window.autoSync3DHomeView=function(){const e=document.getElementById("pv-power")?.textContent||"--W",t=document.getElementById("grid-power")?.textContent||"--W",a=document.getElementById("battery-percent-icon")?.textContent||"--%",n=document.getElementById("battery-power")?.textContent||"--W",o=document.getElementById("load-power")?.textContent||"--W",l=document.getElementById("essential-power")?.textContent||"--W";let r="--W",s="--W",i="--V",d="--V";latestRealtimeData.pv1Power&&(r=latestRealtimeData.pv1Power+"W",i=(latestRealtimeData.pv1Voltage||0)+"V"),latestRealtimeData.pv2Power&&(s=latestRealtimeData.pv2Power+"W",d=(latestRealtimeData.pv2Voltage||0)+"V");const c=(e,t)=>{const a=document.getElementById(e);if(a){a.textContent!==t&&(a.textContent=t,a.classList.remove("value-updated"),a.offsetWidth,a.classList.add("value-updated"),setTimeout(()=>a.classList.remove("value-updated"),600))}};c("pv-power-3d",e),c("pv1-power-3d",r),c("pv2-power-3d",s),c("pv1-voltage-3d",i),c("pv2-voltage-3d",d),c("grid-power-3d",t),c("load-power-3d",o),c("battery-soc-3d",a);let g="--V";if(latestRealtimeData.gridVoltageValue)g=latestRealtimeData.gridVoltageValue+"V";else{const e=document.getElementById("grid-voltage");e&&(g=e.textContent||"--V")}c("load-voltage-3d",g);const m=document.getElementById("battery-soc-3d");if(m){const e=parseInt(a.replace(/[^\d]/g,""))||0;m.classList.remove("text-red-500","text-yellow-500","text-emerald-400","text-white"),e<=20?m.classList.add("text-red-500"):e<=50?m.classList.add("text-yellow-500"):m.classList.add("text-emerald-400")}c("essential-power-3d",l),Ce(parseInt(o.replace(/[^\d]/g,""))||0),ke(parseInt(l.replace(/[^\d]/g,""))||0);const u=parseInt(n.replace(/[^\d-]/g,""))||0,p=parseInt(a.replace(/[^\d]/g,""))||0,h=document.getElementById("battery-power-3d"),y=document.getElementById("battery-fill-3d"),v=document.getElementById("battery-percent-3d-icon"),f=document.getElementById("battery-body-3d"),b=document.getElementById("battery-cap-3d"),w=document.getElementById("battery-status-label-3d");if(h){let e;u>10?(e="+"+Math.abs(u)+"W",w&&(w.textContent="Pin ƒëang s·∫°c")):u<-10?(e="-"+Math.abs(u)+"W",w&&(w.textContent="Pin ƒëang x·∫£")):(e="0W",w&&(w.textContent="Pin ch·ªù")),h.textContent!==e&&(h.textContent=e,h.classList.remove("value-updated"),h.offsetWidth,h.classList.add("value-updated"),setTimeout(()=>h.classList.remove("value-updated"),600))}let x="border-emerald-400",I="bg-emerald-400";if(p<=20?(x="border-red-400",I="bg-red-400"):p<=50&&(x="border-yellow-400",I="bg-yellow-400"),f&&(f.className=`battery-body-3d w-16 h-7 sm:w-20 sm:h-8 rounded-[5px] border-2 ${x} relative overflow-hidden bg-slate-900/80 transition-all duration-300`),b&&(b.className=`absolute -right-1.5 top-1/2 -translate-y-1/2 w-1.5 h-4 sm:h-5 ${I} rounded-r-sm transition-all duration-300`),y){y.style.width=Math.max(p-3,0)+"%";let e="bg-emerald-500";p<=20?e="bg-red-500":p<=50&&(e="bg-yellow-500"),y.className=`battery-fill-3d absolute left-0.5 top-0.5 bottom-0.5 rounded-[3px] ${e} transition-all duration-500`}v&&(v.textContent=a),Ee(u,u>10?"Charging":u<-10?"Discharging":"Idle"),c("grid-voltage-3d",document.getElementById("grid-voltage")?.textContent||"--V");const C=parseInt(e.replace(/[^\d-]/g,""))||0,k=document.getElementById("sun-3d"),E=document.getElementById("moon-3d");if(k&&E)if(C>0){k.classList.remove("hidden"),E.classList.add("hidden");const e=k.querySelector(".sun-3d-container");e&&(e.classList.remove("sun-level-1","sun-level-2","sun-level-3","sun-level-4"),C>=4e3?e.classList.add("sun-level-4"):C>=2e3?e.classList.add("sun-level-3"):C>=1e3?e.classList.add("sun-level-2"):e.classList.add("sun-level-1"))}else k.classList.add("hidden"),E.classList.remove("hidden");const B=document.getElementById("pv-energy-line");B&&(C>0?B.classList.remove("hidden-flow"):B.classList.add("hidden-flow"));const L=parseInt(t.replace(/[^\d-]/g,""))||0,$=document.getElementById("evn-energy-line");$&&($.classList.remove("hidden-flow","flow-level-1","flow-level-2","flow-level-3"),L>0?L>1e3?$.classList.add("flow-level-3"):L>20?$.classList.add("flow-level-2"):$.classList.add("flow-level-1"):$.classList.add("hidden-flow"));const S=parseInt(n.replace(/[^\d-]/g,""))||0,T=document.getElementById("battery-charging-3d"),D=document.getElementById("battery-discharging-3d"),P=document.getElementById("battery-status-icon-3d");P&&(S>10?(P.classList.remove("hidden"),T?.classList.remove("hidden"),D?.classList.add("hidden")):S<-10?(P.classList.remove("hidden"),T?.classList.add("hidden"),D?.classList.remove("hidden")):P.classList.add("hidden"))},console.log("‚úÖ window.autoSync3DHomeView exposed"),window.autoSyncBasicView=function(){const e=document.getElementById("pv-power")?.textContent||"--",t=document.getElementById("pv-desc")?.innerHTML||"--",a=document.getElementById("grid-power")?.textContent||"--",n=document.getElementById("grid-voltage")?.textContent||"--",o=document.getElementById("battery-percent-icon")?.textContent||"--%",l=document.getElementById("battery-power")?.textContent||"--",r=document.getElementById("essential-power")?.textContent||"--",s=document.getElementById("load-power")?.textContent||"--",i=document.getElementById("device-temp")?.textContent||"--",d=document.getElementById("inverter-type")?.textContent||"--";let c="--";const g=parseInt(l.replace(/[^\d-]/g,""))||0;c=g<0?"ƒêang x·∫£":g>0?"ƒêang n·∫°p":"Ch·ªù";const m=(e,t)=>{const a=document.getElementById(e);a&&(a.textContent=t)};m("pv-power-basic",e),((e,t)=>{const a=document.getElementById(e);a&&(a.innerHTML=t)})("pv-desc-basic",t),m("grid-power-basic",a),m("grid-voltage-basic",n),m("battery-percent-basic",o),m("battery-power-basic",l),m("battery-status-basic",c),m("essential-power-basic",r),m("load-power-basic",s),m("device-temp-basic",i),m("inverter-type-basic",d);const u=document.getElementById("battery-fill-basic");if(u){const e=parseInt(o)||0;u.style.width=e+"%",u.className=e>60?"absolute left-0 top-0 bottom-0 bg-green-500 transition-all duration-500":e>30?"absolute left-0 top-0 bottom-0 bg-yellow-500 transition-all duration-500":"absolute left-0 top-0 bottom-0 bg-red-500 transition-all duration-500"}const p=document.getElementById("battery-power-basic"),h=document.getElementById("battery-status-basic");p&&(p.classList.remove("text-slate-700","dark:text-slate-300","text-emerald-500","dark:text-emerald-400","text-orange-500","dark:text-orange-400","text-red-500","dark:text-red-400"),g>0?p.classList.add("text-emerald-500","dark:text-emerald-400"):g<0?p.classList.add("text-orange-500","dark:text-orange-400"):p.classList.add("text-slate-700","dark:text-slate-300")),h&&(h.classList.remove("text-slate-500","dark:text-slate-400","text-emerald-500","dark:text-emerald-400","text-orange-500","dark:text-orange-400"),g>0?h.classList.add("text-emerald-500","dark:text-emerald-400"):g<0?h.classList.add("text-orange-500","dark:text-orange-400"):h.classList.add("text-slate-500","dark:text-slate-400"))},console.log("‚úÖ window.autoSyncBasicView exposed"),window.updateLoadHeatEffect=Ce,window.updateEssentialHeatEffect=ke,window.updateBatteryHeatEffect=Ee;const Be=localStorage.getItem("energyFlowView")||"pro";function Le(){const e=[];for(let t=0;t<24;t++)for(let a=0;a<60;a+=5)e.push(`${String(t).padStart(2,"0")}:${String(a).padStart(2,"0")}`);return e}function $e(e){return e?[...e]:[]}function Se(e){return e?e.map(e=>null===e?null:e>0?e:0):[]}function Te(e){return e?e.map(e=>null===e?null:e<0?Math.abs(e):0):[]}function De(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function Pe(e){const t=document.getElementById("dateInput");if(!t)return;let a=new Date(t.value);a.setDate(a.getDate()+e),t.value=De(a);const n=document.getElementById("compactDateDisplay");if(n){const e=`${String(a.getDate()).padStart(2,"0")}/${String(a.getMonth()+1).padStart(2,"0")}/${a.getFullYear()}`;n.textContent=e,K(e)}window.skipDeviceNotification=!0,q()}function Ae(e){const t=document.getElementById(e);t&&t.classList.remove("hidden")}function Me(e,t){const a=document.getElementById(e);if(a){const n=previousValues[e],o=String(t);n!==o&&(a.textContent=t,a.classList.remove("value-updated"),a.offsetWidth,a.classList.add("value-updated"),previousValues[e]=o,setTimeout(()=>a.classList.remove("value-updated"),600))}}function Ve(e,t){const a=document.getElementById(e);if(a){const n=previousValues[e+"_html"],o=String(t);n!==o&&(a.innerHTML=t,a.classList.remove("value-updated"),a.offsetWidth,a.classList.add("value-updated"),previousValues[e+"_html"]=o,setTimeout(()=>a.classList.remove("value-updated"),600))}}function He(e,t){const a=document.getElementById(e);a&&(t?(a.classList.remove("inactive"),a.classList.add("active")):(a.classList.add("inactive"),a.classList.remove("active")))}function Re(){const e=document.getElementById("toggleAnimationBtn"),t=document.getElementById("animationBtnText"),a=document.getElementById("animationIcon");e&&t&&a&&(m?(e.classList.remove("bg-slate-100","hover:bg-slate-200","dark:bg-slate-700","dark:hover:bg-slate-600","text-slate-600","dark:text-slate-300","border-slate-300","dark:border-slate-600"),e.classList.add("bg-amber-100","hover:bg-amber-200","dark:bg-amber-900/50","dark:hover:bg-amber-800/50","text-amber-700","dark:text-amber-300","border-amber-400","dark:border-amber-600"),t.textContent="TƒÉng hi·ªáu ·ª©ng",a.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>'):(e.classList.remove("bg-amber-100","hover:bg-amber-200","dark:bg-amber-900/50","dark:hover:bg-amber-800/50","text-amber-700","dark:text-amber-300","border-amber-400","dark:border-amber-600"),e.classList.add("bg-slate-100","hover:bg-slate-200","dark:bg-slate-700","dark:hover:bg-slate-600","text-slate-600","dark:text-slate-300","border-slate-300","dark:border-slate-600"),t.textContent="Gi·∫£m hi·ªáu ·ª©ng",a.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>'))}function Ne(e){const t=document.getElementById("loading");t&&t.classList.toggle("hidden",!e)}function We(e){const t=document.getElementById("errorMessage"),a=document.getElementById("errorText");t&&a&&(a.innerHTML=e.replace(/\n/g,"<br>"),t.classList.remove("hidden"),t.scrollIntoView({behavior:"smooth",block:"center"}))}setTimeout(()=>{window.switchEnergyFlowView(Be)},100),setTimeout(()=>{const e=document.getElementById("proViewBtn"),t=document.getElementById("basicViewBtn"),a=document.getElementById("home3DViewBtn");e&&e.addEventListener("click",e=>{e.preventDefault(),window.switchEnergyFlowView("pro")}),t&&t.addEventListener("click",e=>{e.preventDefault(),window.switchEnergyFlowView("basic")}),a&&a.addEventListener("click",e=>{e.preventDefault(),window.switchEnergyFlowView("3dhome")}),console.log("Energy flow view buttons initialized")},200),window.toggleAnimationMode=function(){m=!m,localStorage.setItem("energyFlowAnimationMode",m?"reduced":"normal"),Re(),console.log("Animation mode:",m?"REDUCED (1 particle)":"NORMAL (multiple particles)")},Re();const Fe={"TP. H·ªì Ch√≠ Minh":{lat:10.8231,lon:106.6297,region:"Mi·ªÅn Nam"},"B√† R·ªãa - V≈©ng T√†u":{lat:10.4114,lon:107.1362,region:"Mi·ªÅn Nam"},"B√¨nh D∆∞∆°ng":{lat:11.0753,lon:106.6189,region:"Mi·ªÅn Nam"},"B√¨nh Ph∆∞·ªõc":{lat:11.7512,lon:106.7235,region:"Mi·ªÅn Nam"},"ƒê·ªìng Nai":{lat:10.9574,lon:106.8426,region:"Mi·ªÅn Nam"},"T√¢y Ninh":{lat:11.3555,lon:106.1099,region:"Mi·ªÅn Nam"},"Long An":{lat:10.6956,lon:106.2431,region:"Mi·ªÅn Nam"},"Ti·ªÅn Giang":{lat:10.4493,lon:106.342,region:"Mi·ªÅn Nam"},"B·∫øn Tre":{lat:10.2433,lon:106.3752,region:"Mi·ªÅn Nam"},"Vƒ©nh Long":{lat:10.2537,lon:105.9722,region:"Mi·ªÅn Nam"},"Tr√† Vinh":{lat:9.8127,lon:106.2993,region:"Mi·ªÅn Nam"},"ƒê·ªìng Th√°p":{lat:10.4937,lon:105.6882,region:"Mi·ªÅn Nam"},"An Giang":{lat:10.5216,lon:105.1259,region:"Mi·ªÅn Nam"},"Ki√™n Giang":{lat:10.0125,lon:105.0809,region:"Mi·ªÅn Nam"},"C·∫ßn Th∆°":{lat:10.0452,lon:105.7469,region:"Mi·ªÅn Nam"},"H·∫≠u Giang":{lat:9.7579,lon:105.6413,region:"Mi·ªÅn Nam"},"S√≥c TrƒÉng":{lat:9.6037,lon:105.98,region:"Mi·ªÅn Nam"},"B·∫°c Li√™u":{lat:9.294,lon:105.7216,region:"Mi·ªÅn Nam"},"C√† Mau":{lat:9.1769,lon:105.1524,region:"Mi·ªÅn Nam"},"ƒê√† N·∫µng":{lat:16.0544,lon:108.2022,region:"Mi·ªÅn Trung"},"Th·ª´a Thi√™n Hu·∫ø":{lat:16.4637,lon:107.5909,region:"Mi·ªÅn Trung"},"Qu·∫£ng Nam":{lat:15.5394,lon:108.0191,region:"Mi·ªÅn Trung"},"Qu·∫£ng Ng√£i":{lat:15.1214,lon:108.8044,region:"Mi·ªÅn Trung"},"B√¨nh ƒê·ªãnh":{lat:13.7765,lon:109.2237,region:"Mi·ªÅn Trung"},"Ph√∫ Y√™n":{lat:13.0882,lon:109.0929,region:"Mi·ªÅn Trung"},"Kh√°nh H√≤a":{lat:12.2388,lon:109.1967,region:"Mi·ªÅn Trung"},"Ninh Thu·∫≠n":{lat:11.5752,lon:108.989,region:"Mi·ªÅn Trung"},"B√¨nh Thu·∫≠n":{lat:10.9289,lon:108.1021,region:"Mi·ªÅn Trung"},"Qu·∫£ng B√¨nh":{lat:17.4656,lon:106.6222,region:"Mi·ªÅn Trung"},"Qu·∫£ng Tr·ªã":{lat:16.7504,lon:107.1856,region:"Mi·ªÅn Trung"},"H√† Tƒ©nh":{lat:18.3559,lon:105.8877,region:"Mi·ªÅn Trung"},"Ngh·ªá An":{lat:18.6737,lon:105.6922,region:"Mi·ªÅn Trung"},"Thanh H√≥a":{lat:19.8067,lon:105.7852,region:"Mi·ªÅn Trung"},"Kon Tum":{lat:14.3545,lon:108.0005,region:"T√¢y Nguy√™n"},"Gia Lai":{lat:13.9833,lon:108,region:"T√¢y Nguy√™n"},"ƒê·∫Øk L·∫Øk":{lat:12.68,lon:108.0378,region:"T√¢y Nguy√™n"},"ƒê·∫Øk N√¥ng":{lat:12.0033,lon:107.6876,region:"T√¢y Nguy√™n"},"L√¢m ƒê·ªìng":{lat:11.9404,lon:108.4583,region:"T√¢y Nguy√™n"},"H√† N·ªôi":{lat:21.0285,lon:105.8542,region:"Mi·ªÅn B·∫Øc"},"H·∫£i Ph√≤ng":{lat:20.8449,lon:106.6881,region:"Mi·ªÅn B·∫Øc"},"Qu·∫£ng Ninh":{lat:21.0064,lon:107.2925,region:"Mi·ªÅn B·∫Øc"},"B·∫Øc Giang":{lat:21.2819,lon:106.1975,region:"Mi·ªÅn B·∫Øc"},"B·∫Øc Ninh":{lat:21.1861,lon:106.0763,region:"Mi·ªÅn B·∫Øc"},"H·∫£i D∆∞∆°ng":{lat:20.9373,lon:106.3146,region:"Mi·ªÅn B·∫Øc"},"H∆∞ng Y√™n":{lat:20.6464,lon:106.0511,region:"Mi·ªÅn B·∫Øc"},"Th√°i B√¨nh":{lat:20.4463,lon:106.3365,region:"Mi·ªÅn B·∫Øc"},"Nam ƒê·ªãnh":{lat:20.4388,lon:106.1621,region:"Mi·ªÅn B·∫Øc"},"Ninh B√¨nh":{lat:20.2506,lon:105.9745,region:"Mi·ªÅn B·∫Øc"},"H√† Nam":{lat:20.5835,lon:105.923,region:"Mi·ªÅn B·∫Øc"},"Vƒ©nh Ph√∫c":{lat:21.3609,lon:105.5474,region:"Mi·ªÅn B·∫Øc"},"Ph√∫ Th·ªç":{lat:21.3227,lon:105.228,region:"Mi·ªÅn B·∫Øc"},"Th√°i Nguy√™n":{lat:21.5942,lon:105.8482,region:"Mi·ªÅn B·∫Øc"},"B·∫Øc K·∫°n":{lat:22.147,lon:105.8348,region:"Mi·ªÅn B·∫Øc"},"Cao B·∫±ng":{lat:22.6663,lon:106.2522,region:"Mi·ªÅn B·∫Øc"},"L·∫°ng S∆°n":{lat:21.8537,lon:106.7615,region:"Mi·ªÅn B·∫Øc"},"Tuy√™n Quang":{lat:21.8233,lon:105.218,region:"Mi·ªÅn B·∫Øc"},"H√† Giang":{lat:22.8333,lon:104.9833,region:"Mi·ªÅn B·∫Øc"},"Y√™n B√°i":{lat:21.7168,lon:104.8986,region:"Mi·ªÅn B·∫Øc"},"L√†o Cai":{lat:22.4856,lon:103.9707,region:"Mi·ªÅn B·∫Øc"},"Lai Ch√¢u":{lat:22.3864,lon:103.4703,region:"Mi·ªÅn B·∫Øc"},"ƒêi·ªán Bi√™n":{lat:21.386,lon:103.023,region:"Mi·ªÅn B·∫Øc"},"S∆°n La":{lat:21.3256,lon:103.9188,region:"Mi·ªÅn B·∫Øc"},"H√≤a B√¨nh":{lat:20.8171,lon:105.3376,region:"Mi·ªÅn B·∫Øc"}};let Oe="TP. H·ªì Ch√≠ Minh",_e=null;function Ue(e){return e<=0?{level:"none",text:"ƒê√™m",color:"#64748b",bg:"solar-level-none"}:e<200?{level:"low",text:"Y·∫øu",color:"#84cc16",bg:"solar-level-low"}:e<500?{level:"medium",text:"Trung b√¨nh",color:"#eab308",bg:"solar-level-medium"}:e<800?{level:"high",text:"M·∫°nh",color:"#f97316",bg:"solar-level-high"}:{level:"extreme",text:"R·∫•t m·∫°nh",color:"#ef4444",bg:"solar-level-extreme"}}function je(e,t){return e<=0?"üåô":t>80?"‚òÅÔ∏è":t>50?"‚õÖ":t>20?"üå§Ô∏è":"‚òÄÔ∏è"}async function ze(e="TP. H·ªì Ch√≠ Minh"){const t=Fe[e]||Fe["TP. H·ªì Ch√≠ Minh"];console.log("‚òÄÔ∏è Fetching solar forecast for:",e),Oe=e;try{const a=`https://api.open-meteo.com/v1/forecast?latitude=${t.lat}&longitude=${t.lon}&hourly=shortwave_radiation,temperature_2m,cloudcover,uv_index,precipitation_probability&daily=sunshine_duration&timezone=Asia/Ho_Chi_Minh&forecast_days=2`,n=await fetch(a);if(!n.ok)throw new Error("Failed to fetch solar data");const o=await n.json();_e=o,function(e){if(!e||!e.hourly)return;const t=e.hourly.time,a=e.hourly.shortwave_radiation,n=e.hourly.temperature_2m,o=e.hourly.cloudcover,l=e.hourly.uv_index||[],r=e.hourly.precipitation_probability||[],s=e.daily?.sunshine_duration||[],i=new Date,d=i.getHours(),c=i.toISOString().split("T")[0];let g=t.findIndex(e=>{const t=new Date(e);return t.toISOString().split("T")[0]===c&&t.getHours()===d});-1===g&&(g=0);const m=a[g]||0,u=n[g]||0,p=o[g]||0,h=l[g]||0,y=r[g]||0,v=Ue(m),f=(T=h,T<=0?{text:"--",color:"#64748b",bg:"bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300"}:T<3?{text:"Th·∫•p",color:"#22c55e",bg:"bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300"}:T<6?{text:"TB",color:"#eab308",bg:"bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300"}:T<8?{text:"Cao",color:"#f97316",bg:"bg-orange-100 dark:bg-orange-900/50 text-orange-700 dark:text-orange-300"}:T<11?{text:"R·∫•t cao",color:"#ef4444",bg:"bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300"}:{text:"C·ª±c ƒë·ªô",color:"#a855f7",bg:"bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300"}),b=s[0]?(s[0]/3600).toFixed(1):"--",w=document.getElementById("solar-current-value"),x=document.getElementById("solar-current-icon"),I=document.getElementById("solar-level-dot"),C=document.getElementById("solar-level-text"),k=document.getElementById("solar-temp"),E=document.getElementById("solar-cloud"),B=document.getElementById("solar-uv-value"),L=document.getElementById("solar-uv-badge"),$=document.getElementById("solar-sunshine-duration"),S=document.getElementById("solar-rain-prob");var T;w&&(w.textContent=`${Math.round(m)} W/m¬≤`);x&&(x.textContent=je(m,p));I&&(I.style.backgroundColor=v.color);C&&(C.textContent=v.text,C.style.color=v.color);k&&(k.textContent=`${Math.round(u)}¬∞C`);E&&(E.textContent=`${Math.round(p)}%`);B&&(B.textContent=h>0?h.toFixed(1):"--");L&&(L.textContent=f.text,L.className=`text-[9px] px-1 py-0.5 rounded ${f.bg}`);$&&($.textContent=`${b}h`);S&&(S.textContent=`${Math.round(y)}%`,S.className="text-xs font-semibold "+((D=y)<=20?"text-green-600 dark:text-green-400":D<=50?"text-yellow-600 dark:text-yellow-400":D<=70?"text-orange-600 dark:text-orange-400":"text-blue-600 dark:text-blue-400"));var D;const P=document.getElementById("solarHourlyScroll");if(!P)return;P.innerHTML="";const A=24;for(let e=g;e<Math.min(g+A,t.length);e++){const n=new Date(t[e]),s=a[e]||0,d=o[e]||0,c=l[e]||0,m=r[e]||0,u=Ue(s),p=je(s,d),h=n.getHours().toString().padStart(2,"0")+":00",y=e===g,v=(n.getDate(),i.getDate(),`${h}\nB·ª©c x·∫°: ${Math.round(s)} W/m¬≤\nUV: ${c.toFixed(1)}\nM√¢y: ${Math.round(d)}%\nM∆∞a: ${Math.round(m)}%`),f=document.createElement("div");f.className=`solar-hour-item ${u.bg} ${y?"current":""}`,f.title=v,f.innerHTML=`\n                <div class="solar-time ${"none"===u.level?"text-slate-400":"text-white/90"}">${h}</div>\n                <div class="solar-icon">${p}</div>\n                <div class="solar-value ${"none"===u.level?"text-slate-500":"text-white"}">${Math.round(s)}</div>\n                ${m>30?`<div class="solar-rain text-white/90">üåßÔ∏è${Math.round(m)}%</div>`:""}\n            `,P.appendChild(f)}P.firstChild&&(P.scrollLeft=0)}(o);const l=document.getElementById("solar-location");l&&(l.textContent=`üìç ${e}`);const r=document.getElementById("solar-update-time");if(r){const e=new Date;r.textContent=`C·∫≠p nh·∫≠t: ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`}}catch(e){console.error("Error fetching solar forecast:",e)}}const Ge=localStorage.getItem("solarForecastCity")||"TP. H·ªì Ch√≠ Minh";console.log("‚òÄÔ∏è Solar forecast init - city:",Ge);const Ye=document.getElementById("solar-city-select");Ye&&(Ye.value=Ge),ze(Ge),setInterval(()=>ze(Oe),18e5),window.changeSolarCity=function(e){Fe[e]&&(localStorage.setItem("solarForecastCity",e),ze(e))};new MutationObserver(()=>{O()}).observe(document.documentElement,{attributes:!0,attributeFilter:["class"]})});